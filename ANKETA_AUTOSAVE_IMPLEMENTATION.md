# Реализация автосохранения анкет в GrantService Telegram Bot

## Дата: 20.09.2025

## Выполненная работа

### 1. Анализ текущей системы
- Изучена логика завершения анкеты
- Определено, что анкета не сохранялась автоматически после 14 вопроса
- Выявлена необходимость добавления функции автосохранения

### 2. Реализованные изменения

#### 2.1 Автосохранение анкеты
**Файлы:** 
- `telegram-bot/main.py` (Linux версия)
- `telegram-bot/main_windows.py` (Windows версия)

**Добавлен метод:**
```python
async def auto_save_anketa(self, update: Update, context: ContextTypes.DEFAULT_TYPE, user_id: int) -> Optional[str]:
    """Автоматическое сохранение анкеты после 14 вопроса"""
```

**Логика:**
- После ответа на 14-й вопрос автоматически вызывается сохранение
- Генерируется уникальный ID анкеты в формате `#AN-YYYYMMDD-username-001`
- Данные сохраняются в базу данных
- Пользователю показывается экран завершения с ID анкеты

#### 2.2 Экран завершения
**Новый функционал:**
- Показ ID сохраненной анкеты
- Сообщение об успешном сохранении
- Кнопка "Начать новую анкету" для быстрого старта следующего опроса

```python
async def show_completion_screen(self, update: Update, context: ContextTypes.DEFAULT_TYPE, anketa_id: str):
    """Показать экран завершения с ID анкеты"""
```

### 3. Поддержка эмодзи в Windows

#### 3.1 Создана утилита для работы с эмодзи
**Файл:** `utils/console_helper.py`

**Функции:**
- `safe_print()` - безопасный вывод текста с автоматической заменой эмодзи
- `replace_emojis_in_file()` - замена эмодзи в файлах на текстовые маркеры
- `setup_console()` - настройка консоли для работы с Unicode

**Словарь замен:**
```python
EMOJI_REPLACEMENTS = {
    '✅': '[OK]',
    '❌': '[ERROR]',
    '⚠️': '[WARNING]',
    # и другие...
}
```

### 4. Обновление базы данных

#### 4.1 Добавлены новые колонки в таблицу sessions
- `total_questions` - общее количество вопросов
- `anketa_id` - уникальный ID анкеты
- `progress_percentage` - процент прохождения
- `questions_answered` - количество отвеченных вопросов
- `completion_status` - статус завершения

**Файл миграции:** `data/upgrade_database_windows.py`

### 5. Тестирование

#### 5.1 Создан тестовый скрипт
**Файл:** `test_anketa_autosave.py`

**Тесты:**
1. ✅ Генерация уникального ID анкеты
2. ✅ Сохранение анкеты в базу данных
3. ✅ Получение анкеты по ID
4. ✅ Создание множественных анкет для одного пользователя

**Результат:** Все тесты пройдены успешно

### 6. Двойная версия поддержки

#### 6.1 Windows версия
- `telegram-bot/main_windows.py`
- Использует пути Windows (C:\SnowWhiteAI\GrantService)
- Отдельный токен бота для Windows

#### 6.2 Ubuntu/Linux версия
- `telegram-bot/main.py`
- Использует пути Linux (/var/GrantService)
- Отдельный токен бота для Ubuntu

### 7. Структура ID анкеты

**Формат:** `#AN-YYYYMMDD-username-NNN`

**Компоненты:**
- `#AN` - префикс анкеты
- `YYYYMMDD` - дата создания
- `username` - имя пользователя или telegram_id
- `NNN` - порядковый номер анкеты за день (001, 002, ...)

**Примеры:**
- `#AN-20250920-otinoff-001`
- `#AN-20250920-test_user-003`

## Преимущества реализации

1. **Автоматическое сохранение** - данные не теряются после завершения
2. **Уникальные ID** - легко отслеживать и находить анкеты
3. **Множественные анкеты** - один пользователь может заполнить несколько анкет
4. **Кросс-платформенность** - работает на Windows и Linux
5. **Безопасный вывод** - корректная работа с эмодзи в Windows консоли

## Интеграция с системой

### Поток данных:
1. Пользователь заполняет анкету в Telegram
2. После 14 вопроса анкета автоматически сохраняется
3. Генерируется уникальный anketa_id
4. ID передается в webhook n8n вместе с данными
5. Агенты могут получить данные по anketa_id из БД

## Инструкция по запуску

### Windows:
```batch
cd C:\SnowWhiteAI\GrantService\telegram-bot
python main_windows.py
```

### Ubuntu/Linux:
```bash
cd /var/GrantService/telegram-bot
python3 main.py
```

## Возможные проблемы и решения

### Проблема: Ошибка с эмодзи в Windows консоли
**Решение:** Использовать `safe_print()` из `utils.console_helper`

### Проблема: База данных не содержит нужных колонок
**Решение:** Запустить скрипт миграции:
```bash
python data/upgrade_database_windows.py
```

### Проблема: Ошибка подключения к Telegram (getaddrinfo failed)
**Решение:** Проверить интернет-соединение и настройки прокси

## Дальнейшие улучшения

1. Добавить возможность редактирования сохраненной анкеты
2. Реализовать экспорт анкеты в PDF
3. Добавить статистику по анкетам
4. Создать веб-интерфейс для просмотра анкет
5. Добавить уведомления администратору о новых анкетах

## Файлы проекта

```
GrantService/
├── telegram-bot/
│   ├── main.py                    # Linux версия бота
│   ├── main_windows.py           # Windows версия бота
│   └── config/
│       └── auth_config.py        # Конфигурация авторизации
├── data/
│   ├── database/
│   │   ├── models.py             # Модели БД с методами для анкет
│   │   └── sessions.py          # Управление сессиями
│   └── upgrade_database_windows.py # Миграция БД
├── utils/
│   ├── __init__.py
│   └── console_helper.py        # Утилита для работы с эмодзи
├── scripts/
│   └── fix_all_emojis.py       # Замена эмодзи в файлах
└── test_anketa_autosave.py     # Тесты функционала
```

## Контакты

При возникновении вопросов обращайтесь к разработчику системы.

---
*Документ создан: 20.09.2025*