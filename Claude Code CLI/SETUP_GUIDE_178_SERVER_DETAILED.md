# –î–µ—Ç–∞–ª—å–Ω–∞—è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Claude Code CLI Wrapper –Ω–∞ 178.236.17.55

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-10-12
**–í–µ—Ä—Å–∏—è:** 1.0
**–°—Ç–∞—Ç—É—Å:** PRODUCTION READY
**–°–µ—Ä–≤–µ—Ä:** 178.236.17.55

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è](#—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
2. [–®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Claude CLI](#—à–∞–≥-1-—É—Å—Ç–∞–Ω–æ–≤–∫–∞-claude-cli)
3. [–®–∞–≥ 2: OAuth –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è](#—à–∞–≥-2-oauth-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)
4. [–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –†–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏](#—à–∞–≥-3-–ø—Ä–æ–≤–µ—Ä–∫–∞-—Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏)
5. [–®–∞–≥ 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python](#—à–∞–≥-4-—É—Å—Ç–∞–Ω–æ–≤–∫–∞-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π-python)
6. [–®–∞–≥ 5: –°–æ–∑–¥–∞–Ω–∏–µ Wrapper –°–∫—Ä–∏–ø—Ç–∞](#—à–∞–≥-5-—Å–æ–∑–¥–∞–Ω–∏–µ-wrapper-—Å–∫—Ä–∏–ø—Ç–∞)
7. [–®–∞–≥ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Wrapper](#—à–∞–≥-6-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ-wrapper)
8. [–®–∞–≥ 7: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Systemd Service](#—à–∞–≥-7-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-systemd-service)
9. [–®–∞–≥ 8: –§–∏–Ω–∞–ª—å–Ω–æ–µ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—à–∞–≥-8-—Ñ–∏–Ω–∞–ª—å–Ω–æ–µ-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
10. [Troubleshooting](#troubleshooting)
11. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
12. [Backup –∏ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ](#backup-–∏-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ)

---

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –°–µ—Ä–≤–µ—Ä
- **IP:** 178.236.17.55
- **OS:** Ubuntu 22.04 –∏–ª–∏ –Ω–æ–≤–µ–µ
- **User:** root (–∏–ª–∏ sudo –¥–æ—Å—Ç—É–ø)
- **–î–æ—Å—Ç—É–ø:** SSH –∫–ª—é—á –∏–ª–∏ –ø–∞—Ä–æ–ª—å
- **–°–µ—Ç—å:** –ù–ï —Ä–æ—Å—Å–∏–π—Å–∫–∏–π IP (Claude –¥–æ—Å—Ç—É–ø–µ–Ω)

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ
- Python 3.12+
- Node.js 18+ (–¥–ª—è Claude CLI)
- curl, wget (–æ–±—ã—á–Ω–æ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã)

### –î–æ—Å—Ç—É–ø—ã
- SSH –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä—É 178.236.17.55
- Anthropic Max subscription ($200/–º–µ—Å)
- –ë—Ä–∞—É–∑–µ—Ä –¥–ª—è OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

---

## –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Claude CLI

### 1.1 –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –°–µ—Ä–≤–µ—Ä—É

```bash
# –° –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã
ssh root@178.236.17.55
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- ‚úÖ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –í—ã –≤–∏–¥–∏—Ç–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏

### 1.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ Node.js

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Ä—Å–∏—é Node.js
node --version
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
v18.20.8 –∏–ª–∏ –Ω–æ–≤–µ–µ
```

**–ï—Å–ª–∏ Node.js –ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:**

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js 18 LTS
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt-get install -y nodejs

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
node --version
npm --version
```

### 1.3 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Claude CLI

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ npm
npm install -g @anthropic-ai/claude-code

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
claude --version
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
2.0.5 (Claude Code)
```

**–ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:**

```bash
# –ù–∞–π—Ç–∏ –≥–¥–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
which claude

# –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å npm global path
npm config get prefix
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: /usr –∏–ª–∏ /usr/local

# –î–æ–±–∞–≤–∏—Ç—å –≤ PATH –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
export PATH=$PATH:/usr/local/bin
echo 'export PATH=$PATH:/usr/local/bin' >> ~/.bashrc
```

---

## –®–∞–≥ 2: OAuth –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

### 2.1 –ó–∞–ø—É—Å–∫ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ 178.236.17.55
claude login
```

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç:**

–í—ã —É–≤–∏–¥–∏—Ç–µ –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫–æ–µ:

```
To authenticate, please open this URL in your browser:

https://claude.ai/oauth/authorize?client_id=...&response_type=code&...

Waiting for authentication...
```

### 2.2 –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ –ë—Ä–∞—É–∑–µ—Ä–µ

**–í–ê–ñ–ù–û:** –ë—Ä–∞—É–∑–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ –º–∞—à–∏–Ω–µ –° –¥–æ—Å—Ç—É–ø–æ–º –∫ Claude (–Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω).

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

#### –í–∞—Ä–∏–∞–Ω—Ç A: –õ–æ–∫–∞–ª—å–Ω—ã–π –ë—Ä–∞—É–∑–µ—Ä (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

1. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL** –∏–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
2. **–û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ** –≤ –±—Ä–∞—É–∑–µ—Ä–µ
3. **–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å** —á–µ—Ä–µ–∑ Anthropic –∞–∫–∫–∞—É–Ω—Ç:
   - Email/–ø–∞—Ä–æ–ª—å
   - –ò–ª–∏ Google OAuth
4. **–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–æ—Å—Ç—É–ø** –∫ Max subscription
5. **–î–æ–∂–¥–∏—Ç–µ—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è** "Authentication successful"

#### –í–∞—Ä–∏–∞–Ω—Ç B: SSH –¢—É–Ω–Ω–µ–ª—å (–µ—Å–ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç A –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

```bash
# –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ (–ù–ï –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!)
ssh -L 8080:localhost:8080 root@178.236.17.55

# –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
claude login --port 8080

# –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ
# http://localhost:8080
```

### 2.3 –ü—Ä–æ–≤–µ—Ä–∫–∞ Credentials

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω
ls -la ~/.claude/.credentials.json
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
-rw-r--r-- 1 root root 364 Oct 12 14:19 /root/.claude/.credentials.json
```

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (–±–µ–∑–æ–ø–∞—Å–Ω–æ - –±–µ–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤):**

```bash
cat ~/.claude/.credentials.json | python3 -c "
import sys, json
data = json.load(sys.stdin)
oauth = data.get('claudeAiOauth', {})
print(f\"Subscription: {oauth.get('subscriptionType')}\")
print(f\"Expires: {oauth.get('expiresAt')}\")
print(f\"Scopes: {oauth.get('scopes')}\")
"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
Subscription: max
Expires: 1760293563957
Scopes: ['user:inference', 'user:profile']
```

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–µ –∏—Å—Ç—ë–∫:**

```bash
python3 -c "
import json, time
with open('/root/.claude/.credentials.json') as f:
    data = json.load(f)
expires = data['claudeAiOauth']['expiresAt'] / 1000
now = time.time()
remaining = (expires - now) / 86400
print(f'–¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –µ—â—ë {remaining:.1f} –¥–Ω–µ–π')
if remaining < 1:
    print('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –¢–æ–∫–µ–Ω —Å–∫–æ—Ä–æ –∏—Å—Ç–µ—á—ë—Ç!')
elif remaining < 0:
    print('‚ùå –û–®–ò–ë–ö–ê: –¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫!')
else:
    print('‚úÖ –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω')
"
```

---

## –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –†–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### 3.1 –¢–µ—Å—Ç Headless –†–µ–∂–∏–º–∞

```bash
# –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç
claude -p "–ù–∞–ø–∏—à–∏ –æ–¥–Ω–æ —Å–ª–æ–≤–æ: –¢–ï–°–¢"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–¢–ï–°–¢
```

**–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ "Invalid OAuth token":**
- –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –®–∞–≥ 2 (OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)

**–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ "Command not found":**
- –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –®–∞–≥ 1.3 (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ + PATH)

### 3.2 –¢–µ—Å—Ç JSON Output

```bash
# –¢–µ—Å—Ç —Å JSON —Ñ–æ—Ä–º–∞—Ç–æ–º
claude -p --output-format json "–ù–∞–ø–∏—à–∏ –æ–¥–Ω–æ —Å–ª–æ–≤–æ: –£–°–ü–ï–•"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** JSON –æ–±—ä–µ–∫—Ç —Ç–∏–ø–∞:
```json
{
  "type": "result",
  "subtype": "success",
  "result": "–£–°–ü–ï–•",
  "duration_ms": 2708,
  "total_cost_usd": 0.00607365,
  "usage": {
    "input_tokens": 3,
    "output_tokens": 6,
    ...
  }
}
```

**–ï—Å–ª–∏ –≤—ã–¥–∞—ë—Ç —Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ JSON:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é: `claude --version` (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 2.0+)
- –û–±–Ω–æ–≤–∏—Ç–µ: `npm update -g @anthropic-ai/claude-code`

### 3.3 –¢–µ—Å—Ç –°–ª–æ–∂–Ω–æ–≥–æ –ü—Ä–æ–º–ø—Ç–∞

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
claude -p "Write one professional sentence about AI in healthcare."
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Ç–µ–∫—Å—Ç

---

## –®–∞–≥ 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python

### 4.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ Python

```bash
# –í–µ—Ä—Å–∏—è Python
python3 --version
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
Python 3.12.x –∏–ª–∏ 3.11.x
```

### 4.2 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ FastAPI –∏ Uvicorn

```bash
# –ü–æ–ø—ã—Ç–∫–∞ –æ–±—ã—á–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
pip3 install fastapi uvicorn
```

**–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ "externally-managed-environment":**

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å —Ñ–ª–∞–≥–æ–º
pip3 install fastapi uvicorn --break-system-packages
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:**

```bash
python3 -c "import fastapi; import uvicorn; print('FastAPI OK')"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
FastAPI OK
```

---

## –®–∞–≥ 5: –°–æ–∑–¥–∞–Ω–∏–µ Wrapper –°–∫—Ä–∏–ø—Ç–∞

### 5.1 –°–æ–∑–¥–∞—Ç—å –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```bash
# –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –¥–ª—è wrapper (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
mkdir -p /opt/claude-wrapper
cd /opt/claude-wrapper
```

**–ò–õ–ò –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /root:**

```bash
cd /root
```

### 5.2 –°–æ–∑–¥–∞—Ç—å –°–∫—Ä–∏–ø—Ç

```bash
# –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª wrapper
cat > /root/claude_wrapper.py << 'EOF'
#!/usr/bin/env python3
"""
Claude Code Wrapper Server
–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç HTTP API –¥–ª—è Claude CLI headless mode
"""

from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
import subprocess
import json
import asyncio
from typing import Optional
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI()

class ChatRequest(BaseModel):
    message: str
    model: Optional[str] = "sonnet"
    temperature: Optional[float] = 0.7
    max_tokens: Optional[int] = 2000

@app.get("/health")
async def health():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è"""
    return {
        "status": "healthy",
        "service": "Claude Code Wrapper",
        "server": "178.236.17.55",
        "oauth": "max_subscription"
    }

@app.post("/chat")
async def chat(request: ChatRequest):
    """–ß–∞—Ç —Å Claude —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π CLI"""
    try:
        logger.info(f"üì® Request: {len(request.message)} chars, model={request.model}")

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É
        cmd = [
            "claude",
            "-p",
            "--output-format", "json",
            request.message
        ]

        logger.info(f"üöÄ Starting Claude CLI...")

        # –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ subprocess
        process = await asyncio.create_subprocess_exec(
            *cmd,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE
        )

        # –ñ–¥—ë–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Å —Ç–∞–π–º–∞—É—Ç–æ–º)
        timeout = min(request.max_tokens / 10, 120) if request.max_tokens else 60

        try:
            stdout, stderr = await asyncio.wait_for(
                process.communicate(),
                timeout=timeout
            )
        except asyncio.TimeoutError:
            process.kill()
            raise HTTPException(status_code=504, detail="Claude CLI timeout")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞
        if process.returncode != 0:
            error_msg = stderr.decode("utf-8") if stderr else "Unknown error"
            logger.error(f"‚ùå CLI error: {error_msg}")
            raise HTTPException(status_code=500, detail=f"CLI error: {error_msg}")

        # –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
        output = stdout.decode("utf-8")
        response_data = json.loads(output)

        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if response_data.get("type") == "result" and response_data.get("subtype") == "success":
            result = response_data.get("result", "").strip()

            logger.info(f"‚úÖ Response: {len(result)} chars, ${response_data.get('total_cost_usd', 0):.4f}")

            return {
                "response": result,
                "model": request.model,
                "session_id": None,
                "usage": response_data.get("usage", {}),
                "cost": response_data.get("total_cost_usd", 0),
                "duration_ms": response_data.get("duration_ms", 0)
            }
        else:
            error = response_data.get("error", "Unknown error")
            raise HTTPException(status_code=500, detail=f"Claude error: {error}")

    except json.JSONDecodeError as e:
        logger.error(f"‚ùå JSON parse error: {e}")
        raise HTTPException(status_code=500, detail=f"Invalid JSON: {e}")

    except Exception as e:
        logger.error(f"‚ùå Error: {e}")
        raise HTTPException(status_code=500, detail=str(e))

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
EOF
```

### 5.3 –°–¥–µ–ª–∞—Ç—å –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–º

```bash
chmod +x /root/claude_wrapper.py
```

### 5.4 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –§–∞–π–ª

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–æ–∑–¥–∞–Ω
ls -lh /root/claude_wrapper.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
-rwxr-xr-x 1 root root 3.5K Oct 12 15:43 /root/claude_wrapper.py
```

---

## –®–∞–≥ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Wrapper

### 6.1 –ó–∞–ø—É—Å–∫ Wrapper –í—Ä—É—á–Ω—É—é

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ —Ñ–æ–Ω–µ
nohup python3 /root/claude_wrapper.py > /tmp/claude_wrapper.log 2>&1 &

# –ü–æ–¥–æ–∂–¥–∞—Ç—å 2 —Å–µ–∫—É–Ω–¥—ã
sleep 2

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
ps aux | grep claude_wrapper | grep -v grep
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–æ—Ü–µ—Å—Å python3 –∑–∞–ø—É—â–µ–Ω

### 6.2 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –õ–æ–≥–∏

```bash
tail -20 /tmp/claude_wrapper.log
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
INFO:     Started server process [184295]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
```

### 6.3 –¢–µ—Å—Ç Health Endpoint

```bash
curl -s http://localhost:8000/health | python3 -m json.tool
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "status": "healthy",
  "service": "Claude Code Wrapper",
  "server": "178.236.17.55",
  "oauth": "max_subscription"
}
```

**–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ "Connection refused":**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ wrapper –∑–∞–ø—É—â–µ–Ω: `ps aux | grep claude_wrapper`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `tail /tmp/claude_wrapper.log`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç: `netstat -tulpn | grep 8000`

### 6.4 –¢–µ—Å—Ç Chat Endpoint

```bash
curl -s -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "–ù–∞–ø–∏—à–∏ –æ–¥–Ω–æ —Å–ª–æ–≤–æ: –†–ê–ë–û–¢–ê–ï–¢", "model": "sonnet", "max_tokens": 100}' \
  | python3 -m json.tool
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "response": "–†–ê–ë–û–¢–ê–ï–¢",
  "model": "sonnet",
  "session_id": null,
  "usage": {
    "input_tokens": 4,
    "output_tokens": 7,
    ...
  },
  "cost": 0.00607365,
  "duration_ms": 2708
}
```

### 6.5 –¢–µ—Å—Ç –°–ª–æ–∂–Ω–æ–≥–æ –ó–∞–ø—Ä–æ—Å–∞

```bash
curl -s -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Write a professional sentence about artificial intelligence in healthcare.",
    "model": "opus",
    "max_tokens": 200
  }' | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['response'])"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Ç–µ–∫—Å—Ç

### 6.6 –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –¢–µ—Å—Ç–æ–≤–æ–≥–æ Wrapper

```bash
# –ù–∞–π—Ç–∏ PID
ps aux | grep claude_wrapper | grep -v grep

# –£–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å
pkill -f claude_wrapper.py

# –ò–ª–∏
killall -9 python3  # –û–°–¢–û–†–û–ñ–ù–û! –£–±—å—ë—Ç –≤—Å–µ python –ø—Ä–æ—Ü–µ—Å—Å—ã
```

---

## –®–∞–≥ 7: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Systemd Service

### 7.1 –°–æ–∑–¥–∞—Ç—å Service –§–∞–π–ª

```bash
cat > /etc/systemd/system/claude-wrapper.service << 'EOF'
[Unit]
Description=Claude Code API Wrapper
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root
ExecStart=/usr/bin/python3 /root/claude_wrapper.py
Restart=always
RestartSec=10
StandardOutput=append:/var/log/claude-wrapper.log
StandardError=append:/var/log/claude-wrapper.log

# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
MemoryLimit=512M
CPUQuota=50%

[Install]
WantedBy=multi-user.target
EOF
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:**

- `After=network.target` - –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ—Å–ª–µ —Å–µ—Ç–∏
- `Type=simple` - –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–æ—Ü–µ—Å—Å
- `Restart=always` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
- `RestartSec=10` - –∂–¥–∞—Ç—å 10 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º
- `StandardOutput/Error` - –ª–æ–≥–∏ –≤ /var/log/claude-wrapper.log
- `MemoryLimit=512M` - –Ω–µ –±–æ–ª–µ–µ 512MB RAM
- `CPUQuota=50%` - –Ω–µ –±–æ–ª–µ–µ 50% CPU

### 7.2 –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å Systemd

```bash
systemctl daemon-reload
```

### 7.3 –í–∫–ª—é—á–∏—Ç—å –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫

```bash
systemctl enable claude-wrapper.service
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
Created symlink /etc/systemd/system/multi-user.target.wants/claude-wrapper.service ‚Üí /etc/systemd/system/claude-wrapper.service.
```

### 7.4 –ó–∞–ø—É—Å—Ç–∏—Ç—å Service

```bash
systemctl start claude-wrapper.service
```

### 7.5 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –°—Ç–∞—Ç—É—Å

```bash
systemctl status claude-wrapper.service --no-pager
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚óè claude-wrapper.service - Claude Code API Wrapper
     Loaded: loaded (/etc/systemd/system/claude-wrapper.service; enabled; preset: enabled)
     Active: active (running) since Sun 2025-10-12 15:48:23 UTC; 2s ago
   Main PID: 185111 (python3)
      Tasks: 1 (limit: 4655)
     Memory: 30.2M (peak: 30.2M)
        CPU: 625ms
     CGroup: /system.slice/claude-wrapper.service
             ‚îî‚îÄ185111 /usr/bin/python3 /root/claude_wrapper.py

Oct 12 15:48:23 ctytdjxzil systemd[1]: Started claude-wrapper.service - Claude Code API Wrapper.
```

**–ö–ª—é—á–µ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏:**

- `Active: active (running)` ‚úÖ - —Ä–∞–±–æ—Ç–∞–µ—Ç
- `Loaded: ... enabled` ‚úÖ - –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –≤–∫–ª—é—á—ë–Ω

**–ï—Å–ª–∏ –æ—à–∏–±–∫–∞:**

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏
journalctl -u claude-wrapper.service -n 50 --no-pager
```

### 7.6 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –õ–æ–≥–∏

```bash
tail -20 /var/log/claude-wrapper.log
```

---

## –®–∞–≥ 8: –§–∏–Ω–∞–ª—å–Ω–æ–µ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 8.1 –¢–µ—Å—Ç —Å –õ–æ–∫–∞–ª—å–Ω–æ–≥–æ –°–µ—Ä–≤–µ—Ä–∞

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ 178.236.17.55
curl -s http://localhost:8000/health
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `{"status":"healthy",...}`

### 8.2 –¢–µ—Å—Ç —Å –í–Ω–µ—à–Ω–µ–≥–æ IP

**–° –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã (Windows/Mac/Linux):**

```bash
curl -s http://178.236.17.55:8000/health
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `{"status":"healthy",...}`

**–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ "Connection refused":**

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å firewall –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ 178.236.17.55
ufw status

# –ï—Å–ª–∏ –ø–æ—Ä—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
ufw allow 8000/tcp
ufw reload
```

### 8.3 –¢–µ—Å—Ç —Å Production –°–µ—Ä–≤–µ—Ä–∞

```bash
# –ù–∞ production —Å–µ—Ä–≤–µ—Ä–µ 5.35.88.251
ssh root@5.35.88.251
curl -s http://178.236.17.55:8000/health
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `{"status":"healthy",...}`

### 8.4 –¢–µ—Å—Ç –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¢–µ–∫—Å—Ç–∞

**–° –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã:**

```bash
curl -X POST http://178.236.17.55:8000/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Write a one-sentence summary of quantum computing.",
    "model": "opus",
    "max_tokens": 150
  }'
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** JSON —Å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –ø—Ä–æ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã

### 8.5 –ü—Ä–æ–≤–µ—Ä–∫–∞ –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞

**–¢–µ—Å—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:**

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ 178.236.17.55
systemctl reboot
```

**–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ (–ø–æ–¥–æ–∂–¥–∞—Ç—å 1-2 –º–∏–Ω—É—Ç—ã):**

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —Å–Ω–æ–≤–∞
ssh root@178.236.17.55

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
systemctl status claude-wrapper.service
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `Active: active (running)`

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ API —Ä–∞–±–æ—Ç–∞–µ—Ç:**

```bash
curl -s http://localhost:8000/health
```

---

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞ 1: OAuth –ò—Å—Ç—ë–∫

**–°–∏–º–ø—Ç–æ–º—ã:**
```
Error 401: Unauthorized
Token expired
```

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –ü–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è
claude login

# –°–ª–µ–¥–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º OAuth (–®–∞–≥ 2)

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å wrapper
systemctl restart claude-wrapper.service
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: Wrapper –ù–µ –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã:**
```
systemctl status claude-wrapper.service
Active: failed
```

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**

```bash
# –°–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏
journalctl -u claude-wrapper.service -n 100 --no-pager

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
tail -50 /var/log/claude-wrapper.log

# –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é
python3 /root/claude_wrapper.py
```

**–ß–∞—Å—Ç—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**

1. **FastAPI –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:**
   ```bash
   pip3 install fastapi uvicorn --break-system-packages
   ```

2. **Claude CLI –Ω–µ –Ω–∞–π–¥–µ–Ω:**
   ```bash
   which claude
   # –ï—Å–ª–∏ –ø—É—Å—Ç–æ - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (–®–∞–≥ 1)
   ```

3. **–ü–æ—Ä—Ç 8000 –∑–∞–Ω—è—Ç:**
   ```bash
   netstat -tulpn | grep 8000
   # –£–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ 8000 –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—Ç –≤ wrapper
   ```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: Connection Refused –ò–∑–≤–Ω–µ

**–°–∏–º–ø—Ç–æ–º—ã:**
```bash
curl http://178.236.17.55:8000/health
curl: (7) Failed to connect to 178.236.17.55 port 8000: Connection refused
```

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ wrapper —Å–ª—É—à–∞–µ—Ç –Ω–∞ 0.0.0.0 (–Ω–µ 127.0.0.1)
netstat -tulpn | grep 8000

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# tcp  0  0  0.0.0.0:8000  0.0.0.0:*  LISTEN  185111/python3

# –ï—Å–ª–∏ 127.0.0.1:8000 - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ wrapper
# uvicorn.run(app, host="0.0.0.0", port=8000)  ‚Üê –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 0.0.0.0

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å firewall
ufw status
ufw allow 8000/tcp
```

### –ü—Ä–æ–±–ª–µ–º–∞ 4: Wrapper –ú–µ–¥–ª–µ–Ω–Ω–æ –û—Ç–≤–µ—á–∞–µ—Ç

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ó–∞–ø—Ä–æ—Å—ã –∑–∞–Ω–∏–º–∞—é—Ç >30 —Å–µ–∫—É–Ω–¥
- Timeouts

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É —Å–µ—Ä–≤–µ—Ä–∞
top

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å memory
free -h

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Claude CLI
claude -p "test" --output-format json

# –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã –≤ systemd
nano /etc/systemd/system/claude-wrapper.service
# –ò–∑–º–µ–Ω–∏—Ç—å:
# MemoryLimit=1G
# CPUQuota=100%

systemctl daemon-reload
systemctl restart claude-wrapper.service
```

### –ü—Ä–æ–±–ª–µ–º–∞ 5: JSON Parse Error

**–°–∏–º–ø—Ç–æ–º—ã:**
```
Invalid JSON response
```

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Claude CLI –Ω–∞–ø—Ä—è–º—É—é
claude -p "test" --output-format json

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Ä—Å–∏—é
claude --version
# –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å 2.0+

# –û–±–Ω–æ–≤–∏—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
npm update -g @anthropic-ai/claude-code
```

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ó–¥–æ—Ä–æ–≤—å—è

**–°–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**

```bash
cat > /root/check_claude_wrapper.sh << 'EOF'
#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è Claude Wrapper

echo "=== Claude Wrapper Health Check ==="
echo "Date: $(date)"
echo ""

# 1. Systemd status
echo "1. Systemd Status:"
systemctl is-active claude-wrapper.service
echo ""

# 2. HTTP health
echo "2. HTTP Health:"
curl -s -f http://localhost:8000/health > /dev/null
if [ $? -eq 0 ]; then
    echo "‚úÖ HTTP OK"
else
    echo "‚ùå HTTP FAILED"
fi
echo ""

# 3. Test request
echo "3. Test Request:"
RESPONSE=$(curl -s -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"Write one word: OK","model":"sonnet","max_tokens":10}' \
  | python3 -c "import sys,json; print(json.load(sys.stdin).get('response','ERROR'))")

if [ "$RESPONSE" == "OK" ]; then
    echo "‚úÖ Claude API OK"
else
    echo "‚ö†Ô∏è Response: $RESPONSE"
fi
echo ""

# 4. OAuth expiry
echo "4. OAuth Expiry:"
python3 << PYTHON
import json, time
try:
    with open('/root/.claude/.credentials.json') as f:
        data = json.load(f)
    expires = data['claudeAiOauth']['expiresAt'] / 1000
    remaining = (expires - time.time()) / 86400
    print(f"‚úÖ Valid for {remaining:.1f} days")
    if remaining < 7:
        print("‚ö†Ô∏è WARNING: Expiring soon!")
except Exception as e:
    print(f"‚ùå ERROR: {e}")
PYTHON
echo ""

# 5. Resource usage
echo "5. Resource Usage:"
ps aux | grep claude_wrapper | grep -v grep | awk '{print "CPU: "$3"% MEM: "$4"%"}'
echo ""

echo "=== End Health Check ==="
EOF

chmod +x /root/check_claude_wrapper.sh
```

**–ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏:**

```bash
/root/check_claude_wrapper.sh
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Cron)

```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ cron - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å
crontab -e

# –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É:
0 * * * * /root/check_claude_wrapper.sh >> /var/log/claude-wrapper-health.log 2>&1
```

### –õ–æ–≥–∏

**–ü—Ä–æ—Å–º–æ—Ç—Ä –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:**

```bash
# Wrapper –ª–æ–≥–∏
tail -f /var/log/claude-wrapper.log

# Systemd –∂—É—Ä–Ω–∞–ª
journalctl -u claude-wrapper.service -f

# –í—Å–µ –≤–º–µ—Å—Ç–µ
tail -f /var/log/claude-wrapper.log /var/log/syslog
```

**–†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤:**

```bash
cat > /etc/logrotate.d/claude-wrapper << 'EOF'
/var/log/claude-wrapper.log {
    daily
    rotate 7
    compress
    delaycompress
    notifempty
    missingok
    create 0640 root root
    postrotate
        systemctl reload claude-wrapper.service > /dev/null 2>&1 || true
    endscript
}
EOF
```

---

## Backup –∏ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

### Backup

**–ß—Ç–æ –±—ç–∫–∞–ø–∏—Ç—å:**

1. **OAuth credentials:**
   ```bash
   cp /root/.claude/.credentials.json /root/claude-credentials-backup-$(date +%Y%m%d).json
   ```

2. **Wrapper script:**
   ```bash
   cp /root/claude_wrapper.py /root/claude_wrapper-backup-$(date +%Y%m%d).py
   ```

3. **Systemd service:**
   ```bash
   cp /etc/systemd/system/claude-wrapper.service /root/claude-wrapper-service-backup-$(date +%Y%m%d).service
   ```

**–ü–æ–ª–Ω—ã–π backup —Å–∫—Ä–∏–ø—Ç:**

```bash
cat > /root/backup_claude.sh << 'EOF'
#!/bin/bash
BACKUP_DIR=/root/claude-backups
DATE=$(date +%Y%m%d-%H%M%S)

mkdir -p $BACKUP_DIR

# Backup files
cp /root/.claude/.credentials.json $BACKUP_DIR/credentials-$DATE.json
cp /root/claude_wrapper.py $BACKUP_DIR/wrapper-$DATE.py
cp /etc/systemd/system/claude-wrapper.service $BACKUP_DIR/service-$DATE.service

echo "‚úÖ Backup completed: $BACKUP_DIR/"
ls -lh $BACKUP_DIR/ | tail -3
EOF

chmod +x /root/backup_claude.sh
```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

**–ï—Å–ª–∏ OAuth –ø–æ—Ç–µ—Ä—è–Ω:**

```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ backup
cp /root/claude-backups/credentials-YYYYMMDD.json /root/.claude/.credentials.json

# –ò–ª–∏ –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è
claude login
```

**–ï—Å–ª–∏ wrapper script –ø–æ–≤—Ä–µ–∂–¥—ë–Ω:**

```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ backup
cp /root/claude-backups/wrapper-YYYYMMDD.py /root/claude_wrapper.py

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
systemctl restart claude-wrapper.service
```

**–ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:**

```bash
#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –ø–æ–ª–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Claude Wrapper..."

# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å service
systemctl stop claude-wrapper.service

# 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª—ã
LATEST_CREDENTIALS=$(ls -t /root/claude-backups/credentials-*.json | head -1)
LATEST_WRAPPER=$(ls -t /root/claude-backups/wrapper-*.py | head -1)
LATEST_SERVICE=$(ls -t /root/claude-backups/service-*.service | head -1)

cp $LATEST_CREDENTIALS /root/.claude/.credentials.json
cp $LATEST_WRAPPER /root/claude_wrapper.py
cp $LATEST_SERVICE /etc/systemd/system/claude-wrapper.service

# 3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å
systemctl daemon-reload
systemctl start claude-wrapper.service
systemctl status claude-wrapper.service

echo "‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
```

---

## –ë—ã—Å—Ç—Ä—ã–π –ß–µ–∫–ª–∏—Å—Ç

### –ü–æ—Å–ª–µ –£—Å—Ç–∞–Ω–æ–≤–∫–∏

- [ ] Claude CLI —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: `claude --version`
- [ ] OAuth –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: `ls ~/.claude/.credentials.json`
- [ ] Headless —Ä–∞–±–æ—Ç–∞–µ—Ç: `claude -p "test"`
- [ ] Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `python3 -c "import fastapi"`
- [ ] Wrapper —Å–æ–∑–¥–∞–Ω: `ls /root/claude_wrapper.py`
- [ ] Systemd service: `systemctl status claude-wrapper`
- [ ] Health endpoint: `curl http://localhost:8000/health`
- [ ] Chat endpoint: —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø: `curl http://178.236.17.55:8000/health`
- [ ] –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫: `systemctl is-enabled claude-wrapper`
- [ ] Backup —Å–æ–∑–¥–∞–Ω: `ls /root/claude-backups/`

### –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ü—Ä–æ–≤–µ—Ä–∫–∏ (–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ)

- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å OAuth: `/root/check_claude_wrapper.sh`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `tail /var/log/claude-wrapper.log`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å disk space: `df -h`
- [ ] –°–¥–µ–ª–∞—Ç—å backup: `/root/backup_claude.sh`

### –ü–µ—Ä–µ–¥ –ò—Å—Ç–µ—á–µ–Ω–∏–µ–º OAuth (–∑–∞ –Ω–µ–¥–µ–ª—é)

- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞—Ç—É –∏—Å—Ç–µ—á–µ–Ω–∏—è
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å browser –¥–æ—Å—Ç—É–ø
- [ ] –ü–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è: `claude login`
- [ ] –°–¥–µ–ª–∞—Ç—å backup –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ü–æ–¥–¥–µ—Ä–∂–∫–∞

**–°–µ—Ä–≤–µ—Ä:** 178.236.17.55
**Wrapper Port:** 8000
**Systemd Service:** claude-wrapper.service

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- Claude Code: https://docs.claude.com/en/docs/claude-code
- FastAPI: https://fastapi.tiangolo.com/
- Systemd: `man systemd.service`

**–õ–æ–≥–∏:**
- Wrapper: `/var/log/claude-wrapper.log`
- Systemd: `journalctl -u claude-wrapper.service`

**–í–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- OAuth: `/root/.claude/.credentials.json`
- Script: `/root/claude_wrapper.py`
- Service: `/etc/systemd/system/claude-wrapper.service`
- Health check: `/root/check_claude_wrapper.sh`
- Backup: `/root/backup_claude.sh`

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** 1.0
**–î–∞—Ç–∞:** 2025-10-12
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞:** Ubuntu 22.04, Python 3.12, Claude CLI 2.0.5
**–°—Ç–∞—Ç—É—Å:** ‚úÖ PRODUCTION READY
