# üîç Claude Code WebSearch –¥–ª—è Researcher Agent

**–î–∞—Ç–∞**: 2025-10-08
**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã**: RESEARCHER_ARCHITECTURE_ANALYSIS.md
**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: Claude Code API + WebSearch tool

---

## üéØ –ö–ª—é—á–µ–≤–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ

**Claude Code –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π WebSearch tool!**

–≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –¥–ª—è Researcher Agent **–ù–ï –ù–£–ñ–ï–ù Perplexity API** - –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WebSearch –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ Claude Code.

---

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ WebSearch vs Perplexity

| –ö—Ä–∏—Ç–µ—Ä–∏–π | Claude Code WebSearch | Perplexity API |
|----------|----------------------|----------------|
| **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** | ‚úÖ –£–∂–µ –µ—Å—Ç—å | ‚ùå –ù—É–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å |
| **API Key** | ‚úÖ –£–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω | ‚ùå –ù—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π |
| **–°—Ç–æ–∏–º–æ—Å—Ç—å** | ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ (–≤ –ø–æ–¥–ø–∏—Å–∫–µ) | ‚ùå $0.27 –Ω–∞ –∞–Ω–∫–µ—Ç—É (27 –∑–∞–ø—Ä–æ—Å–æ–≤ √ó $0.01) |
| **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–æ–º–µ–Ω–æ–≤** | ‚úÖ allowed_domains | ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ |
| **RU-–∏—Å—Ç–æ—á–Ω–∏–∫–∏** | ‚úÖ –û—Ç–ª–∏—á–Ω–æ | ‚úÖ –•–æ—Ä–æ—à–æ |
| **–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å** | ‚úÖ –î–∞ | ‚úÖ –î–∞ |
| **–¶–∏—Ç–∞—Ç—ã** | ‚úÖ –° –ø–∞—Ä—Å–∏–Ω–≥–æ–º | ‚úÖ –î–∞ |
| **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å** | ‚úÖ –ß–µ—Ä–µ–∑ Claude Code API | ‚ö†Ô∏è –û—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å |

**–í—ã–≤–æ–¥**: WebSearch Claude Code - –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è Researcher!

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å WebSearch

### **–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞**
```
–ê–Ω–∫–µ—Ç–∞ ‚Üí Auditor (OK) ‚Üí Researcher (PENDING!) ‚Üí Planner ‚Üí Writer
                              ‚Üì
                         –°–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å, –Ω–æ –ù–ï –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
                         status='pending', completed_at=None
```

### **–¶–µ–ª–µ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ**
```
–ê–Ω–∫–µ—Ç–∞ ‚Üí Auditor ‚Üí Researcher (–ê–í–¢–û–ó–ê–ü–£–°–ö!)
                        ‚Üì
                   Claude Code WebSearch
                        ‚Üì
                   27 —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:
                   ‚îú‚îÄ‚îÄ –ë–ª–æ–∫ 1: –ü—Ä–æ–±–ª–µ–º–∞ (10 –∑–∞–ø—Ä–æ—Å–æ–≤)
                   ‚îÇ   ‚îú‚îÄ‚îÄ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (rosstat.gov.ru)
                   ‚îÇ   ‚îú‚îÄ‚îÄ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (elibrary.ru)
                   ‚îÇ   ‚îú‚îÄ‚îÄ –ü—Ä–æ–≥—Ä–∞–º–º—ã (nationalprojects.ru)
                   ‚îÇ   ‚îî‚îÄ‚îÄ ...
                   ‚îú‚îÄ‚îÄ –ë–ª–æ–∫ 2: –ì–µ–æ–≥—Ä–∞—Ñ–∏—è + –¶–ê (10 –∑–∞–ø—Ä–æ—Å–æ–≤)
                   ‚îÇ   ‚îú‚îÄ‚îÄ –î–µ–º–æ–≥—Ä–∞—Ñ–∏—è (fedstat.ru)
                   ‚îÇ   ‚îú‚îÄ‚îÄ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (minsport.gov.ru)
                   ‚îÇ   ‚îî‚îÄ‚îÄ ...
                   ‚îî‚îÄ‚îÄ –ë–ª–æ–∫ 3: –ó–∞–¥–∞—á–∏ + —Ü–µ–ª—å (7 –∑–∞–ø—Ä–æ—Å–æ–≤)
                       ‚îú‚îÄ‚îÄ KPI (government.ru)
                       ‚îú‚îÄ‚îÄ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
                       ‚îî‚îÄ‚îÄ ...
                        ‚Üì
                   research_results (JSONB)
                   {
                     block1: {facts, quotes, sources},
                     block2: {demographics, infrastructure},
                     block3: {goals, indicators}
                   }
                        ‚Üì
                   status='completed', completed_at=NOW()
                        ‚Üì
                   Planner ‚Üí Writer ‚Üí Grant (—Å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ–º!)
```

---

## ü§ñ Researcher Agent —Å WebSearch

### **–ù–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**

**–§–∞–π–ª**: `agents/researcher_agent.py`

```python
import os
import asyncio
from typing import Dict, List, Any
from datetime import datetime
import json

class ResearcherAgent(BaseAgent):
    """–ê–≥–µ–Ω—Ç-–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å —Å Claude Code WebSearch"""

    def __init__(self, db, llm_provider: str = "claude_code"):
        super().__init__("researcher", db, llm_provider)

        # Claude Code API
        self.claude_api_key = os.getenv('CLAUDE_CODE_API_KEY')
        self.claude_base_url = os.getenv('CLAUDE_CODE_BASE_URL')

        # –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ RU-–¥–æ–º–µ–Ω—ã
        self.OFFICIAL_DOMAINS = [
            "rosstat.gov.ru",
            "fedstat.ru",
            "gks.ru",
            "minsport.gov.ru",
            "nationalprojects.ru",
            "government.ru",
            "minzdrav.gov.ru",
            "minprosvet.gov.ru",
            "elibrary.ru",
            "cyberleninka.ru"
        ]

    async def research_anketa(self, anketa_id: str) -> Dict[str, Any]:
        """
        –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Claude Code WebSearch

        –í—ã–ø–æ–ª–Ω—è–µ—Ç 27 —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –ø—Ä–æ–º—Ç–∞–º —ç–∫—Å–ø–µ—Ä—Ç–∞:
        - –ë–ª–æ–∫ 1: –ü—Ä–æ–±–ª–µ–º–∞ –∏ —Å–æ—Ü–∏–∞–ª—å–Ω–∞—è –∑–Ω–∞—á–∏–º–æ—Å—Ç—å (10 –∑–∞–ø—Ä–æ—Å–æ–≤)
        - –ë–ª–æ–∫ 2: –ì–µ–æ–≥—Ä–∞—Ñ–∏—è –∏ —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è (10 –∑–∞–ø—Ä–æ—Å–æ–≤)
        - –ë–ª–æ–∫ 3: –ó–∞–¥–∞—á–∏, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, —Ü–µ–ª—å (7 –∑–∞–ø—Ä–æ—Å–æ–≤)
        """
        try:
            # 1. –ü–æ–ª—É—á–∏—Ç—å –∞–Ω–∫–µ—Ç—É
            anketa = self.db.get_session_by_anketa_id(anketa_id)

            if not anketa:
                return {
                    'status': 'error',
                    'message': f'–ê–Ω–∫–µ—Ç–∞ {anketa_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
                }

            # 2. –ò–∑–≤–ª–µ—á—å placeholders
            placeholders = self._extract_placeholders(anketa)

            # 3. –í—ã–ø–æ–ª–Ω–∏—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–æ –±–ª–æ–∫–∞–º
            print(f"üîç –ù–∞—á–∏–Ω–∞–µ–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ {anketa_id}...")

            block1_results = await self._research_block1_websearch(placeholders)
            print(f"‚úÖ –ë–ª–æ–∫ 1 –∑–∞–≤–µ—Ä—à—ë–Ω: {len(block1_results.get('queries', []))} –∑–∞–ø—Ä–æ—Å–æ–≤")

            block2_results = await self._research_block2_websearch(placeholders)
            print(f"‚úÖ –ë–ª–æ–∫ 2 –∑–∞–≤–µ—Ä—à—ë–Ω: {len(block2_results.get('queries', []))} –∑–∞–ø—Ä–æ—Å–æ–≤")

            block3_results = await self._research_block3_websearch(placeholders)
            print(f"‚úÖ –ë–ª–æ–∫ 3 –∑–∞–≤–µ—Ä—à—ë–Ω: {len(block3_results.get('queries', []))} –∑–∞–ø—Ä–æ—Å–æ–≤")

            # 4. –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            research_results = {
                'block1': block1_results,
                'block2': block2_results,
                'block3': block3_results,
                'metadata': {
                    'total_queries': (
                        len(block1_results.get('queries', [])) +
                        len(block2_results.get('queries', [])) +
                        len(block3_results.get('queries', []))
                    ),
                    'sources_count': self._count_sources([
                        block1_results, block2_results, block3_results
                    ]),
                    'quotes_count': self._count_quotes([
                        block1_results, block2_results, block3_results
                    ])
                }
            }

            # 5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
            research_data = {
                'anketa_id': anketa_id,
                'user_id': anketa.get('telegram_id'),
                'session_id': anketa.get('id'),
                'research_type': 'comprehensive_websearch',
                'llm_provider': 'claude_code',
                'model': 'sonnet-4.5',
                'status': 'completed',
                'completed_at': datetime.now(),
                'research_results': research_results
            }

            research_id = self.db.save_research_results(research_data)

            print(f"‚úÖ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! ID: {research_id}")

            return {
                'status': 'success',
                'research_id': research_id,
                'anketa_id': anketa_id,
                'results': research_results
            }

        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è: {e}")
            return {
                'status': 'error',
                'message': str(e),
                'anketa_id': anketa_id
            }

    async def _research_block1_websearch(self, p: Dict) -> Dict:
        """
        –ë–ª–æ–∫ 1: –ü—Ä–æ–±–ª–µ–º–∞ –∏ —Å–æ—Ü–∏–∞–ª—å–Ω–∞—è –∑–Ω–∞—á–∏–º–æ—Å—Ç—å (10 –∑–∞–ø—Ä–æ—Å–æ–≤)

        –ü–æ –ø—Ä–æ–º—Ç–∞–º —ç–∫—Å–ø–µ—Ä—Ç–∞ –∏–∑ agents/251008/—Ç–µ—Å—Ç_–ø—Ä–æ–º–ø—Ç_1_–ø—Ä–æ–±–ª–µ–º–∞_–∏_—Å–æ—Ü_–∑–Ω–∞—á–∏–º–æ—Å—Ç—å.md
        """
        results = {
            'block_name': '–ü—Ä–æ–±–ª–µ–º–∞ –∏ —Å–æ—Ü–∏–∞–ª—å–Ω–∞—è –∑–Ω–∞—á–∏–º–æ—Å—Ç—å',
            'queries': []
        }

        # –ó–∞–ø—Ä–æ—Å 1: –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        q1 = await self._websearch_with_claude(
            query=f"–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ {p['–ü–†–û–ë–õ–ï–ú–ê']} {p['–†–ï–ì–ò–û–ù']} 2022-2025",
            allowed_domains=["rosstat.gov.ru", "fedstat.ru", "gks.ru"],
            context="–ù–∞–π–¥–∏ —Ç–æ—á–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ –¥–∏–Ω–∞–º–∏–∫—É –ø—Ä–æ–±–ª–µ–º—ã"
        )
        results['queries'].append({
            'name': '–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
            'query': q1['query'],
            'result': q1['result']
        })

        # –ó–∞–ø—Ä–æ—Å 2: –ù–∞—É—á–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
        q2 = await self._websearch_with_claude(
            query=f"–Ω–∞—É—á–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏—è {p['–ü–†–û–ë–õ–ï–ú–ê']} –†–§ 2022-2025",
            allowed_domains=["elibrary.ru", "cyberleninka.ru"],
            context="–ù–∞–π–¥–∏ 3-5 –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"
        )
        results['queries'].append({
            'name': '–ù–∞—É—á–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è',
            'query': q2['query'],
            'result': q2['result']
        })

        # –ó–∞–ø—Ä–æ—Å 3: –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã
        q3 = await self._websearch_with_claude(
            query=f"–≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –Ω–∞—Ü–ø—Ä–æ–µ–∫—Ç—ã {p['–°–§–ï–†–ê']} {p['–ü–†–û–ë–õ–ï–ú–ê']} 2024-2025",
            allowed_domains=["nationalprojects.ru", "government.ru"],
            context="–ù–∞–π–¥–∏ —Å–≤—è–∑—å —Å –Ω–∞—Ü–ø—Ä–æ–µ–∫—Ç–∞–º–∏ –∏ —Ü–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏"
        )
        results['queries'].append({
            'name': '–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã',
            'query': q3['query'],
            'result': q3['result']
        })

        # ... –µ—â–µ 7 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –ø—Ä–æ–º—Ç–∞–º —ç–∫—Å–ø–µ—Ä—Ç–∞

        return results

    async def _research_block2_websearch(self, p: Dict) -> Dict:
        """–ë–ª–æ–∫ 2: –ì–µ–æ–≥—Ä–∞—Ñ–∏—è –∏ —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è (10 –∑–∞–ø—Ä–æ—Å–æ–≤)"""
        # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ block1
        pass

    async def _research_block3_websearch(self, p: Dict) -> Dict:
        """–ë–ª–æ–∫ 3: –ó–∞–¥–∞—á–∏, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, —Ü–µ–ª—å (7 –∑–∞–ø—Ä–æ—Å–æ–≤)"""
        # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ block1
        pass

    async def _websearch_with_claude(
        self,
        query: str,
        allowed_domains: List[str] = None,
        context: str = ""
    ) -> Dict:
        """
        –í—ã–ø–æ–ª–Ω–∏—Ç—å WebSearch —á–µ—Ä–µ–∑ Claude Code

        Args:
            query: –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
            allowed_domains: –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤ (RU-–∏—Å—Ç–æ—á–Ω–∏–∫–∏)
            context: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è Claude

        Returns:
            {
                'query': str,
                'result': {
                    'summary': str,
                    'sources': List[Dict],
                    'quotes': List[Dict]
                }
            }
        """
        import requests

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ Claude Code
        headers = {
            "Authorization": f"Bearer {self.claude_api_key}",
            "Content-Type": "application/json"
        }

        # –ü—Ä–æ–º–ø—Ç –¥–ª—è Claude —Å WebSearch
        prompt = f"""
–í—ã–ø–æ–ª–Ω–∏ –ø–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "{query}"

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- –¢–æ–ª—å–∫–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–∑: {', '.join(allowed_domains or self.OFFICIAL_DOMAINS)}
- –î–∞–Ω–Ω—ã–µ –Ω–µ —Å—Ç–∞—Ä—à–µ 3 –ª–µ—Ç (2022-2025)
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º

–ó–∞–¥–∞—á–∞: {context}

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{{
    "summary": "–∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ (5-7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)",
    "sources": [
        {{
            "url": "–ø–æ–ª–Ω—ã–π URL",
            "title": "–Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞/—Å—Ç—Ä–∞–Ω–∏—Ü—ã",
            "org": "–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è (–†–æ—Å—Å—Ç–∞—Ç, –ú–∏–Ω—Å–ø–æ—Ä—Ç –∏ —Ç.–¥.)",
            "date": "–¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏",
            "relevance": "–≤—ã—Å–æ–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/–Ω–∏–∑–∫–∞—è"
        }}
    ],
    "quotes": [
        {{
            "text": "–ø—Ä—è–º–∞—è —Ü–∏—Ç–∞—Ç–∞ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)",
            "source": "URL –∏—Å—Ç–æ—á–Ω–∏–∫–∞",
            "org": "–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è",
            "date": "–¥–∞—Ç–∞",
            "strength": "A|B (A - —Å–∏–ª—å–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞)"
        }}
    ]
}}

–ò—Å–ø–æ–ª—å–∑—É–π WebSearch tool –¥–ª—è –ø–æ–∏—Å–∫–∞.
"""

        payload = {
            "message": prompt,
            "model": "sonnet",
            "temperature": 0.3,
            "max_tokens": 2000
        }

        try:
            response = requests.post(
                f"{self.claude_base_url}/chat",
                headers=headers,
                json=payload,
                timeout=30
            )

            if response.status_code == 200:
                data = response.json()
                claude_response = data.get('response', '{}')

                # –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ Claude
                try:
                    result = json.loads(claude_response)
                except json.JSONDecodeError:
                    # –ï—Å–ª–∏ Claude –≤–µ—Ä–Ω—É–ª –Ω–µ JSON, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å
                    result = {
                        'summary': claude_response[:500],
                        'sources': [],
                        'quotes': []
                    }

                return {
                    'query': query,
                    'result': result
                }
            else:
                raise Exception(f"Claude API error: {response.status_code}")

        except Exception as e:
            print(f"‚ùå WebSearch –æ—à–∏–±–∫–∞: {e}")
            return {
                'query': query,
                'result': {
                    'summary': f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {str(e)}",
                    'sources': [],
                    'quotes': []
                }
            }

    def _extract_placeholders(self, anketa: Dict) -> Dict:
        """–ò–∑–≤–ª–µ—á—å placeholders –∏–∑ –∞–Ω–∫–µ—Ç—ã"""
        return {
            '–†–ï–ì–ò–û–ù': anketa.get('geography', anketa.get('region', '')),
            '–ü–†–û–ë–õ–ï–ú–ê': anketa.get('problem', ''),
            '–¶–ï–õ–ï–í–ê–Ø_–ì–†–£–ü–ü–ê': anketa.get('target_group', ''),
            '–°–§–ï–†–ê': anketa.get('sphere', anketa.get('category', '')),
            '–ü–ï–†–ò–û–î': '2022-2025'
        }

    def _count_sources(self, blocks: List[Dict]) -> int:
        """–ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤"""
        total = 0
        for block in blocks:
            for query in block.get('queries', []):
                total += len(query.get('result', {}).get('sources', []))
        return total

    def _count_quotes(self, blocks: List[Dict]) -> int:
        """–ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏—Ç–∞—Ç"""
        total = 0
        for block in blocks:
            for query in block.get('queries', []):
                total += len(query.get('result', {}).get('quotes', []))
        return total
```

---

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Grant Crew

**–§–∞–π–ª**: `agents/grant_crew.py`

```python
async def process_grant_application(anketa_id: str):
    """–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏"""

    # 1. Auditor
    auditor = AuditorAgent(db)
    audit_result = await auditor.evaluate_project(anketa_id)

    if audit_result['approval_status'] != 'approved':
        return {'status': 'needs_revision', 'auditor': audit_result}

    # 2. Researcher (–ê–í–¢–û–ó–ê–ü–£–°–ö!)
    researcher = ResearcherAgent(db, llm_provider="claude_code")
    research_result = await researcher.research_anketa(anketa_id)

    if research_result['status'] != 'success':
        return {'status': 'research_failed', 'researcher': research_result}

    # 3. Planner
    planner = PlannerAgent(db)
    plan_result = await planner.create_structure(anketa_id)

    # 4. Writer (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç research_results!)
    writer = WriterAgent(db)
    grant_result = await writer.write_grant(
        anketa_id=anketa_id,
        research_id=research_result['research_id']  # ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ!
    )

    return {
        'status': 'success',
        'grant_id': grant_result['grant_id'],
        'research_id': research_result['research_id']
    }
```

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

### **–ë–ï–ó Researcher (—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)**
```
–ì—Ä–∞–Ω—Ç –í–∞–ª–µ—Ä–∏–∏:
- 11,425 —Å–∏–º–≤–æ–ª–æ–≤
- –ù–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- –ù–µ—Ç —Å—Å—ã–ª–æ–∫ –Ω–∞ –†–æ—Å—Å—Ç–∞—Ç/–Ω–∞—Ü–ø—Ä–æ–µ–∫—Ç—ã
- –ù–µ—Ç —É—Å–ø–µ—à–Ω—ã—Ö –∫–µ–π—Å–æ–≤
- –®–∞–Ω—Å—ã –æ–¥–æ–±—Ä–µ–Ω–∏—è: 10-15%
```

### **–° Researcher + WebSearch (—Ü–µ–ª–µ–≤–æ–µ)**
```
–ì—Ä–∞–Ω—Ç:
- 15,000-20,000 —Å–∏–º–≤–æ–ª–æ–≤
- –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (3-5 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)
- –ü—Ä—è–º—ã–µ —Ü–∏—Ç–∞—Ç—ã –∏–∑ –≥–æ—Å–ø—Ä–æ–≥—Ä–∞–º–º (5-7 —Ü–∏—Ç–∞—Ç)
- –£—Å–ø–µ—à–Ω—ã–µ –∫–µ–π—Å—ã (3 –∞–Ω–∞–ª–æ–≥–∞)
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä–Ω—ã–π –º–∞—Ç—á–∏–Ω–≥ (—Ü–µ–ª–∏ ‚Üí KPI –Ω–∞—Ü–ø—Ä–æ–µ–∫—Ç–æ–≤)
- –®–∞–Ω—Å—ã –æ–¥–æ–±—Ä–µ–Ω–∏—è: 40-50% ‚úÖ
```

---

## ‚úÖ –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### **–≠—Ç–∞–ø 1: –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ (1 —á–∞—Å)**
1. –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä –≤ `grant_crew.py`
2. Researcher –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ Auditor approval
3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∞–Ω–∫–µ—Ç–µ –í–∞–ª–µ—Ä–∏–∏

### **–≠—Ç–∞–ø 2: WebSearch –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (2-3 —á–∞—Å–∞)**
1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `_websearch_with_claude()`
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `_research_block1_websearch()` (10 –∑–∞–ø—Ä–æ—Å–æ–≤)
3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –æ–¥–Ω–æ–º –±–ª–æ–∫–µ

### **–≠—Ç–∞–ø 3: –í—Å–µ 27 –∑–∞–ø—Ä–æ—Å–æ–≤ (3-4 —á–∞—Å–∞)**
1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å block2 (10 –∑–∞–ø—Ä–æ—Å–æ–≤)
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å block3 (7 –∑–∞–ø—Ä–æ—Å–æ–≤)
3. –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–º—Ç—ã —ç–∫—Å–ø–µ—Ä—Ç–∞ –≤ –ë–î

### **–≠—Ç–∞–ø 4: Writer –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (1 —á–∞—Å)**
1. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `writer_agent.py`
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `research_results` –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
3. –î–æ–±–∞–≤–∏—Ç—å —Ü–∏—Ç–∞—Ç—ã –∏ —Å—Å—ã–ª–∫–∏ –≤ —Ç–µ–∫—Å—Ç –≥—Ä–∞–Ω—Ç–∞

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

1. ‚úÖ Researcher –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ Auditor
2. ‚úÖ Status –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ 'completed' –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
3. ‚úÖ 27 WebSearch –∑–∞–ø—Ä–æ—Å–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —á–µ—Ä–µ–∑ Claude Code
4. ‚úÖ research_results —Å–æ–¥–µ—Ä–∂–∏—Ç:
   - –§–∞–∫—Ç—ã —Å —Ü–∏—Ñ—Ä–∞–º–∏ (‚â•10)
   - –ü—Ä—è–º—ã–µ —Ü–∏—Ç–∞—Ç—ã (‚â•15)
   - –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (‚â•20)
   - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä–Ω—ã–π –º–∞—Ç—á–∏–Ω–≥ (‚â•3 –≥–æ—Å–ø—Ä–æ–≥—Ä–∞–º–º—ã)
5. ‚úÖ Writer –∏—Å–ø–æ–ª—å–∑—É–µ—Ç research_results –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
6. ‚úÖ –ì—Ä–∞–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ —Å—Å—ã–ª–∫–∏

---

## üìù –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

### **–î–æ–±–∞–≤–∏—Ç—å –≤ ARCHITECTURE.md**

**–†–∞–∑–¥–µ–ª**: "LLM Providers and Tools"

```markdown
## Claude Code API

### Available Tools:
- `/chat` - –ß–∞—Ç —Å Claude (Sonnet/Opus)
- `/code` - –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Python/JavaScript –∫–æ–¥–∞
- `/sessions` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º–∏ —Å–µ—Å—Å–∏—è–º–∏
- `/models` - –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
- **WebSearch** - –ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π tool)

### WebSearch Features:
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–æ–º–µ–Ω–∞–º (allowed_domains)
- –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- –¶–∏—Ç–∞—Ç—ã –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç RU-–∏—Å—Ç–æ—á–Ω–∏–∫–∞–º

### Usage for Researcher Agent:
```python
researcher = ResearcherAgent(db, llm_provider="claude_code")
result = await researcher.research_anketa(anketa_id)
```
```

---

**–°—Ç–∞—Ç—É—Å**: üìã –ü–ª–∞–Ω –≥–æ—Ç–æ–≤
**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**: 6-8 —á–∞—Å–æ–≤
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô (–±–µ–∑ Researcher –∫–∞—á–µ—Å—Ç–≤–æ –≥—Ä–∞–Ω—Ç–æ–≤ –Ω–∏–∑–∫–æ–µ)

