# üìã –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ GrantService

## üìÅ –ü—Ä–æ–µ–∫—Ç—ã
- **GrantService**: `/var/GrantService` - –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç —Å Telegram –±–æ—Ç–æ–º –∏ Streamlit –∞–¥–º–∏–Ω–∫–æ–π
- **datingapp**: `/var/datingapp` - –ø—Ä–æ–µ–∫—Ç-–ø—Ä–∏–º–µ—Ä —Å –≥–æ—Ç–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ GrantService

### –û–±—â–∏–π –ø—Ä–∏–Ω—Ü–∏–ø
1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ Telegram –±–æ—Ç
2. **–ü–µ—Ä–µ–¥–∞—á–∞ —Ç–æ–∫–µ–Ω–∞**: –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É —Å —Ç–æ–∫–µ–Ω–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ, —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω
4. **–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏**: –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–µ—Å—Å–∏—è –≤ Streamlit

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

#### 1. Telegram –±–æ—Ç (`/var/GrantService/telegram-bot/main.py`)
- **–ö–æ–º–∞–Ω–¥–∞ `/login`**: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å (–¥–ª—è –≤—Å–µ—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- **–ö–æ–º–∞–Ω–¥–∞ `/admin`**: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
- **–§—É–Ω–∫—Ü–∏—è `get_or_create_login_token`**: –°–æ–∑–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–§–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏**: `https://admin.grantservice.onff.ru?token=<token>`

#### 2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (`/var/GrantService/data/database/models.py`)
- **–ü–æ–ª–µ `login_token`**: –•—Ä–∞–Ω–∏—Ç —Ç–æ–∫–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ `users`
- **–§—É–Ω–∫—Ü–∏—è `get_or_create_login_token`**: –ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–§—É–Ω–∫—Ü–∏—è `validate_login_token`**: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω
- **–§—É–Ω–∫—Ü–∏—è `refresh_login_token`**: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–§–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞**: `token_<timestamp>_<random_hex>` (–¥–µ–π—Å—Ç–≤—É–µ—Ç 24 —á–∞—Å–∞)

#### 3. Streamlit –∞–¥–º–∏–Ω–∫–∞ (`/var/GrantService/web-admin/`)
- **–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞**: `pages/üîê_–í—Ö–æ–¥.py` - –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ URL –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –µ–≥–æ
- **–ú–æ–¥—É–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**: `utils/auth.py` - —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞**: `st.query_params.get('token', None)`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞**: `validate_login_token(db, token)`
- **–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏**: `st.session_state.auth_token = token`

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö
```mermaid
sequenceDiagram
    participant U as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant B as Telegram –±–æ—Ç
    participant DB as –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
    participant S as Streamlit –∞–¥–º–∏–Ω–∫–∞

    U->>B: /login –∏–ª–∏ /admin
    B->>DB: get_or_create_login_token(user_id)
    DB-->>B: token
    B->>U: –°—Å—ã–ª–∫–∞ —Å —Ç–æ–∫–µ–Ω–æ–º
    U->>S: –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ
    S->>DB: validate_login_token(token)
    DB-->>S: user_data
    S->>S: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
    S->>U: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∫–∏
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –§–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞
```
token_<timestamp>_<random_hex>
```
- **timestamp**: –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è)
- **random_hex**: –°–ª—É—á–∞–π–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞
- **–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è**: 24 —á–∞—Å–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ `timestamp` –∏–∑ —Ç–æ–∫–µ–Ω–∞
2. –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Ç–æ–∫–µ–Ω –Ω–µ –∏—Å—Ç–µ–∫ (—Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è - timestamp < 86400 —Å–µ–∫—É–Ω–¥)
3. –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –ø–æ —Ç–æ–∫–µ–Ω—É
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (`ALLOWED_USERS`, `ADMIN_USERS`)

### –°–µ—Å—Å–∏—è –≤ Streamlit
- **–•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞**: `st.session_state.auth_token`
- **–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: `st.session_state.user`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**: `'auth_token' in st.session_state`

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ú–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
1. **–•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤**: –í –ë–î –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)
2. **–ü–µ—Ä–µ–¥–∞—á–∞ —Ç–æ–∫–µ–Ω–æ–≤**: –ß–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –Ω–∞ —Å–µ—Å—Å–∏–æ–Ω–Ω—ã–µ –∫—É–∫–∏)
3. **–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è**: 24 —á–∞—Å–∞
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤**: –ß–µ—Ä–µ–∑ —Å–ø–∏—Å–∫–∏ `ALLOWED_USERS` –∏ `ADMIN_USERS`

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é:
1. **HTTPS**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Ç–æ–∫–µ–Ω–æ–≤
2. **–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –•—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –≤ –≤–∏–¥–µ —Ö–µ—à–µ–π
3. **–ö—É–∫–∏**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏–æ–Ω–Ω—ã–µ –∫—É–∫–∏ –≤–º–µ—Å—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL
4. **OAuth2**: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é OAuth2 –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é

## üìà –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥—Ö–æ–¥–∞
1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ datingapp
2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –¢–æ–∫–µ–Ω—ã —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º —Å—Ä–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏—è
3. **–£–¥–æ–±—Å—Ç–≤–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**: –ü—Ä–æ—Å—Ç–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫—É
4. **–ì–∏–±–∫–æ—Å—Ç—å**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è (—Ä–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –¥–æ—Å—Ç—É–ø–∞)

## ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è
1. **–ü–µ—Ä–µ—Ö–≤–∞—Ç —Ç–æ–∫–µ–Ω–∞**: 
   - –†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS, —É–º–µ–Ω—å—à–∏—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞

2. **–£—Ç–µ—á–∫–∞ —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ –ª–æ–≥–∏/referrer**:
   - –†–µ—à–µ–Ω–∏–µ: –ù–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å meta —Ç–µ–≥–∏ –¥–ª—è –∑–∞–ø—Ä–µ—Ç–∞ referrer

3. **–ü–µ—Ä–µ–±–æ—Ä —Ç–æ–∫–µ–Ω–æ–≤**:
   - –†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–∏–µ —Ç–æ–∫–µ–Ω—ã, –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫

## üìö –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã
- `/var/datingapp/telegram_bot/main.py` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- `/var/datingapp/shared/database.py` - —Ä–∞–±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –≤ –ë–î
- `/var/datingapp/user_panel/app.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –≤ Streamlit
- `/var/GrantService/telegram-bot/main.py` - —Ç–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –±–æ—Ç–µ
- `/var/GrantService/telegram-bot/config/constants.py` - —Å–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `/var/GrantService/data/database/models.py` - —Ä–∞–±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –≤ –ë–î
- `/var/GrantService/web-admin/pages/üîê_–í—Ö–æ–¥.py` - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞ –≤ –∞–¥–º–∏–Ω–∫—É
- `/var/GrantService/web-admin/utils/auth.py` - –º–æ–¥—É–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏