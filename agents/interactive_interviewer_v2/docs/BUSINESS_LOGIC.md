# Бизнес-Логика InteractiveInterviewerAgentV2

**Версия:** 2.0 (Reference Points Framework)
**Статус:** Production
**Дата:** 2025-10-27

---

## Оглавление

1. [Обзор](#обзор)
2. [Как Работает Интервью](#как-работает-интервью)
3. [Reference Points Framework](#reference-points-framework)
4. [State Machine - Фазы Диалога](#state-machine---фазы-диалога)
5. [Адаптивная Генерация Вопросов](#адаптивная-генерация-вопросов)
6. [Интеграция с Базой Знаний (Qdrant)](#интеграция-с-базой-знаний-qdrant)
7. [Сохранение в Базу Данных](#сохранение-в-базу-данных)
8. [Workflow: От Старта до Финиша](#workflow-от-старта-до-финиша)
9. [Примеры Диалогов](#примеры-диалогов)
10. [Ключевые Принципы](#ключевые-принципы)

---

## Обзор

**InteractiveInterviewerAgentV2** - это AI-агент для проведения адаптивных интервью с заявителями грантовых заявок.

### Что Делает Агент?

**Цель:** Собрать информацию о проекте заявителя для последующей генерации грантовой заявки.

**Как:** Ведёт естественный диалог с пользователем, задавая вопросы о проекте, команде, бюджете, целевой аудитории и других критически важных аспектах.

**Результат:** Заполненная анкета (anketa.txt) с ответами пользователя на 10-15 вопросов.

### Почему V2?

Версия 2 использует **Reference Points Framework** вместо жёстко заданных вопросов:

- **V1:** 10 фиксированных вопросов в строгой последовательности
- **V2:** Адаптивные вопросы, генерируемые на основе контекста и ответов пользователя

---

## Как Работает Интервью

### Общая Схема

```
┌─────────────────────────────────────────────────────────────┐
│  ПОЛЬЗОВАТЕЛЬ (Telegram Bot)                                 │
│  Нажимает "Начать интервью"                                  │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│  АГЕНТ ИНТЕРВЬЮЕР V2                                         │
│  ┌───────────────────────────────────────────────────┐      │
│  │ 1. INIT - Приветствие                             │      │
│  │    "Привет! Давай заполним анкету для гранта"     │      │
│  └───────────────────────────────────────────────────┘      │
│                 │                                             │
│                 v                                             │
│  ┌───────────────────────────────────────────────────┐      │
│  │ 2. EXPLORING - Исследование проекта               │      │
│  │    - Название проекта?                            │      │
│  │    - Цель проекта?                                │      │
│  │    - Проблема, которую решаете?                   │      │
│  │    (базовые Reference Points)                     │      │
│  └───────────────────────────────────────────────────┘      │
│                 │                                             │
│                 v                                             │
│  ┌───────────────────────────────────────────────────┐      │
│  │ 3. DEEPENING - Углубление (при необходимости)     │      │
│  │    - Уточняющие вопросы (follow-up)               │      │
│  │    - Максимум 5 уточнений                         │      │
│  │    - Только если ответ неполный                   │      │
│  └───────────────────────────────────────────────────┘      │
│                 │                                             │
│                 v                                             │
│  ┌───────────────────────────────────────────────────┐      │
│  │ 4. VALIDATING - Валидация (опционально)           │      │
│  │    - Проверка понимания                           │      │
│  │    - "Правильно ли я понял, что..."               │      │
│  └───────────────────────────────────────────────────┘      │
│                 │                                             │
│                 v                                             │
│  ┌───────────────────────────────────────────────────┐      │
│  │ 5. FINALIZING - Завершение                        │      │
│  │    - Собрать анкету                               │      │
│  │    - Сохранить в БД                               │      │
│  │    - Отправить пользователю                       │      │
│  └───────────────────────────────────────────────────┘      │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│  РЕЗУЛЬТАТ: anketa.txt + сохранено в БД                      │
└─────────────────────────────────────────────────────────────┘
```

### Ключевые Компоненты

1. **ReferencePointManager** - управляет коллекцией Reference Points (что нужно узнать)
2. **ConversationFlowManager** - управляет потоком диалога (state machine)
3. **AdaptiveQuestionGenerator** - генерирует вопросы на основе контекста
4. **UnifiedLLMClient** - интерфейс к LLM (GigaChat / Claude)
5. **QdrantClient** - векторная база знаний ФПГ (опционально)

---

## Reference Points Framework

### Что Такое Reference Point?

**Reference Point** - это информационная точка, которую нужно получить от заявителя.

Не "вопрос", а **цель** - что именно мы хотим узнать.

### Структура Reference Point

```python
{
    "id": "project_goal",
    "name": "Цель проекта",
    "description": "Что хотят достичь, зачем нужен проект",
    "priority": "P0",  # P0 = критично, P1 = важно, P2 = полезно, P3 = бонус
    "state": "not_started",  # not_started → in_progress → completed
    "completion_confidence": 0.0,  # 0-1, насколько полно собрана информация
    "data": {}  # Собранные данные
}
```

### Приоритеты Reference Points

**P0 - Критично (MUST HAVE):**
- Название проекта
- Цель проекта
- Описание проблемы
- Целевая аудитория
- Бюджет

Эти RP ОБЯЗАТЕЛЬНО должны быть заполнены, иначе анкета неполная.

**P1 - Важно (SHOULD HAVE):**
- Методология реализации
- Команда проекта
- Ожидаемые результаты
- Устойчивость проекта

**P2 - Полезно (NICE TO HAVE):**
- Партнёры проекта
- Риски
- Структура бюджета (детальная)

**P3 - Бонус (OPTIONAL):**
- Дополнительные детали
- Контекстная информация

### Логика Работы с Reference Points

1. **Загрузка:** При старте агент загружает 11 ФПГ Reference Points
2. **Приоритизация:** Сначала обрабатываются P0, потом P1, потом P2, потом P3
3. **Зависимости:** Некоторые RP зависят друг от друга (например, "Структура бюджета" зависит от "Общий бюджет")
4. **Completion:** RP считается завершённым когда `completion_confidence >= 0.7`
5. **Прогресс:** Интервью завершается когда:
   - Все P0 завершены
   - Все P1 завершены (по возможности)
   - ИЛИ достигнут лимит вопросов (30)

---

## State Machine - Фазы Диалога

Агент использует **state machine** для управления потоком разговора.

### 5 Состояний (States)

#### 1. INIT - Инициализация
**Цель:** Познакомиться с пользователем, объяснить процесс

**Что происходит:**
- Приветствие
- Объяснение процесса ("Я задам вам вопросы о вашем проекте")
- Переход к EXPLORING

**Длительность:** 1 сообщение

---

#### 2. EXPLORING - Исследование
**Цель:** Собрать базовую информацию по всем критичным RP

**Что происходит:**
- Задаём вопросы по Reference Points в порядке приоритета (P0 → P1 → P2)
- Один вопрос = один RP
- Сохраняем ответы в RP.data
- Отмечаем RP как completed когда получен достаточно полный ответ

**Пример вопросов:**
- "Как называется ваш проект?"
- "Какую цель вы преследуете?"
- "Какую проблему решает ваш проект?"
- "Кто ваша целевая аудитория?"

**Длительность:** 10-12 вопросов

**Переход к DEEPENING:** Если какой-то ответ неполный и есть бюджет на follow-up

**Переход к VALIDATING:** Если все базовые вопросы заданы

---

#### 3. DEEPENING - Углубление
**Цель:** Уточнить неполные или неясные ответы

**Что происходит:**
- Анализируем ответы пользователя
- Находим Reference Points с низким `completion_confidence` (< 0.7)
- Задаём уточняющие вопросы (follow-up)
- **Лимит:** Максимум 5 уточняющих вопросов за всё интервью

**Пример follow-up вопросов:**
- "Вы сказали, что хотите помочь школьникам. А сколько школьников планируете охватить?"
- "Интересный проект! Расскажите подробнее про команду - кто будет реализовывать?"
- "Какой бюджет вы планируете? Хотя бы примерно."

**Длительность:** 0-5 вопросов (зависит от качества ответов)

**Переход к EXPLORING:** Вернуться к базовым вопросам если остались незаданные

**Переход к VALIDATING:** Если все критичные RP заполнены

---

#### 4. VALIDATING - Валидация
**Цель:** Убедиться что правильно поняли пользователя

**Что происходит:**
- (Опционально) Показываем краткую сводку собранной информации
- Спрашиваем: "Всё верно? Что-то добавить?"

**В текущей версии:** Этот state ПРОПУСКАЕТСЯ (не используется в production)

**Длительность:** 0 вопросов

**Переход к FINALIZING:** Сразу завершаем

---

#### 5. FINALIZING - Финализация
**Цель:** Собрать анкету и сохранить в БД

**Что происходит:**
- Собираем все ответы из Reference Points
- Форматируем в структуру анкеты
- Сохраняем в базу данных (session.interview_data)
- Генерируем anketa.txt файл
- Отправляем пользователю

**Что НЕ происходит:**
- ❌ Аудит НЕ запускается автоматически (Iteration 53 fix)
- ❌ Не задаём дополнительных вопросов

**Длительность:** 1-2 секунды (сохранение в БД)

---

### Переходы Между Состояниями

```
INIT
  ↓
EXPLORING ←─────┐
  ↓             │ (loop back if needed)
  ├→ DEEPENING ─┘
  ↓
VALIDATING (skipped)
  ↓
FINALIZING
```

---

## Адаптивная Генерация Вопросов

### Как Генерируются Вопросы?

Агент НЕ использует шаблоны вопросов. Вопросы генерируются **на лету** на основе:

1. **Reference Point** - что нужно узнать
2. **Контекст диалога** - что уже было сказано
3. **История ответов** - предыдущие ответы пользователя
4. **База знаний ФПГ** - релевантные секции из Qdrant (опционально)

### Промпт для Генерации Вопроса

```python
prompt = f"""
Ты - эксперт по грантам. Задай вопрос заявителю.

ЦЕЛЬ: Узнать "{rp.name}" - {rp.description}

КОНТЕКСТ:
- Уже знаем: {covered_topics}
- Последний ответ: {last_answer}
- Приоритет: {rp.priority}

ТРЕБОВАНИЯ:
1. Вопрос должен быть естественным и дружелюбным
2. НЕ повторяй то, что уже было сказано
3. Если пользователь уже ответил на этот вопрос - сформулируй иначе
4. Будь кратким (1-2 предложения)

ВОПРОС:
"""
```

### LLM Генерирует Вопрос

**Используется:** GigaChat-Max (primary) или Claude Code (fallback)

**Температура:** 0.7 (немного креативности)

**Макс токенов:** 150

**Результат:** Естественный вопрос на русском языке

**Пример:**
- RP: "project_budget"
- Контекст: Пользователь рассказал про проект для школьников
- Вопрос: "Отлично! А какой бюджет вы планируете для проекта со школьниками? Хотя бы примерно."

---

## Интеграция с Базой Знаний (Qdrant)

### Зачем Нужна База Знаний?

**Qdrant** - векторная база данных с секциями руководства ФПГ (Фонд Президентских Грантов).

**Цель:** Обогатить контекст вопроса знаниями о том, что важно для ФПГ.

### Как Работает?

1. **При генерации вопроса:**
   - Делаем запрос в Qdrant: "project goal fpg requirements"
   - Получаем 3-5 релевантных секций из руководства ФПГ
   - Добавляем в промпт: "Важно для ФПГ: {qdrant_context}"

2. **LLM использует контекст:**
   - Формулирует вопрос с учётом требований ФПГ
   - Например: "Опишите КОНКРЕТНЫЕ измеримые результаты проекта" (вместо просто "какие результаты?")

### Опционально

Qdrant **опционален** - если подключение не удалось, агент работает без него.

**Если Qdrant доступен:**
- Вопросы более точные и соответствуют требованиям ФПГ
- Качество анкеты выше

**Если Qdrant недоступен:**
- Используется fallback - вопросы без контекста ФПГ
- Всё равно работает нормально, просто менее оптимально

---

## Сохранение в Базу Данных

### Где Хранится Информация?

**Таблица:** `sessions`

**Поля:**
- `id` - уникальный ID сессии
- `telegram_id` - ID пользователя в Telegram
- `anketa_id` - уникальный ID анкеты (формат: `anketa_{session_id}_{timestamp}`)
- `project_name` - название проекта
- `interview_data` (JSONB) - **ВСЕ ОТВЕТЫ** пользователя
- `answers_data` (JSONB) - форматированные ответы для анкеты
- `completion_status` - статус ("completed", "in_progress", "pending")
- `started_at` - время начала
- `completed_at` - время завершения

### Когда Сохраняется?

**ВАЖНО:** Сохранение происходит **ПОСЛЕ КАЖДОГО ОТВЕТА**!

Это критично для production - если бот упадёт, данные не потеряются.

```python
# После каждого ответа пользователя:
1. Сохранить ответ в RP.data
2. Обновить session.interview_data в БД
3. Продолжить интервью
```

### Workflow Сохранения

```
Пользователь отвечает
  ↓
Сохранить в RP.data (in-memory)
  ↓
Обновить interview_data в БД ← КРИТИЧНО!
  ↓
Продолжить интервью
  ↓
... (после всех вопросов)
  ↓
Финализировать анкету
  ↓
Сохранить финальную версию в БД
  ↓
Отправить пользователю
```

---

## Workflow: От Старта до Финиша

### Пошаговый Сценарий

#### Шаг 1: Пользователь Нажимает "Начать Интервью"

**Telegram Handler:**
```python
# telegram-bot/main.py
async def handle_start_interview(update, context):
    telegram_id = update.effective_user.id

    # 1. Создать session в БД
    session_id = db.create_session(telegram_id)

    # 2. Отправить приветствие
    await update.message.reply_text(
        "Привет! Я помогу заполнить анкету для гранта.\n"
        "Отвечайте на вопросы, и я соберу всё необходимое."
    )

    # 3. Запустить агента интервьюера
    agent = InteractiveInterviewerAgentV2(db, llm_provider="gigachat")
    result = await agent.conduct_interview(
        user_data={'telegram_id': telegram_id, 'session_id': session_id},
        callback_ask_question=ask_question_callback
    )

    # 4. Отправить анкету пользователю
    anketa_txt = generate_anketa_txt(result['anketa'])
    await send_document(update, "anketa.txt", anketa_txt)
```

---

#### Шаг 2: Агент Задаёт Вопросы

**Conversation Loop:**

```python
# agents/interactive_interviewer_v2/agent.py
async def _conversation_loop(user_data, callback_ask_question):
    turn = 1
    max_turns = 30

    while turn <= max_turns:
        # 1. Определить следующее действие
        action = flow_manager.decide_next_action()

        # 2. Проверить финализацию
        if action['type'] == 'finalize':
            break

        # 3. Получить Reference Point
        rp = action['reference_point']

        # 4. Сгенерировать вопрос
        question = await generate_question_for_rp(rp, context)

        # 5. Задать вопрос пользователю (через callback)
        answer = await callback_ask_question(question)

        # 6. Сохранить ответ в RP
        rp.add_data('text', answer)

        # 7. Сохранить в БД ← КРИТИЧНО!
        await save_to_database(session_id, rp.id, answer)

        # 8. Обновить состояние
        if is_complete(rp):
            rp_manager.mark_completed(rp.id)

        turn += 1

    # Финализация
    anketa = collect_anketa_from_rps()
    return anketa
```

---

#### Шаг 3: Callback Спрашивает Пользователя

```python
async def ask_question_callback(question: str) -> str:
    """
    Callback функция для задавания вопросов через Telegram.

    Workflow:
    1. Отправить вопрос в Telegram
    2. Ждать ответа от пользователя
    3. Вернуть ответ агенту
    """

    # 1. Отправить вопрос
    await bot.send_message(
        chat_id=telegram_id,
        text=question
    )

    # 2. Ждать ответа (через queue)
    answer = await wait_for_user_response(telegram_id, timeout=300)

    # 3. Вернуть ответ
    return answer
```

---

#### Шаг 4: Финализация и Отправка

```python
# После завершения интервью:

# 1. Собрать анкету из Reference Points
anketa = {
    'anketa_id': f"anketa_{session_id}_{timestamp}",
    'project_name': rp_manager.get_data('project_name'),
    'answers_data': {
        'Цель проекта': rp_manager.get_data('project_goal'),
        'Описание проблемы': rp_manager.get_data('problem_description'),
        'Целевая аудитория': rp_manager.get_data('target_audience'),
        # ... все остальные RP
    }
}

# 2. Сохранить финальную версию в БД
db.update_session(session_id, {
    'completion_status': 'completed',
    'interview_data': anketa['answers_data'],
    'completed_at': datetime.now()
})

# 3. Сгенерировать anketa.txt
anketa_txt = generate_anketa_txt(anketa)

# 4. Отправить пользователю
await bot.send_document(
    chat_id=telegram_id,
    document=anketa_txt,
    filename="anketa.txt",
    caption="Анкета готова! Проверьте и нажмите 'Начать аудит'"
)

# 5. Показать кнопки
await bot.send_message(
    chat_id=telegram_id,
    text="Что дальше?",
    reply_markup=InlineKeyboardMarkup([
        [InlineKeyboardButton("Начать аудит", callback_data="start_audit")],
        [InlineKeyboardButton("Редактировать", callback_data="edit_anketa")]
    ])
)
```

---

## Примеры Диалогов

### Пример 1: Стандартное Интервью (Проект для Школьников)

```
[АГЕНТ] Привет! Я помогу заполнить анкету для гранта. Отвечайте на вопросы, и я соберу всё необходимое.

[АГЕНТ] Как называется ваш проект?

[USER] Стрельба из лука для школьников

[АГЕНТ] Отлично! Какую цель вы преследуете этим проектом?

[USER] Хотим приобщить детей и молодёжь к стрельбе из лука, к здоровому и спортивному образу жизни, повысить патриотическое воспитание молодого поколения.

[АГЕНТ] Замечательно! А какую проблему решает ваш проект?

[USER] Уроки физры не могут в полной мере привлечь детей к спорту, мало эффективных программ к массовому привлечению детей к здоровому образу жизни.

[АГЕНТ] Кто ваша целевая аудитория?

[USER] Дети и молодёжь 10-21 лет. Школьники, студенты.

[АГЕНТ] Какой бюджет вы планируете?

[USER] 750000 рублей

[АГЕНТ] Расскажите про вашу команду - кто будет реализовывать проект?

[USER] Клуб "Луки и стрелы", наши тренеры и волонтёры

[АГЕНТ] Как вы планируете реализовать проект? Какие мероприятия?

[USER] Организуем мастер-классы, проведём информационную кампанию, проведём турниры

[АГЕНТ] Какие результаты вы ожидаете?

[USER] Спортивно-патриотическое воспитание детей и молодежи, пропаганда здорового образа жизни

[АГЕНТ] Есть ли у вас партнёры?

[USER] Да, Лига стрельбы из лука Кемерово, Федерация стрельбы из лука Кузбасса

[АГЕНТ] Как проект будет работать после окончания гранта?

[USER] Лучный клуб готов и дальше работать над развитием навыков стрельбы из лука у детей и молодёжи

[АГЕНТ] Есть ли риски у проекта?

[USER] Риск что не дадут денег

[АГЕНТ] Отлично! Я собрал всю информацию. Формирую анкету...

[СИСТЕМА] Анкета готова! (отправляет файл anketa.txt)
```

**Результат:**
- Задано: 11 вопросов
- Время: ~45 секунд
- Все P0 и P1 Reference Points заполнены
- Анкета готова к аудиту

---

### Пример 2: Интервью с Follow-Up (Углубление)

```
[АГЕНТ] Как называется ваш проект?

[USER] AI помощник

[АГЕНТ] Какую цель вы преследуете?

[USER] Помочь людям

[АГЕНТ] Интересно! А кому именно хотите помочь? Какая целевая аудитория?

[USER] Студентам

[АГЕНТ] Хорошо, студенты. А какую именно проблему студентов решает ваш AI помощник? ← FOLLOW-UP!

[USER] Помогает писать курсовые работы, собирает информацию, структурирует материал

[АГЕНТ] Понятно! А сколько студентов планируете охватить? ← FOLLOW-UP!

[USER] Примерно 500 студентов в первый год

[АГЕНТ] Отлично! Теперь понятна картина. Какой бюджет вы планируете?

...
```

**Что произошло:**
- После неполного ответа ("Помочь людям") агент задал **follow-up** вопросы
- Собрал более детальную информацию
- Использовал 2 из 5 доступных follow-up вопросов
- Перешёл к следующему RP только когда получил достаточно информации

---

## Ключевые Принципы

### 1. Database-First

**Правило:** Каждый ответ сохраняется в БД немедленно.

**Почему:** Защита от сбоев. Если бот упадёт - данные не потеряются.

**Как:** После каждого ответа → `db.update_session(interview_data)`

---

### 2. Адаптивность

**Правило:** Вопросы генерируются на основе контекста, а не шаблонов.

**Почему:** Естественный диалог, учитывающий предыдущие ответы.

**Как:** LLM генерирует вопросы с учётом истории диалога.

---

### 3. Приоритизация

**Правило:** Сначала P0 (критично), потом P1 (важно), потом P2 (полезно).

**Почему:** Гарантия что критичная информация будет собрана даже если пользователь уйдёт.

**Как:** Reference Points сортируются по priority перед обработкой.

---

### 4. Бюджет Уточнений

**Правило:** Максимум 5 follow-up вопросов за всё интервью.

**Почему:** Не утомлять пользователя, держать интервью коротким (10-15 вопросов).

**Как:** `ConversationContext.follow_ups_asked` отслеживается, проверяется перед каждым follow-up.

---

### 5. Graceful Degradation

**Правило:** Система работает даже если что-то отключено (Qdrant, LLM fallback).

**Почему:** Production readiness - не падать если сервис недоступен.

**Как:**
- Qdrant недоступен → используем вопросы без контекста
- GigaChat недоступен → переключаемся на Claude
- LLM недоступен → используем fallback bank вопросов

---

### 6. Completion Confidence

**Правило:** RP считается завершённым когда `completion_confidence >= 0.7`

**Почему:** Оценка качества ответа - не все ответы одинаково полные.

**Как:** После получения ответа LLM оценивает полноту (0-1), если < 0.7 → может задать follow-up.

---

## Метрики Production

**Среднее время интервью:** 45-60 секунд

**Среднее количество вопросов:** 10-13

**Follow-up вопросов:** 1-3 (из 5 доступных)

**Успешность завершения:** 95%+ (почти все интервью завершаются)

**Качество анкет:** Audit score 40-60/100 (средний уровень)

---

## Чем Отличается от V1?

| Аспект | V1 (Старая) | V2 (Текущая) |
|--------|------------|--------------|
| **Вопросы** | 10 фиксированных | Адаптивные (10-15) |
| **Генерация** | Шаблоны | LLM на лету |
| **Последовательность** | Жёсткая | Гибкая (state machine) |
| **Follow-up** | Нет | Да (до 5) |
| **Контекст** | Нет | Да (Qdrant + история) |
| **Сохранение** | В конце | После каждого ответа |
| **Приоритизация** | Нет | Да (P0-P3) |
| **Адаптация** | Нет | Да (зависит от ответов) |

---

**Дата:** 2025-10-27
**Версия:** 2.0
**Автор:** Grant Service Team
**Статус:** Production ✅
