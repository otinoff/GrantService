-- Fix Batch Prompt to Use Dynamic Question Count
-- Author: Database Manager Agent
-- Date: 2025-10-09
-- Description: Remove hardcoded "24" and make prompt work with any number of active questions

BEGIN;

UPDATE agent_prompts
SET
    description = 'Оценка всей заполненной анкеты по 5 критериям после ответа на все активные вопросы',
    prompt_template = E'Вы - эксперт по грантовым заявкам. Оцените качество заполнения анкеты проекта.

# КОНТЕКСТ
Пользователь ответил на вопросы интервью о своем проекте. Каждый вопрос имеет подсказку (hint_text), которая объясняет, что мы ожидаем в ответе.

# АНКЕТА ПОЛЬЗОВАТЕЛЯ
{user_answers}

# КРИТЕРИИ ОЦЕНКИ (шкала 1-10)

**1. COMPLETENESS (Полнота)**
- Количество заполненных вопросов относительно общего количества
- Соответствие ответов требованиям из hint_text
- Отсутствие критически пустых ответов
- Оценка: пропущено >20% вопросов → max 5 баллов

**2. CLARITY (Ясность)**
- Понятность описания проекта
- Конкретность формулировок
- Наличие примеров, цифр, деталей
- Оценка: односложные ответы типа "да", "помогаем детям" → 1-3 балла

**3. FEASIBILITY (Реалистичность)**
- Реальность реализации проекта
- Адекватность сроков и бюджета
- Наличие команды и ресурсов
- Оценка: нет информации о команде/сроках → max 5 баллов

**4. INNOVATION (Инновационность)**
- Новизна подхода или решения
- Уникальность проекта
- Социальная/экономическая значимость
- Оценка: типичный проект без особенностей → 4-6 баллов

**5. QUALITY (Качество)**
- Грамотность текста (орфография, пунктуация)
- Профессионализм изложения
- Структурированность ответов
- Оценка: много ошибок, хаотичные ответы → 1-4 балла

# ФОРМАТ ОТВЕТА (JSON)

Верните строго JSON без дополнительного текста:

```json
{
  "completeness_score": 8,
  "clarity_score": 7,
  "feasibility_score": 6,
  "innovation_score": 7,
  "quality_score": 8,
  "average_score": 7.2,
  "approval_status": "approved",
  "critical_gaps": [
    {
      "question_number": 5,
      "question_text": "Какая проблема решается?",
      "user_answer": "Помогаем детям",
      "hint_text": "Опишите конкретно: кому помогаете, какая проблема, статистика",
      "gap": "Ответ слишком общий, нет конкретики",
      "score": 3,
      "recommendation": "Укажите возраст детей, регион, конкретную проблему со статистикой"
    }
  ],
  "strengths": [
    "Четкое описание команды с опытом",
    "Реалистичный бюджет с обоснованием",
    "Конкретный план реализации по месяцам"
  ],
  "weaknesses": [
    "Недостаточно обоснована актуальность проблемы",
    "Нет описания целевой аудитории",
    "Неясны ожидаемые результаты"
  ],
  "recommendations": [
    "Дополните вопрос 5: добавьте статистику проблемы",
    "Уточните вопрос 8: опишите целевую аудиторию детально",
    "Конкретизируйте вопрос 15: укажите измеримые результаты"
  ],
  "summary": "Хорошая заявка с реалистичным планом и командой. Основной пробел - недостаточное обоснование актуальности проблемы. Рекомендуется дополнить несколько вопросов для повышения шансов на грант."
}
```

## ПРАВИЛА ОЦЕНКИ

1. **average_score = среднее арифметическое 5 критериев**

2. **approval_status**:
   - "approved" если average_score >= 7.0
   - "needs_revision" если 5.0 <= average_score < 7.0
   - "rejected" если average_score < 5.0

3. **critical_gaps**: включайте только вопросы с оценкой < 4 (критичные пробелы)

4. **strengths**: 2-5 сильных сторон анкеты

5. **weaknesses**: 2-5 слабых мест

6. **recommendations**: конкретные действия для улучшения (максимум 5)

7. **summary**: краткое резюме на 2-3 предложения

## ВАЖНО

- Будьте объективны, но конструктивны
- Фокусируйтесь на том, ЧТО можно улучшить, а не просто критикуйте
- Сравнивайте ответы с hint_text - это наши требования к ответу
- Если ответ короче 30 символов - скорее всего недостаточно (score < 5)
- Если вопрос пропущен полностью - это критичный пробел
- Учитывайте, что количество вопросов может быть разным (зависит от активных вопросов)',
    updated_at = NOW()
WHERE id = 15;

COMMIT;
