# CI/CD Improvements - GitHub Actions

**–î–∞—Ç–∞**: 2025-10-04
**–í–µ—Ä—Å–∏—è**: 2.0
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

---

## üéØ –ß—Ç–æ –±—ã–ª–æ —É–ª—É—á—à–µ–Ω–æ

### 1. ‚úÖ Pre-deployment —Ç–µ—Å—Ç—ã (–∫—Ä–∏—Ç–∏—á–Ω–æ!)

**–î–æ**: –ö–æ–¥ –¥–µ–ø–ª–æ–∏–ª—Å—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
**–ü–æ—Å–ª–µ**: –ó–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –ü–ï–†–ï–î –¥–µ–ø–ª–æ–µ–º

```yaml
test:
  runs-on: ubuntu-latest
  steps:
    - Run 3 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–∞
    - test_complete_application_flow
    - test_get_total_users
    - test_can_connect_to_postgresql
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã 1 —Ç–µ—Å—Ç —É–ø–∞–ª - –¥–µ–ø–ª–æ–π –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è ‚ùå

---

### 2. üöÄ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ì—Ä—É–ø–ø–∞**: -4930683040 (–ì—Ä–∞–Ω—Ç—Å–µ—Ä–≤–∏—Å)

**–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**:
- üöÄ **Deployment started** - –Ω–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è (–ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤)
- ‚úÖ **Deployment success** - —É—Å–ø–µ—à–Ω—ã–π –¥–µ–ø–ª–æ–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚ùå **Tests failed** - —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏, –¥–µ–ø–ª–æ–π –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
- ‚ùå **Deployment failed** - –¥–µ–ø–ª–æ–π —É–ø–∞–ª, –≤—ã–ø–æ–ª–Ω–µ–Ω rollback

**–ü—Ä–∏–º–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**:
```
‚úÖ GrantService Deployment SUCCESS

üì¶ Branch: master
üí¨ Commit: fix: update database schema
üë§ Author: otinoff

ü§ñ Bot: Running
üíª Admin: Running
üåê HTTPS: OK

‚è± Deploy time: ~30s
```

---

### 3. üß™ Smoke tests –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏**:
- ‚úÖ Bot service is running
- ‚úÖ Admin service is running
- ‚úÖ HTTP endpoint (port 8550): 200 OK
- ‚úÖ HTTPS endpoint: 200 OK
- ‚úÖ Database connectivity
- ‚úÖ Bot token is not placeholder

**–ï—Å–ª–∏ —Ö–æ—Ç—å –æ–¥–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–ø–∞–ª–∞** ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback

---

### 4. üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback

**–î–æ**: –ü—Ä–∏ –æ—à–∏–±–∫–µ –¥–µ–ø–ª–æ—è —Å–µ—Ä–≤–∏—Å—ã –ª–æ–º–∞–ª–∏—Å—å, –Ω—É–∂–µ–Ω –±—ã–ª manual fix
**–ü–æ—Å–ª–µ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–æ–º–º–∏—Ç—É

```bash
# Rollback sequence:
1. git reset --hard HEAD~1
2. Clear Python cache
3. Restart services
4. Verify services are running
5. Notify in Telegram
```

---

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–ª—è –∑–∞–ø—É—Å–∫–∞

### –®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å GitHub Secret

–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–¥–∏–Ω —Å–µ–∫—Ä–µ—Ç: `TELEGRAM_BOT_TOKEN`

**–í–∞—Ä–∏–∞–Ω—Ç 1 - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±–æ—Ç**:
```bash
# SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh root@5.35.88.251

# –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω
cat /var/GrantService/config/.env | grep TELEGRAM_BOT_TOKEN
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
```

**–í–∞—Ä–∏–∞–Ω—Ç 2 - –ß–µ—Ä–µ–∑ GitHub CLI**:
```bash
# –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω: 7686393933:AAG_example_token_here
gh secret set TELEGRAM_BOT_TOKEN --body "7686393933:AAG_example_token_here"
```

**–í–∞—Ä–∏–∞–Ω—Ç 3 - –ß–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**:
1. GitHub ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions
2. New repository secret
3. Name: `TELEGRAM_BOT_TOKEN`
4. Value: `<–≤—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω>`
5. Add secret

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –±–æ—Ç –≤ –≥—Ä—É–ø–ø–µ

```bash
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
curl -X POST "https://api.telegram.org/bot<TOKEN>/sendMessage" \
  -d "chat_id=-4930683040" \
  -d "text=CI/CD test notification"
```

–î–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É "–ì—Ä–∞–Ω—Ç—Å–µ—Ä–≤–∏—Å".

### –®–∞–≥ 3: –ö–æ–º–º–∏—Ç –∏ push

```bash
git add .github/workflows/deploy-grantservice.yml
git add .github/SETUP_SECRETS.md
git add CI_CD_IMPROVEMENTS.md

git commit -m "feat: Optimize CI/CD with tests, notifications and auto-rollback

- Add pre-deployment integration tests (blocks deploy if failed)
- Add smoke tests after deployment (HTTP, HTTPS, services)
- Add Telegram notifications to group -4930683040
- Add automatic rollback on deployment failure
- Update workflow documentation

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

git push origin master
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–ø–ª–æ–π

1. –ü–µ—Ä–µ–π—Ç–∏ –≤ GitHub ‚Üí Actions
2. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–ø—É—â–µ–Ω–Ω—ã–π workflow
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–∏—à–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram

---

## üìä –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–µ–ø–ª–æ—è

### –í–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å (–µ—Å–ª–∏ –≤—Å—ë –û–ö):

```
1. Push –≤ GitHub
   ‚Üì
2. GitHub Actions –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
   ‚Üì
3. JOB: test
   ‚îú‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
   ‚îú‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
   ‚îú‚îÄ –ó–∞–ø—É—Å–∫ 3 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
   ‚îî‚îÄ ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏
   ‚Üì
4. JOB: deploy (runs only if tests pass)
   ‚îú‚îÄ üì± –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: "Deployment started"
   ‚îú‚îÄ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
   ‚îú‚îÄ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
   ‚îú‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
   ‚îú‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
   ‚îú‚îÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
   ‚îú‚îÄ Smoke tests (6 –ø—Ä–æ–≤–µ—Ä–æ–∫)
   ‚îî‚îÄ ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–ª–∏
   ‚Üì
5. üì± –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: "Deployment SUCCESS"
```

### –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:

```
1. –¢–µ—Å—Ç—ã —É–ø–∞–ª–∏
   ‚Üì
2. üì± –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: "Tests FAILED - deployment blocked"
   ‚Üì
3. –î–µ–ø–ª–æ–π –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
```

**–ò–õ–ò**

```
1. –î–µ–ø–ª–æ–π –ø—Ä–æ—à–µ–ª, –Ω–æ smoke tests —É–ø–∞–ª–∏
   ‚Üì
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback
   ‚îú‚îÄ git reset --hard HEAD~1
   ‚îú‚îÄ Restart services
   ‚îî‚îÄ Verify services running
   ‚Üì
3. üì± –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: "Deployment FAILED - rollback executed"
```

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- ‚ùå –ù–µ–ª—å–∑—è –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å –∫–æ–¥ —Å —É–ø–∞–≤—à–∏–º–∏ —Ç–µ—Å—Ç–∞–º–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å
- ‚úÖ –í—Å–µ–≥–¥–∞ –µ—Å—Ç—å working version (–ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–º–º–∏—Ç)

### –°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏:
- ‚è± –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
- üìä –°—Ä–∞–∑—É –≤–∏–¥–Ω–æ —Å—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è
- üîç –°—Å—ã–ª–∫–∞ –Ω–∞ –ª–æ–≥–∏ –≤ GitHub Actions

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:
- üß™ 6 smoke tests –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–µ–ø–ª–æ—è
- üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (token, DB, HTTP)
- üìà –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –¥–µ–ø–ª–æ–µ–≤ –≤ Actions

---

## üîß –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –ì–¥–µ —Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏:

1. **GitHub Actions**:
   - https://github.com/otinoff/GrantService/actions
   - –í–∏–¥–Ω–æ –≤—Å–µ —à–∞–≥–∏, –æ—à–∏–±–∫–∏, –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

2. **Telegram –≥—Ä—É–ø–ø–∞**:
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫–∞–∂–¥–æ–º –¥–µ–ø–ª–æ–µ
   - –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
   - –°—Å—ã–ª–∫–∏ –Ω–∞ –ª–æ–≥–∏

3. **–°–µ—Ä–≤–µ—Ä**:
   ```bash
   ssh root@5.35.88.251
   journalctl -u grantservice-bot -f
   journalctl -u grantservice-admin -f
   ```

### –ï—Å–ª–∏ –¥–µ–ø–ª–æ–π —É–ø–∞–ª:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram (–µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ –Ω–∞ –ª–æ–≥–∏)
2. –û—Ç–∫—Ä—ã—Ç—å GitHub Actions ‚Üí View run
3. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –∫–∞–∫–æ–º —à–∞–≥–µ —É–ø–∞–ª–æ
4. Rollback —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
5. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É –ª–æ–∫–∞–ª—å–Ω–æ
6. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã: `pytest tests/integration/ -v`
7. –ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –û–ö ‚Üí push —Å–Ω–æ–≤–∞

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏

### –í—Ä–µ–º—è –¥–µ–ø–ª–æ—è:

| –≠—Ç–∞–ø | –í—Ä–µ–º—è | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å |
|------|-------|-------------|
| Tests | ~2-3 –º–∏–Ω | ‚ö†Ô∏è –ë–ª–æ–∫–∏—Ä—É–µ—Ç –¥–µ–ø–ª–æ–π |
| Deploy | ~30 —Å–µ–∫ | ‚úÖ –ë—ã—Å—Ç—Ä–æ |
| Smoke tests | ~10 —Å–µ–∫ | ‚ö†Ô∏è –ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å rollback |
| **Total** | **~3-4 –º–∏–Ω** | |

### Downtime:

- **–ü–ª–∞–Ω–æ–≤—ã–π**: ~8-10 —Å–µ–∫ (restart —Å–µ—Ä–≤–∏—Å–æ–≤)
- **–ü—Ä–∏ rollback**: ~15-20 —Å–µ–∫ (reset + restart)
- **–ü—Ä–∏ –æ—à–∏–±–∫–µ –±–µ–∑ rollback (—Å—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞)**: –º–æ–≥–ª–æ –±—ã—Ç—å —á–∞—Å—ã ‚ùå

---

## üéì Best Practices

### ‚úÖ DO:

1. **–ó–∞–ø—É—Å–∫–∞–π —Ç–µ—Å—Ç—ã –ª–æ–∫–∞–ª—å–Ω–æ** –ø–µ—Ä–µ–¥ push:
   ```bash
   pytest tests/integration/ -v
   ```

2. **–ü—Ä–æ–≤–µ—Ä—è–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram** –ø–æ—Å–ª–µ push

3. **–°–º–æ—Ç—Ä–∏ –ª–æ–≥–∏ –≤ GitHub Actions** –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ

4. **–î–µ–ø–ª–æ–π –Ω–µ–±–æ–ª—å—à–∏–º–∏ –ø–æ—Ä—Ü–∏—è–º–∏** (1-3 –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞ —Ä–∞–∑)

### ‚ùå DON'T:

1. **–ù–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π —É–ø–∞–≤—à–∏–µ —Ç–µ—Å—Ç—ã** - –µ—Å–ª–∏ —Ç–µ—Å—Ç —É–ø–∞–ª, –∑–Ω–∞—á–∏—Ç –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∞

2. **–ù–µ –ø—É—à–∏ –≤ production –±–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤**

3. **–ù–µ –¥–µ–ø–ª–æ–π –±–æ–ª—å—à–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** –±–µ–∑ manual check

4. **–ù–µ –º–µ–Ω—è–π config/.env** —á–µ—Ä–µ–∑ Git (–æ–Ω –≤ .gitignore)

---

## üîÆ –ü–ª–∞–Ω—ã –Ω–∞ –±—É–¥—É—â–µ–µ

### v2.1 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
- [ ] Headless browser tests –¥–ª—è Streamlit —Å—Ç—Ä–∞–Ω–∏—Ü
- [ ] Performance metrics –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö
- [ ] Deploy preview –¥–ª—è Dev –≤–µ—Ç–∫–∏
- [ ] Canary deployment (–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π rollout)

### v2.2:
- [ ] Integration —Å Sentry –¥–ª—è error tracking
- [ ] Automatic database backups –ø–µ—Ä–µ–¥ deploy
- [ ] Deploy scheduling (—Ç–æ–ª—å–∫–æ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è)

---

**–í–æ–ø—Ä–æ—Å—ã?** –ü–∏—à–∏ –≤ –≥—Ä—É–ø–ø—É "–ì—Ä–∞–Ω—Ç—Å–µ—Ä–≤–∏—Å" –∏–ª–∏ —Å–æ–∑–¥–∞–π issue –Ω–∞ GitHub.

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**:
- `.github/workflows/deploy-grantservice.yml` - –≥–ª–∞–≤–Ω—ã–π workflow
- `.github/SETUP_SECRETS.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Å–µ–∫—Ä–µ—Ç–∞–º
- `doc/DEPLOYMENT.md` - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é

---

*–°–æ–∑–¥–∞–Ω–æ: 2025-10-04*
*–ê–≤—Ç–æ—Ä: Claude Code (deployment-manager agent)*
