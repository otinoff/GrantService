# –°–∏—Å—Ç–µ–º–∞ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã GrantService
**Version**: 1.0.0 | **Last Updated**: 2025-10-12

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
- [–û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ](#–æ–±—â–µ–µ-–æ–ø–∏—Å–∞–Ω–∏–µ)
- [–§–æ—Ä–º–∞—Ç –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã](#—Ñ–æ—Ä–º–∞—Ç-–Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã)
- [–ü—Ä–∏–º–µ—Ä—ã](#–ø—Ä–∏–º–µ—Ä—ã)
- [–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID](#–≥–µ–Ω–µ—Ä–∞—Ü–∏—è-id)
- [–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ](#–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ-–≤-–∫–æ–¥–µ)
- [–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö](#–º–∏–≥—Ä–∞—Ü–∏—è-–¥–∞–Ω–Ω—ã—Ö)

---

## üéØ –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

GrantService –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **—É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã** –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ –≤—Å–µ–≥–æ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –≥—Ä–∞–Ω—Ç–æ–≤–æ–π –∑–∞—è–≤–∫–∏.

### –ó–∞—á–µ–º –Ω—É–∂–Ω–∞ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞?

1. **–¢—Ä–∞—Å—Å–∏—Ä—É–µ–º–æ—Å—Ç—å** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –æ—Ç –∞–Ω–∫–µ—Ç—ã –¥–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –≥—Ä–∞–Ω—Ç–∞
2. **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å** - ID –ø–æ–Ω—è—Ç–Ω—ã —á–µ–ª–æ–≤–µ–∫—É –±–µ–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
3. **–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å** - –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å ID
4. **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ multiple research/grants –¥–ª—è –æ–¥–Ω–æ–π –∞–Ω–∫–µ—Ç—ã
5. **Debugging** - –ª–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ anketa_id

---

## üìê –§–æ—Ä–º–∞—Ç –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã

### Anketa ID (–æ—Å–Ω–æ–≤–∞ –≤—Å–µ–π –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã)
```
#AN-YYYYMMDD-{user_identifier}-{counter:03d}
```

**–ì–¥–µ**:
- `#AN` - –ø—Ä–µ—Ñ–∏–∫—Å (AnketA)
- `YYYYMMDD` - –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è (–≥–æ–¥-–º–µ—Å—è—Ü-–¥–µ–Ω—å)
- `{user_identifier}` - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–º. –Ω–∏–∂–µ)
- `{counter:03d}` - —Å—á—ë—Ç—á–∏–∫ –∞–Ω–∫–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ –¥–µ–Ω—å (001, 002, 003...)

**–ü—Ä–∏–º–µ—Ä**:
```
#AN-20251008-ekaterina_maksimova-001
```

### User Identifier (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

1. **first_name + last_name** (—Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è) - ‚≠ê –ü–†–ò–û–†–ò–¢–ï–¢
   - –ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –ú–∞–∫—Å–∏–º–æ–≤–∞ ‚Üí `ekaterina_maksimova`
   - –í–∞–ª–µ—Ä–∏—è ‚Üí `valeriya`

2. **username** (–µ—Å–ª–∏ –Ω–µ—Ç –∏–º–µ–Ω–∏/—Ñ–∞–º–∏–ª–∏–∏)
   - @maxkate1 ‚Üí `maxkate1`

3. **telegram_id** (fallback)
   - 123456789 ‚Üí `123456789`

### Audit ID
```
{anketa_id}-AU-{counter:03d}
```

**–ü—Ä–∏–º–µ—Ä**:
```
#AN-20251008-ekaterina_maksimova-001-AU-001
```

### Research ID
```
{anketa_id}-RS-{counter:03d}
```

**–ü—Ä–∏–º–µ—Ä**:
```
#AN-20251008-ekaterina_maksimova-001-RS-001
#AN-20251008-ekaterina_maksimova-001-RS-002
```

### Grant ID
```
{anketa_id}-GR-{counter:03d}
```

**–ü—Ä–∏–º–µ—Ä**:
```
#AN-20251008-ekaterina_maksimova-001-GR-001
#AN-20251008-ekaterina_maksimova-001-GR-002
```

### Review ID
```
{anketa_id}-RV-{counter:03d}
```

**–ü—Ä–∏–º–µ—Ä**:
```
#AN-20251008-ekaterina_maksimova-001-RV-001
#AN-20251008-ekaterina_maksimova-001-RV-002
```

**–í–∞–∂–Ω–æ**: Review - —ç—Ç–æ **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–µ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–µ –º–Ω–µ–Ω–∏–µ** –æ –≥–æ—Ç–æ–≤–æ–º –≥—Ä–∞–Ω—Ç–µ. Review –ù–ï –∏–∑–º–µ–Ω—è–µ—Ç –≥—Ä–∞–Ω—Ç, –∞ —Å–æ–∑–¥–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é –æ—Ü–µ–Ω–æ—á–Ω—É—é –∑–∞–ø–∏—Å—å —Å review_id. –û–¥–∏–Ω –≥—Ä–∞–Ω—Ç –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ review (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –¥–æ—Ä–∞–±–æ—Ç–æ–∫).

### –ù–∞–∑–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ PDF

PDF —Ñ–∞–π–ª—ã –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º ID (–±–µ–∑ —Å–∏–º–≤–æ–ª–∞ `#`):

```
{id}.pdf  (–≥–¥–µ id - anketa_id, audit_id, research_id, –∏–ª–∏ grant_id –±–µ–∑ #)
```

**–ü—Ä–∏–º–µ—Ä—ã**:
```
Interview PDF:  AN-20251011-ekaterina_maksimova-001.pdf
Audit PDF:      AN-20251011-ekaterina_maksimova-001-AU-002.pdf
Research PDF:   AN-20251011-ekaterina_maksimova-001-RS-001.pdf
Grant PDF:      AN-20251011-ekaterina_maksimova-001-GR-001.pdf
Review PDF:     AN-20251011-ekaterina_maksimova-001-RV-001.pdf
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
```python
# Interview PDF (telegram-bot/main.py)
filename = f"{anketa_id.replace('#', '')}.pdf"

# Audit PDF (agents/auditor_agent.py)
filename = f"{audit_id.replace('#', '')}.pdf"

# Research PDF (agents/researcher_agent_v2.py)
filename = f"{research_id.replace('#', '')}.pdf"

# Grant PDF (–±—É–¥—É—â–µ–µ)
filename = f"{grant_id.replace('#', '')}.pdf"

# Review PDF (agents/reviewer_agent.py)
filename = f"{review_id.replace('#', '')}.pdf"
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- ‚úÖ –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Å —Å–∏—Å—Ç–µ–º–æ–π ID
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤
- ‚úÖ –õ–µ–≥–∫–æ –Ω–∞–π—Ç–∏ PDF –ø–æ ID –∏–∑ –ë–î
- ‚úÖ –§–∞–π–ª—ã —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ –¥–∞—Ç–µ/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚úÖ –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å —Å–∏–º–≤–æ–ª–æ–º # –≤ –∏–º–µ–Ω–∞—Ö —Ñ–∞–π–ª–æ–≤

### –ù–∞–∑–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ MD (Markdown –æ—Ç—á–µ—Ç—ã)

MD —Ñ–∞–π–ª—ã —Å–ª–µ–¥—É—é—Ç —Ç–æ–π –∂–µ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–µ, —á—Ç–æ –∏ PDF (–±–µ–∑ —Å–∏–º–≤–æ–ª–∞ `#`):

```
{id}.md  (–≥–¥–µ id - anketa_id, audit_id, research_id, –∏–ª–∏ grant_id –±–µ–∑ #)
```

**–ü—Ä–∏–º–µ—Ä—ã**:
```
Audit MD:      AN-20251011-ekaterina_maksimova-001-AU-002.md
Research MD:   AN-20251011-ekaterina_maksimova-001-RS-001.md
Grant MD:      AN-20251011-ekaterina_maksimova-001-GR-001.md
Review MD:     AN-20251011-ekaterina_maksimova-001-RV-001.md
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
```python
# Audit MD (agents/auditor_agent.py) - TODO
md_filename = f"{audit_id.replace('#', '')}.md"

# Research MD (agents/researcher_agent_v2.py)
md_filename = f"{research_id.replace('#', '')}.md"
md_filepath = os.path.join(current_dir, 'reports', md_filename)

# Grant MD (–±—É–¥—É—â–µ–µ)
md_filename = f"{grant_id.replace('#', '')}.md"

# Review MD (agents/reviewer_agent.py)
md_filename = f"{review_id.replace('#', '')}.md"
md_filepath = os.path.join(current_dir, 'reports', md_filename)
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**:
- ‚úÖ MD –æ—Ç—á–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º –∫–æ–¥–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è PDF –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–µ–∂–¥—É MD –∏ PDF
- ‚úÖ –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –≤–∏–¥–µ
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `reports/` –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

**–í–∞–∂–Ω–æ**: MD —Ñ–∞–π–ª—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –º–µ—Ç–æ–¥–∞–º–∏ –∞–≥–µ–Ω—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `_generate_research_report_md()` –≤ `researcher_agent_v2.py`) –ü–ï–†–ï–î –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π PDF, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ.

---

## üí° –ü—Ä–∏–º–µ—Ä—ã

### –†–µ–∞–ª—å–Ω—ã–π workflow - –ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –ú–∞–∫—Å–∏–º–æ–≤–∞

```
Anketa:
#AN-20251008-ekaterina_maksimova-001

Audit:
#AN-20251008-ekaterina_maksimova-001-AU-001

Research (27 queries):
#AN-20251008-ekaterina_maksimova-001-RS-001

Grant (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –∑–∞—è–≤–∫–∞):
#AN-20251008-ekaterina_maksimova-001-GR-001

Review (–Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è —ç–∫—Å–ø–µ—Ä—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞):
#AN-20251008-ekaterina_maksimova-001-RV-001
```

### –†–µ–∞–ª—å–Ω—ã–π workflow - –í–∞–ª–µ—Ä–∏—è (@Leryusya)

```
Anketa:
#AN-20251008-valeriya-001

Research:
#AN-20251008-valeriya-001-RS-001

Grant:
#AN-20251008-valeriya-001-GR-001
```

### –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–±–µ–∑ –∏–º–µ–Ω–∏)

```
Anketa:
#AN-20251008-maxkate1-001

Research:
#AN-20251008-maxkate1-001-RS-001

Grant:
#AN-20251008-maxkate1-001-GR-001
```

### Multiple –≤–µ—Ä—Å–∏–∏

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ research –¥–ª—è –æ–¥–Ω–æ–π –∞–Ω–∫–µ—Ç—ã:

```
#AN-20251008-ekaterina_maksimova-001-RS-001  (–ø–µ—Ä–≤–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ)
#AN-20251008-ekaterina_maksimova-001-RS-002  (–ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ)
#AN-20251008-ekaterina_maksimova-001-RS-003  (—Ç—Ä–µ—Ç—å–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ)
```

–¢–æ –∂–µ —Å–∞–º–æ–µ —Å –≥—Ä–∞–Ω—Ç–∞–º–∏:

```
#AN-20251008-ekaterina_maksimova-001-GR-001  (–ø–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è –≥—Ä–∞–Ω—Ç–∞)
#AN-20251008-ekaterina_maksimova-001-GR-002  (–ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
```

---

## üîß –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID

### –ú–µ—Ç–æ–¥—ã –≤ `data/database/models.py`

#### 1. `generate_anketa_id(user_data: Dict) -> str`

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç anketa_id –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–í—Ö–æ–¥**:
```python
user_data = {
    'telegram_id': 791123834200,
    'first_name': '–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞',
    'last_name': '–ú–∞–∫—Å–∏–º–æ–≤–∞',
    'username': 'ekaterina_maximova'
}
```

**–í—ã—Ö–æ–¥**:
```python
'#AN-20251008-ekaterina_maksimova-001'
```

**–õ–æ–≥–∏–∫–∞**:
```python
def generate_anketa_id(self, user_data: Dict[str, Any]) -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –∞–Ω–∫–µ—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ #AN-YYYYMMDD-username-001"""
    date_str = datetime.now().strftime("%Y%m%d")
    user_identifier = self._get_user_identifier(user_data)
    next_number = self._get_next_anketa_number(user_identifier, date_str)
    return f"#AN-{date_str}-{user_identifier}-{next_number:03d}"
```

#### 2. `generate_audit_id(anketa_id: str) -> str`

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç audit_id –Ω–∞ –æ—Å–Ω–æ–≤–µ anketa_id.

**–í—Ö–æ–¥**:
```python
anketa_id = '#AN-20251008-ekaterina_maksimova-001'
```

**–í—ã—Ö–æ–¥**:
```python
'#AN-20251008-ekaterina_maksimova-001-AU-001'
```

**–õ–æ–≥–∏–∫–∞**:
```python
def generate_audit_id(self, anketa_id: str) -> str:
    """Generate audit ID: anketa_id + AU suffix + counter"""
    # –°—á–∏—Ç–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ audit –¥–ª—è —ç—Ç–æ–π anketa
    count = self._count_audits_for_anketa(anketa_id)
    return f"{anketa_id}-AU-{count + 1:03d}"
```

#### 3. `generate_research_id(anketa_id: str) -> str`

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç research_id –Ω–∞ –æ—Å–Ω–æ–≤–µ anketa_id.

**–í—Ö–æ–¥**:
```python
anketa_id = '#AN-20251008-ekaterina_maksimova-001'
```

**–í—ã—Ö–æ–¥**:
```python
'#AN-20251008-ekaterina_maksimova-001-RS-001'
```

**–õ–æ–≥–∏–∫–∞**:
```python
def generate_research_id(self, anketa_id: str) -> str:
    """Generate research ID: anketa_id + RS suffix + counter"""
    # –°—á–∏—Ç–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ research –¥–ª—è —ç—Ç–æ–π anketa
    count = self._count_research_for_anketa(anketa_id)
    return f"{anketa_id}-RS-{count + 1:03d}"
```

#### 4. `generate_grant_id(anketa_id: str) -> str`

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç grant_id –Ω–∞ –æ—Å–Ω–æ–≤–µ anketa_id.

**–í—Ö–æ–¥**:
```python
anketa_id = '#AN-20251008-ekaterina_maksimova-001'
```

**–í—ã—Ö–æ–¥**:
```python
'#AN-20251008-ekaterina_maksimova-001-GR-001'
```

**–õ–æ–≥–∏–∫–∞**:
```python
def generate_grant_id(self, anketa_id: str) -> str:
    """Generate grant ID: anketa_id + GR suffix + counter"""
    # –°—á–∏—Ç–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≥—Ä–∞–Ω—Ç—ã –¥–ª—è —ç—Ç–æ–π anketa
    count = self._count_grants_for_anketa(anketa_id)
    return f"{anketa_id}-GR-{count + 1:03d}"
```

#### 5. `generate_review_id(anketa_id: str) -> str`

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç review_id –Ω–∞ –æ—Å–Ω–æ–≤–µ anketa_id.

**–í—Ö–æ–¥**:
```python
anketa_id = '#AN-20251008-ekaterina_maksimova-001'
```

**–í—ã—Ö–æ–¥**:
```python
'#AN-20251008-ekaterina_maksimova-001-RV-001'
```

**–õ–æ–≥–∏–∫–∞**:
```python
def generate_review_id(self, anketa_id: str) -> str:
    """Generate review ID: anketa_id + RV suffix + counter"""
    # –°—á–∏—Ç–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ review –¥–ª—è —ç—Ç–æ–π anketa
    count = self._count_reviews_for_anketa(anketa_id)
    return f"{anketa_id}-RV-{count + 1:03d}"
```

---

## üíª –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ

### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - Agents

#### researcher_agent_v2.py

```python
async def _create_research_record(self, anketa_id: str, anketa: Dict) -> str:
    """–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≤ –ë–î —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–æ–π"""

    research_data = {
        # ‚ùó –ù–ï –ø–µ—Ä–µ–¥–∞—ë–º research_id - db —Å–∞–º —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç!
        'anketa_id': anketa_id,
        'user_id': user_id,
        'session_id': session_id,
        'research_type': 'expert_websearch_27_queries',
        'llm_provider': self.websearch_provider,
        'model': 'router',
        'status': 'pending',
        'research_results': {}
    }

    # ‚úÖ db.save_research_results() –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç generate_research_id()
    saved_id = self.db.save_research_results(research_data)
    return saved_id  # –í–µ—Ä–Ω—ë—Ç: #AN-20251008-ekaterina_maksimova-001-RS-001
```

#### writer_agent_v2.py

Writer V2 –ù–ï —Å–æ–∑–¥–∞–µ—Ç grant_id –Ω–∞–ø—Ä—è–º—É—é - –æ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `grant_applications`, –Ω–µ –≤ `grants`.
–¢–∞–±–ª–∏—Ü–∞ `grants` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ E2E —Ç–µ—Å—Ç–∞—Ö.

### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - E2E Tests

#### test_ekaterina_grant_e2e.py

```python
# –ò–º–ø–æ—Ä—Ç –ë–î –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ID
from models import GrantServiceDatabase
db = GrantServiceDatabase()

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è anketa_id
anketa_id = db.generate_anketa_id({
    'telegram_id': 791123834200,
    'first_name': '–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞',
    'last_name': '–ú–∞–∫—Å–∏–º–æ–≤–∞',
    'username': 'ekaterina_maximova'
})
# –†–µ–∑—É–ª—å—Ç–∞—Ç: #AN-20251011-ekaterina_maksimova-001

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è research_id
research_id = db.generate_research_id(anketa_id)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: #AN-20251011-ekaterina_maksimova-001-RS-001

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è grant_id
grant_id = db.generate_grant_id(anketa_id)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: #AN-20251011-ekaterina_maksimova-001-GR-001
```

### ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –°—Ç–∞—Ä—ã–µ –ø–æ–¥—Ö–æ–¥—ã

```python
# ‚ùå –ù–ï –î–ï–õ–ê–¢–¨ –¢–ê–ö!
research_id = f"RES-{datetime.now().strftime('%Y%m%d%H%M%S')}"
# –†–µ–∑—É–ª—å—Ç–∞—Ç: RES-20251012153045 (–Ω–µ—Ç —Å–≤—è–∑–∏ —Å anketa!)

# ‚ùå –ù–ï –î–ï–õ–ê–¢–¨ –¢–ê–ö!
grant_id = f"GRANT_EKATERINA_{datetime.now().strftime('%Y%m%d')}"
# –†–µ–∑—É–ª—å—Ç–∞—Ç: GRANT_EKATERINA_20251012 (–Ω–µ—Ç —Å–≤—è–∑–∏ —Å anketa!)

# ‚ùå –ù–ï –î–ï–õ–ê–¢–¨ –¢–ê–ö!
anketa_id = f"EKATERINA_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
# –†–µ–∑—É–ª—å—Ç–∞—Ç: EKATERINA_20251012_153045 (–Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—É)
```

---

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### Migration 009: Unify Research and Grant IDs

–§–∞–π–ª: `database/migrations/009_unify_research_grant_ids.sql`

```sql
-- –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ research_id –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
UPDATE researcher_research
SET research_id = anketa_id || '-RS-001'
WHERE research_id NOT LIKE '%RS-%';

-- –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ grant_id –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
UPDATE grants
SET grant_id = anketa_id || '-GR-001'
WHERE grant_id NOT LIKE '%GR-%';
```

### –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```bash
# PostgreSQL
PGPASSWORD=root psql -h localhost -U postgres -d grantservice -f database/migrations/009_unify_research_grant_ids.sql

# –ò–ª–∏ —á–µ—Ä–µ–∑ Python
python scripts/apply_migration_009.py
```

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –≤ –ë–î

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ ID –¥–ª—è –æ–¥–Ω–æ–π –∞–Ω–∫–µ—Ç—ã

```sql
-- –ù–∞–π—Ç–∏ –≤—Å–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–ª—è –ï–∫–∞—Ç–µ—Ä–∏–Ω—ã
SELECT
    'anketa' as type,
    anketa_id as id,
    created_at
FROM sessions
WHERE anketa_id LIKE '#AN-20251008-ekaterina_maksimova%'

UNION ALL

SELECT
    'research' as type,
    research_id as id,
    created_at
FROM researcher_research
WHERE anketa_id LIKE '#AN-20251008-ekaterina_maksimova%'

UNION ALL

SELECT
    'grant' as type,
    grant_id as id,
    created_at
FROM grants
WHERE anketa_id LIKE '#AN-20251008-ekaterina_maksimova%'

ORDER BY created_at;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
```
type     | id                                              | created_at
---------|------------------------------------------------|-------------------
anketa   | #AN-20251008-ekaterina_maksimova-001          | 2025-10-08 14:30:00
research | #AN-20251008-ekaterina_maksimova-001-RS-001   | 2025-10-08 14:35:00
grant    | #AN-20251008-ekaterina_maksimova-001-GR-001   | 2025-10-08 14:45:00
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—É

```sql
-- –ù–∞–π—Ç–∏ research_id –±–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
SELECT research_id, anketa_id, created_at
FROM researcher_research
WHERE research_id NOT LIKE '#AN-%RS-%';

-- –ù–∞–π—Ç–∏ grant_id –±–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
SELECT grant_id, anketa_id, created_at
FROM grants
WHERE grant_id NOT LIKE '#AN-%GR-%';
```

---

## üîç Debugging

### –ö–∞–∫ –Ω–∞–π—Ç–∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?

–ï—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–µ–Ω anketa_id:
```sql
SELECT * FROM sessions WHERE anketa_id = '#AN-20251008-ekaterina_maksimova-001';
SELECT * FROM researcher_research WHERE anketa_id = '#AN-20251008-ekaterina_maksimova-001';
SELECT * FROM grants WHERE anketa_id = '#AN-20251008-ekaterina_maksimova-001';
```

–ï—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–µ–Ω —Ç–æ–ª—å–∫–æ username:
```sql
SELECT * FROM sessions WHERE anketa_id LIKE '#AN-%-ekaterina_maksimova-%';
```

–ï—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–µ–Ω —Ç–æ–ª—å–∫–æ telegram_id:
```sql
-- –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π—Ç–∏ –∞–Ω–∫–µ—Ç—ã
SELECT anketa_id FROM sessions WHERE telegram_id = 791123834200;

-- –ü–æ—Ç–æ–º –Ω–∞–π—Ç–∏ research –∏ grants –ø–æ anketa_id
```

---

## üìù Best Practices

### ‚úÖ DO

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π –º–µ—Ç–æ–¥—ã –ë–î** –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ID:
   ```python
   db.generate_anketa_id(user_data)
   db.generate_research_id(anketa_id)
   db.generate_grant_id(anketa_id)
   ```

2. **–ü—Ä–æ–≤–µ—Ä—è–π —Ñ–æ—Ä–º–∞—Ç** –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –≤ –ë–î:
   ```python
   assert anketa_id.startswith('#AN-'), "Invalid anketa_id format"
   assert research_id.endswith('-RS-'), "Invalid research_id format"
   assert grant_id.endswith('-GR-'), "Invalid grant_id format"
   ```

3. **–õ–æ–≥–∏—Ä—É–π ID** –¥–ª—è debugging:
   ```python
   logger.info(f"Created research: {research_id} for anketa: {anketa_id}")
   ```

### ‚ùå DON'T

1. **–ù–ï —Å–æ–∑–¥–∞–≤–∞–π ID –≤—Ä—É—á–Ω—É—é**:
   ```python
   # ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
   research_id = f"RES-{timestamp}"
   ```

2. **–ù–ï –∑–∞–±—ã–≤–∞–π –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å anketa_id**:
   ```python
   # ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - research_id –±–µ–∑ —Å–≤—è–∑–∏ —Å anketa
   research_id = generate_random_id()
   ```

3. **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∞—Ä—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã**:
   ```python
   # ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç
   anketa_id = f"EKATERINA_{date}"
   ```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã

### E2E Test

–§–∞–π–ª: `tests/integration/test_ekaterina_grant_e2e.py`

–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö workflow:

```bash
python tests/integration/test_ekaterina_grant_e2e.py
```

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç**:
- ‚úÖ Anketa ID —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—É `#AN-YYYYMMDD-username-NNN`
- ‚úÖ Research ID = `{anketa_id}-RS-NNN`
- ‚úÖ Grant ID = `{anketa_id}-GR-NNN`
- ‚úÖ –í—Å–µ ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î
- ‚úÖ –°–≤—è–∑–∏ –º–µ–∂–¥—É –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [DATABASE.md](./DATABASE.md) - –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- [ARCHITECTURE.md](./ARCHITECTURE.md) - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã
- [AI_AGENTS.md](./AI_AGENTS.md) - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è AI –∞–≥–µ–Ω—Ç–æ–≤
- [CHANGELOG.md](./CHANGELOG.md) - –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## üêõ Known Issues

### Issue #1: Legacy data –±–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã

**–ü—Ä–æ–±–ª–µ–º–∞**: –°—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î —Å–æ–∑–¥–∞–Ω—ã –¥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã.

**–†–µ—à–µ–Ω–∏–µ**: –ó–∞–ø—É—Å—Ç–∏—Ç—å migration 009:
```bash
python scripts/apply_migration_009.py
```

### Issue #2: Tests —Å–æ–∑–¥–∞—é—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ ID

**–ü—Ä–æ–±–ª–µ–º–∞**: –°—Ç–∞—Ä—ã–µ —Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ö–∞—Ä–¥–∫–æ–¥ –≤–º–µ—Å—Ç–æ db –º–µ—Ç–æ–¥–æ–≤.

**–†–µ—à–µ–Ω–∏–µ**: –û–±–Ω–æ–≤–ª–µ–Ω–æ –≤ test_ekaterina_grant_e2e.py (2025-10-12).

---

## üìû Support

–ï—Å–ª–∏ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç ID –≤ –ë–î (—Å–º. —Ä–∞–∑–¥–µ–ª "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã")
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ E2E —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ workflow
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∞–≥–µ–Ω—Ç–æ–≤ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ—à–∏–±–æ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ID
4. –°–æ–∑–¥–∞–π—Ç–µ issue —Å –ø—Ä–∏–º–µ—Ä–æ–º –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ ID

---

**Version**: 1.0.0
**Last Updated**: 2025-10-12
**Maintained by**: database-manager agent

---

*–≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é –º–æ–¥—É–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ GrantService*
