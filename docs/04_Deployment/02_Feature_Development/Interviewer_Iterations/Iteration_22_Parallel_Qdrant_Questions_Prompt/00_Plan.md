# Iteration 22: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è Qdrant + –ü—Ä–æ–º–ø—Ç —Å 10-15 –≤–æ–ø—Ä–æ—Å–∞–º–∏

**Date:** 2025-10-22
**Status:** Planning
**Goal:** –£—Å–∫–æ—Ä–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É

---

## üéØ –¶–µ–ª–∏ –∏—Ç–µ—Ä–∞—Ü–∏–∏

### 1. –ü—Ä–æ–º–ø—Ç —Å 10-15 –≤–æ–ø—Ä–æ—Å–∞–º–∏
**–ò–¥–µ—è:** LLM –∑–Ω–∞–µ—Ç –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∑–∞—Ä–∞–Ω–µ–µ –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º –ø—Ä–æ–º–ø—Ç–µ

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –õ—É—á—à–µ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ü–æ–Ω–∏–º–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É –≤–æ–ø—Ä–æ—Å–∞–º–∏
- ‚úÖ –ú–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –æ—á–µ–≤–∏–¥–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã

### 2. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è Qdrant –æ–±—Ä–∞–±–æ—Ç–∫–∞
**–ò–¥–µ—è:** –ó–∞–ø—É—Å—Ç–∏—Ç—å Qdrant search –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ—Ä–≤—å—é
- ‚úÖ –ë—ã—Å—Ç—Ä–µ–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤
- ‚úÖ –õ—É—á—à–∏–π UX (–Ω–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π)

---

## üìä –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### –¢–µ–∫—É—â–∏–π flow:

```
1. User –æ—Ç–≤–µ—Ç ‚Üí answer_queue
2. Agent: get_next_reference_point()
3. Agent: generate_question()
   ‚îî‚îÄ‚Üí [BLOCKING] Qdrant search (1-2 —Å–µ–∫)
   ‚îî‚îÄ‚Üí [BLOCKING] LLM call (2-3 —Å–µ–∫)
4. Agent: send question
5. Repeat
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå Qdrant –±–ª–æ–∫–∏—Ä—É–µ—Ç (1-2 —Å–µ–∫)
- ‚ùå LLM –Ω–µ –∑–Ω–∞–µ—Ç –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∑–∞—Ä–∞–Ω–µ–µ
- ‚ùå –ù–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

### –¶–µ–ª–µ–≤–æ–π flow:

```
1. [INIT] LLM –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–º–ø—Ç —Å 10-15 –≤–æ–ø—Ä–æ—Å–∞–º–∏
2. User –æ—Ç–≤–µ—Ç ‚Üí answer_queue
3. Agent: [ASYNC] –ó–∞–ø—É—Å—Ç–∏—Ç—å Qdrant search –≤ —Ñ–æ–Ω–µ
4. Agent: [PARALLEL] –ü–æ–∫–∞ Qdrant –∏—â–µ—Ç, LLM –¥—É–º–∞–µ—Ç
5. Agent: –û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
6. Agent: send question
7. Repeat
```

**–£–ª—É—á—à–µ–Ω–∏—è:**
- ‚úÖ Qdrant –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç
- ‚úÖ LLM –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –ª—É—á—à–µ
- ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

---

## üîç –ê–Ω–∞–ª–∏–∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### 1. adaptive_question_generator.py

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (—Å—Ç—Ä–æ–∫–∞ 111-125):**
```python
async def generate_question(...):
    # ...
    # 4. –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ Qdrant (BLOCKING!)
    fpg_context = await self._get_fpg_context(reference_point, project_type)
    
    # 5. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–±–µ–ª—ã
    gaps = self._identify_information_gaps(...)
    
    # 6. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å —Å LLM (BLOCKING!)
    question = await self._llm_generate_question(...)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (5-6 —Å–µ–∫ total)

**–†–µ—à–µ–Ω–∏–µ:** –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫:
```python
async def generate_question(...):
    # –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    qdrant_task = asyncio.create_task(self._get_fpg_context(...))
    gaps_task = asyncio.create_task(self._identify_information_gaps(...))
    
    # –î–æ–∂–¥–∞—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    fpg_context = await qdrant_task
    gaps = await gaps_task
    
    # LLM —Å –æ–±–æ–∏–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
    question = await self._llm_generate_question(...)
```

---

### 2. –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç

**–¢–µ–∫—É—â–∏–π –ø—Ä–æ–º–ø—Ç (—Å—Ç—Ä–æ–∫–∞ 352-366):**
```python
system_prompt = """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≥—Ä–∞–Ω—Ç–∞–º –§–ü–ì.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∑–∞–¥–∞—Ç—å –û–î–ò–ù —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å...
"""
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –∑–Ω–∞–µ—Ç –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∑–∞—Ä–∞–Ω–µ–µ

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤:
```python
system_prompt = """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≥—Ä–∞–Ω—Ç–∞–º –§–ü–ì.

–í–ê–ñ–ù–´–ï –í–û–ü–†–û–°–´ –¥–ª—è –∑–∞—è–≤–∫–∏ (10-15):
1. –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ (3-7 —Å–ª–æ–≤)
2. –°—É—Ç—å –ø—Ä–æ–µ–∫—Ç–∞ (—á—Ç–æ –¥–µ–ª–∞–µ—Ç–µ?)
3. –ü—Ä–æ–±–ª–µ–º–∞ (–∫–∞–∫—É—é —Ä–µ—à–∞–µ—Ç–µ?)
4. –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è (–∫–æ–º—É –ø–æ–º–æ–≥–∞–µ—Ç–µ?)
5. –ì–µ–æ–≥—Ä–∞—Ñ–∏—è (–≥–¥–µ —Ä–µ–∞–ª–∏–∑—É–µ—Ç–µ?)
6. –ë—é–¥–∂–µ—Ç (—Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ?)
7. –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è (–∫–∞–∫ –±—É–¥–µ—Ç–µ –¥–µ–ª–∞—Ç—å?)
8. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã (—á—Ç–æ –ø–æ–ª—É—á–∏—Ç—Å—è?)
9. –ö–æ–º–∞–Ω–¥–∞ (–∫—Ç–æ –±—É–¥–µ—Ç –¥–µ–ª–∞—Ç—å?)
10. –ü–∞—Ä—Ç–Ω–µ—Ä—ã (—Å –∫–µ–º —Ä–∞–±–æ—Ç–∞–µ—Ç–µ?)

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
- –¢—ã –ó–ù–ê–ï–®–¨ –≤—Å–µ —ç—Ç–∏ –≤–æ–ø—Ä–æ—Å—ã
- –ó–∞–¥–∞–≤–∞–π –∏—Ö –≤ –ª–æ–≥–∏—á–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
- –ü—Ä–æ–ø—É—Å–∫–∞–π –æ—á–µ–≤–∏–¥–Ω—ã–µ (–µ—Å–ª–∏ —É–∂–µ –æ—Ç–≤–µ—Ç–∏–ª–∏)
- –î–æ–±–∞–≤–ª—è–π —É—Ç–æ—á–Ω–µ–Ω–∏—è –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ

–°–µ–π—á–∞—Å –∑–∞–¥–∞–π –û–î–ò–ù —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å...
"""
```

---

## üìù –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### Phase 1: –ü—Ä–æ–º–ø—Ç —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ (1 —á–∞—Å)

**–®–∞–≥–∏:**
1. –°–æ—Å—Ç–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ 10-15 –∫–ª—é—á–µ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
2. –û–±–Ω–æ–≤–∏—Ç—å system_prompt –≤ adaptive_question_generator.py
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π

**–§–∞–π–ª—ã:**
- `agents/reference_points/adaptive_question_generator.py` (—Å—Ç—Ä–æ–∫–∞ 352)

**–¢–µ—Å—Ç:**
- –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ LLM –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—Å–µ—Ö –≤–æ–ø—Ä–æ—Å–æ–≤

---

### Phase 2: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è Qdrant (2 —á–∞—Å–∞)

**–®–∞–≥–∏:**
1. –ò–∑–º–µ–Ω–∏—Ç—å `generate_question()` –Ω–∞ async parallel
2. –î–æ–±–∞–≤–∏—Ç—å `asyncio.create_task()` –¥–ª—è Qdrant
3. –î–æ–±–∞–≤–∏—Ç—å timeout –¥–ª—è Qdrant (fallback)

**–§–∞–π–ª—ã:**
- `agents/reference_points/adaptive_question_generator.py` (—Å—Ç—Ä–æ–∫–∞ 111-125)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
async def generate_question(...):
    # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    tasks = [
        asyncio.create_task(self._get_fpg_context(...)),
        asyncio.create_task(self._identify_information_gaps(...))
    ]
    
    # Timeout 2 —Å–µ–∫ –¥–ª—è Qdrant
    try:
        fpg_context, gaps = await asyncio.wait_for(
            asyncio.gather(*tasks),
            timeout=2.0
        )
    except asyncio.TimeoutError:
        logger.warning("Qdrant timeout, using fallback")
        fpg_context = ""
        gaps = []
```

---

### Phase 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (1 —á–∞—Å)

**–¢–µ—Å—Ç—ã:**
1. Unit test: –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏
2. Integration test: –ø–æ–ª–Ω–æ–µ –∏–Ω—Ç–µ—Ä–≤—å—é
3. Performance test: –∏–∑–º–µ—Ä–∏—Ç—å —É—Å–∫–æ—Ä–µ–Ω–∏–µ

**–ú–µ—Ç—Ä–∏–∫–∏:**
- –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–∞: –±—ã–ª–æ 5-6 —Å–µ–∫ ‚Üí —Ü–µ–ª—å 2-3 —Å–µ–∫
- UX: –Ω–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π

---

## üéØ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ú–µ—Ç—Ä–∏–∫–∏:

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|--------|-----------|
| –í—Ä–µ–º—è –≤–æ–ø—Ä–æ—Å–∞ | 5-6 —Å–µ–∫ | 2-3 —Å–µ–∫ | **-50%** |
| Qdrant –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ | –î–∞ | –ù–µ—Ç | ‚úÖ |
| LLM –ø–æ–Ω–∏–º–∞–Ω–∏–µ | –õ–æ–∫–∞–ª—å–Ω–æ–µ | –ì–ª–æ–±–∞–ª—å–Ω–æ–µ | ‚úÖ |
| UX –∑–∞–≤–∏—Å–∞–Ω–∏—è | –ï—Å—Ç—å | –ù–µ—Ç | ‚úÖ |

---

## üìã –ß–µ–∫–ª–∏—Å—Ç

**Phase 1:**
- [ ] –°–æ—Å—Ç–∞–≤–∏—Ç—å 10-15 –≤–æ–ø—Ä–æ—Å–æ–≤
- [ ] –û–±–Ω–æ–≤–∏—Ç—å system_prompt
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

**Phase 2:**
- [ ] Async parallel –¥–ª—è generate_question()
- [ ] Timeout –¥–ª—è Qdrant
- [ ] Fallback –µ—Å–ª–∏ timeout

**Phase 3:**
- [ ] Unit —Ç–µ—Å—Ç—ã
- [ ] Integration —Ç–µ—Å—Ç—ã
- [ ] Performance —Ç–µ—Å—Ç—ã
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç—á–µ—Ç

---

## üöÄ Next Steps

1. **–°–µ–π—á–∞—Å:** –ó–∞–≤–µ—Ä—à–∏—Ç—å —ç—Ç–æ—Ç –ø–ª–∞–Ω
2. **–î–∞–ª–µ–µ:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Phase 1
3. **–ü–æ—Ç–æ–º:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Phase 2
4. **–§–∏–Ω–∞–ª:** –¢–µ—Å—Ç—ã –∏ –æ—Ç—á–µ—Ç

---

**Created:** 2025-10-22
**Estimated time:** 4 hours
**Priority:** HIGH (UX improvement)
