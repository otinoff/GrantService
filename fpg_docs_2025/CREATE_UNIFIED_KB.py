# -*- coding: utf-8 -*-
"""
Создание объединенной базы знаний: официальные требования + практические рекомендации
"""
from pathlib import Path
import re

def create_unified_knowledge_base():
    """Объединить официальную БЗ с практическими рекомендациями"""

    docs_dir = Path(__file__).parent

    # Прочитать нашу новую БЗ (официальные требования)
    with open(docs_dir / 'KNOWLEDGE_BASE.md', 'r', encoding='utf-8') as f:
        official_kb = f.read()

    # Прочитать старый референс
    old_reference_path = docs_dir / 'База знаний по созданию заявки в Фонд президентски.md'
    with open(old_reference_path, 'r', encoding='utf-8') as f:
        old_reference = f.read()

    # Извлечь ключевые разделы из старого референса
    smart_section = extract_section(old_reference, "Цель проекта", "Задачи проекта")
    errors_section = extract_section(old_reference, "## 6. ТИПИЧНЫЕ ОШИБКИ", "## 7. РЕКОМЕНДАЦИИ")
    openness_section = extract_section(old_reference, "## 4. ИНФОРМАЦИОННАЯ ОТКРЫТОСТЬ", "## 5. ПРОЦЕСС")
    criteria_section = extract_section(old_reference, "### 5.2. Экспертиза заявок", "### 5.3. Сроки")
    sofinancing_section = extract_section(old_reference, "**Софинансирование — ОБЯЗАТЕЛЬНО**:", "**Рекомендации по расходованию**:")
    sozidateli_section = extract_section(old_reference, "**РЕКОМЕНДУЕТСЯ Фондом:** автоматическое заполнение", "**Альтернатива:**")

    # Создать объединенную БЗ
    unified_kb = [
        "# ПОЛНАЯ БАЗА ЗНАНИЙ: Грантовые заявки ФПГ",
        "",
        "**Версия:** 2.0 (Объединенная)",
        "**Источники:**",
        "- Официальный сайт Фонда президентских грантов (первоисточник)",
        "- Методические материалы и практические рекомендации",
        "- Типичные ошибки и критерии оценки",
        "**Дата создания:** 2025-10-17",
        "",
        "## О базе знаний",
        "",
        "Эта объединенная база знаний содержит:",
        "1. **Официальные требования** с сайта ФПГ (извлечено из 15 статей)",
        "2. **Практические рекомендации** на основе опыта экспертов",
        "3. **Типичные ошибки** заявителей",
        "4. **Критерии оценки** заявок (10 критериев по 10 баллов)",
        "5. **Полезные инструменты** (портал Созидатели, обучение)",
        "",
        "**Предназначена для:**",
        "- Writer (писатель заявок) - знать все требования",
        "- Researcher (исследователь) - находить релевантную информацию",
        "- Reviewer (ревьювер) - проверять соответствие критериям",
        "",
        "---",
        "",
        "# ЧАСТЬ 1: ОФИЦИАЛЬНЫЕ ТРЕБОВАНИЯ ФПГ",
        "",
        "## Содержание официальных требований",
        "",
        "1. [Общие правила подачи заявок](#общие-правила)",
        "2. [Раздел О проекте](#раздел-о-проекте)",
        "3. [Раздел Руководитель проекта](#раздел-руководитель)",
        "4. [Раздел Команда проекта](#раздел-команда)",
        "5. [Раздел Организация-заявитель](#раздел-организация)",
        "6. [Раздел Календарный план](#раздел-календарный-план)",
        "7. [Раздел Бюджет проекта](#раздел-бюджет)",
        "8. [Запрещенные и нерекомендуемые расходы](#расходы)",
        "",
        "---",
        ""
    ]

    # Добавить официальную БЗ (без заголовка)
    official_content = official_kb.split('---', 1)[1] if '---' in official_kb else official_kb
    unified_kb.append(official_content)

    unified_kb.extend([
        "",
        "---",
        "",
        "# ЧАСТЬ 2: КРИТЕРИИ ОЦЕНКИ И ПРАКТИЧЕСКИЕ РЕКОМЕНДАЦИИ",
        "",
        "## 1. КРИТЕРИИ ОЦЕНКИ ЗАЯВОК",
        "",
        "### 10 критериев экспертизы (каждый от 0 до 10 баллов)",
        "",
        criteria_section if criteria_section else "**10 критериев оценки:**\n\n1. Информационная открытость организации\n2. Опыт организации по успешной реализации программ\n3. Соответствие опыта и компетенций команды\n4. Актуальность проблемы и социальная значимость\n5. Реалистичность проекта, логичность и обоснованность\n6. Детализация проекта\n7. Измеримость результатов\n8. Перспективы развития и потенциал\n9. Эффективность использования ресурсов\n10. Реалистичность бюджета\n\n**Максимум: 100 баллов**",
        "",
        "---",
        "",
        "## 2. ИНФОРМАЦИОННАЯ ОТКРЫТОСТЬ",
        "",
        "**ВАЖНОСТЬ:** Один из ключевых критериев оценки - до 10 баллов!",
        "Это самый 'легкий' критерий для получения высоких баллов.",
        "",
        openness_section if openness_section else "",
        "",
        "### Рекомендации для высокой оценки:",
        "",
        "- Создайте и регулярно обновляйте сайт организации",
        "- Ведите активные страницы в социальных сетях (ВК, Telegram)",
        "- Публикуйте годовые отчеты о деятельности",
        "- Размещайте информацию о проектах с результатами",
        "- Взаимодействуйте со СМИ",
        "- Публикуйте финансовую информацию за 3 года",
        "",
        "---",
        "",
        "## 3. ПОРТАЛ СОЗИДАТЕЛИ",
        "",
        "**РЕКОМЕНДУЕТСЯ ФОНДОМ!**",
        "",
        sozidateli_section if sozidateli_section else "",
        "",
        "**Портал:** www.sozidateli.ru",
        "",
        "**Преимущества:**",
        "- Автоматическое заполнение профилей команды",
        "- Не нужно заново заполнять при новых заявках",
        "- Упрощает экспертам оценку команды",
        "- Члены команды подтверждают участие лично",
        "- **УВЕЛИЧИВАЕТ ШАНСЫ НА ПОБЕДУ**",
        "",
        "---",
        "",
        "## 4. ЦЕЛИ ПРОЕКТА: КРИТЕРИИ SMART",
        "",
        smart_section if smart_section else "",
        "",
        "### Примеры правильной и неправильной формулировки:",
        "",
        "**НЕПРАВИЛЬНО:**",
        "- 'Улучшить жизнь людей' (размыто, не измеримо)",
        "- 'Создать центр помощи' (это задача, а не цель)",
        "- 'Решить проблему бездомности' (недостижимо за 18 месяцев)",
        "",
        "**ПРАВИЛЬНО:**",
        "- 'Организовать дополнительное обучение робототехнике для 50 старшеклассников города N'",
        "- 'Социальная адаптация 30 детей-сирот через программу наставничества'",
        "- 'Повысить уровень правовой грамотности 200 пенсионеров города N'",
        "",
        "---",
        "",
        "## 5. СОФИНАНСИРОВАНИЕ",
        "",
        "**ОБЯЗАТЕЛЬНОСТЬ:** Необходимо указать собственный вклад организации!",
        "",
        sofinancing_section if sofinancing_section else "",
        "",
        "**Рекомендуемый размер:** 20-30% от общей суммы проекта",
        "",
        "**Это НЕ обязательно деньги! Может быть:**",
        "- Волонтерский труд (оценить в деньгах по рыночной стоимости)",
        "- Использование помещений организации",
        "- Использование оборудования",
        "- Партнерская поддержка (материалы, услуги)",
        "- Софинансирование от бизнеса или других источников",
        "",
        "**ВАЖНО:** Эксперты уделяют этому пристальное внимание!",
        "",
        "---",
        "",
        "## 6. ТИПИЧНЫЕ ОШИБКИ ЗАЯВИТЕЛЕЙ",
        "",
        "### ⚠️ КРИТИЧНЫЕ ОШИБКИ, КОТОРЫЕ СНИЖАЮТ РЕЙТИНГ",
        "",
        errors_section if errors_section else "",
        "",
        "---",
        "",
        "## 7. ОГРАНИЧЕНИЯ ПО СИМВОЛАМ",
        "",
        "### Официальные лимиты с сайта ФПГ:",
        "",
        "| Поле заявки | Ограничение | Источник |",
        "|-------------|-------------|----------|",
        "| Название проекта | **300 символов** (с пробелами) | ФПГ Статья 84 |",
        "| Обоснование социальной значимости | **5000 символов** (с пробелами) | ФПГ Статья 84 |",
        "",
        "**Рекомендация:** Если не хватает символов - прикрепите полное описание проекта в поле '3.1 Полное описание проекта, презентация проекта' (формат PDF)",
        "",
        "---",
        "",
        "# ЧАСТЬ 3: ПОЛЕЗНЫЕ РЕСУРСЫ",
        "",
        "## Официальные сайты Фонда",
        "",
        "- **Главный сайт:** https://президентскиегранты.рф",
        "- **Центр поддержки:** https://поддержка.президентскиегранты.рф",
        "- **Портал Созидатели:** https://www.sozidateli.ru (регистрация команды)",
        "- **Онлайн-курсы:** https://онлайнкурсы.президентскиегранты.рф (бесплатное обучение)",
        "- **Обучение:** https://обучение.президентскиегранты.рф (марафоны и семинары)",
        "",
        "## Обязательные документы к изучению",
        "",
        "1. Положение о конкурсе (актуальное на текущий год)",
        "2. Методические рекомендации по подготовке заявок",
        "3. Методические рекомендации по подготовке бюджета",
        "4. Инструкция по заполнению заявки",
        "5. Методика оценки заявок",
        "",
        "## Обучающие программы",
        "",
        "- Онлайн-курс по социальному проектированию (базовый и продвинутый)",
        "- Марафоны по разработке проектов (7 недель)",
        "- Вебинары с экспертами",
        "- Консультации в региональных ресурсных центрах НКО",
        "",
        "---",
        "",
        "# ПРИЛОЖЕНИЯ",
        "",
        "## Приложение А: Чек-лист перед отправкой заявки",
        "",
        "### Общие требования:",
        "- [ ] Организация зарегистрирована не позднее требуемого срока",
        "- [ ] Нет задолженности по налогам более 1000 руб.",
        "- [ ] Заявка подается не позднее чем за 10 дней до окончания приема",
        "",
        "### Раздел 'О проекте':",
        "- [ ] Проблема описана конкретно, со ссылками на статистику",
        "- [ ] Целевая группа четко определена (НЕ 'все желающие')",
        "- [ ] Цель соответствует SMART-критериям",
        "- [ ] Задачи логически вытекают из цели (3-5 задач)",
        "- [ ] Результаты измеряются В ЛЮДЯХ, а не в мероприятиях",
        "",
        "### Команда и организация:",
        "- [ ] Вся команда зарегистрирована на портале Созидатели",
        "- [ ] Опыт команды соответствует масштабу проекта",
        "- [ ] Описан опыт организации с конкретными результатами",
        "- [ ] Информационная открытость на высоком уровне (сайт, соцсети)",
        "",
        "### Календарный план:",
        "- [ ] Все мероприятия связаны с задачами проекта",
        "- [ ] Указаны конкретные даты начала и окончания",
        "- [ ] Мероприятия реалистичны по срокам",
        "",
        "### Бюджет:",
        "- [ ] К КАЖДОЙ статье расходов есть подробный комментарий",
        "- [ ] Указано: что, зачем, как рассчитана стоимость",
        "- [ ] Все расходы связаны с конкретными мероприятиями",
        "- [ ] Указан собственный вклад организации (софинансирование 20-30%)",
        "- [ ] Нет запрещенных расходов",
        "- [ ] Календарный план и бюджет полностью соответствуют друг другу",
        "",
        "### Документы:",
        "- [ ] Форма подтверждения подачи заявки подписана руководителем",
        "- [ ] Все три листа формы подписаны и отсканированы в один PDF",
        "- [ ] Приложен устав организации со всеми изменениями",
        "- [ ] Приложены письма поддержки от партнеров (если есть)",
        "",
        "---",
        "",
        "## Приложение Б: Примеры формулировок",
        "",
        "### Примеры правильного описания проблемы:",
        "",
        "**ХОРОШО:**",
        "'В городе Сарапул проживает 450 старшеклассников (10-11 классы). Согласно опросу, проведенному",
        "нашей организацией в мае 2024 года (n=280), 78% из них хотели бы изучать робототехнику для",
        "поступления на технические специальности. Однако в городе нет ни одного центра дополнительного",
        "образования, предлагающего такие курсы. Ближайший центр находится в 120 км (г. Ижевск).'",
        "",
        "**ПЛОХО:**",
        "'Молодежь не интересуется техникой, что плохо влияет на экономику.'",
        "",
        "---",
        "",
        "**Эта база знаний регулярно обновляется на основе актуальных требований ФПГ**",
        ""
    ]

    # Сохранить объединенную БЗ
    unified_file = docs_dir / 'UNIFIED_KNOWLEDGE_BASE.md'
    with open(unified_file, 'w', encoding='utf-8') as f:
        f.write('\n'.join(unified_kb))

    print(f"[+] Объединенная база знаний создана: {unified_file}")
    print(f"[INFO] Размер: {unified_file.stat().st_size / 1024:.1f} KB")

    return unified_file

def extract_section(text, start_marker, end_marker):
    """Извлечь раздел между маркерами"""
    try:
        start = text.find(start_marker)
        end = text.find(end_marker, start)

        if start == -1:
            return ""

        if end == -1:
            end = len(text)

        section = text[start:end].strip()
        return section
    except:
        return ""

if __name__ == '__main__':
    unified_file = create_unified_knowledge_base()
    print(f"\n[SUCCESS] Объединенная база знаний готова!")
    print(f"[INFO] Файл содержит:")
    print(f"  - Часть 1: Официальные требования ФПГ (15 статей)")
    print(f"  - Часть 2: Критерии оценки и практические рекомендации")
    print(f"  - Часть 3: Полезные ресурсы")
    print(f"  - Приложения: Чек-листы и примеры")
    print(f"\n[NEXT] Следующий шаг: добавить примеры из успешных заявок 2021")
