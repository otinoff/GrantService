# Iteration 52: Interactive Step-by-Step Grant Pipeline

**Status:** üöß IN PROGRESS
**Started:** 2025-10-26
**Priority:** HIGH (UX improvement)
**Estimated Time:** 6 hours (1 day)
**Methodology:** Project Evolution + Testing Methodology

---

## üéØ Goal

Transform the grant generation flow from "black box" to transparent, interactive step-by-step process with file checkpoints at each stage.

**Current Flow (Iteration 51):**
```
User completes anketa ‚Üí [waiting 10 minutes...] ‚Üí Grant appears
```

**Target Flow (Iteration 52):**
```
1. User completes anketa ‚Üí receives anketa.txt + button "–ù–∞—á–∞—Ç—å –∞—É–¥–∏—Ç"
2. User clicks button ‚Üí [audit runs] ‚Üí receives audit.txt + button "–ù–∞—á–∞—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –≥—Ä–∞–Ω—Ç–∞"
3. User clicks button ‚Üí [grant generation] ‚Üí receives grant.txt + button "–°–¥–µ–ª–∞—Ç—å —Ä–µ–≤—å—é"
4. User clicks button ‚Üí [review runs] ‚Üí receives review.txt + "–ì–æ—Ç–æ–≤–æ!"
```

---

## üìä Benefits

1. **Transparency:** User sees each step
2. **Control:** Can pause between stages
3. **Artifacts:** All intermediate files saved
4. **Confidence:** Progress visibility
5. **Debug:** Easier to identify where problems occur

---

## üìã Scope

### In Scope ‚úÖ

1. **File Generators:**
   - `generate_anketa_txt()` - readable anketa summary
   - `generate_audit_txt()` - audit results
   - `generate_grant_txt()` - full grant application
   - `generate_review_txt()` - review results

2. **Telegram Bot Updates:**
   - After anketa: send file + "–ù–∞—á–∞—Ç—å –∞—É–¥–∏—Ç" button
   - After audit: send file + "–ù–∞—á–∞—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –≥—Ä–∞–Ω—Ç–∞" button
   - After grant: send file + "–°–¥–µ–ª–∞—Ç—å —Ä–µ–≤—å—é" button
   - After review: send file + "–ì–æ—Ç–æ–≤–æ" message

3. **State Machine:**
   - Track user progress (anketa_completed ‚Üí audit_requested ‚Üí grant_requested ‚Üí review_requested)
   - Store in database: `user_pipeline_state`

4. **Tests:**
   - Unit tests for file generators
   - Integration tests for bot handlers
   - E2E test for full pipeline

### Out of Scope ‚ùå

- UI/UX design changes (keep current layout)
- PDF generation (use .txt files for now)
- Progress bar (future iteration)
- Multi-language support (Russian only)
- Cancel/restart flow (future iteration)

---

## üìê Architecture

### State Machine

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   START     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ANKETA_COMPLETED ‚îÇ ‚Üí Send anketa.txt + button "–ù–∞—á–∞—Ç—å –∞—É–¥–∏—Ç"
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ User clicks button
       v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ AUDIT_REQUESTED  ‚îÇ ‚Üí Run audit ‚Üí Send audit.txt + button "–ù–∞—á–∞—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –≥—Ä–∞–Ω—Ç–∞"
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ User clicks button
       v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ GRANT_REQUESTED  ‚îÇ ‚Üí Run writer ‚Üí Send grant.txt + button "–°–¥–µ–ª–∞—Ç—å —Ä–µ–≤—å—é"
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ User clicks button
       v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ REVIEW_REQUESTED ‚îÇ ‚Üí Run reviewer ‚Üí Send review.txt + "–ì–æ—Ç–æ–≤–æ!"
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   COMPLETE   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### File Formats

**anketa.txt:**
```
–ó–ê–ü–û–õ–ù–ï–ù–ù–ê–Ø –ê–ù–ö–ï–¢–ê

–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞: [project_name]
–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è: [organization]
–û–ø–∏—Å–∞–Ω–∏–µ: [description]
...

–î–∞—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è: [timestamp]
ID –∞–Ω–∫–µ—Ç—ã: [anketa_id]
```

**audit.txt:**
```
–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–£–î–ò–¢–ê –ê–ù–ö–ï–¢–´

ID –∞–Ω–∫–µ—Ç—ã: [anketa_id]
–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞: [timestamp]

–û–¶–ï–ù–ö–ê: [score]/10

–ü–†–û–ë–õ–ï–ú–´:
1. [issue_1]
2. [issue_2]

–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
1. [recommendation_1]
2. [recommendation_2]

–°—Ç–∞—Ç—É—Å: [approved/needs_work]
```

**grant.txt:**
```
–ì–†–ê–ù–¢–û–í–ê–Ø –ó–ê–Ø–í–ö–ê

–ü—Ä–æ–µ–∫—Ç: [project_name]
–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: [timestamp]

=== –ü–†–û–ë–õ–ï–ú–ê ===
[problem_text]

=== –†–ï–®–ï–ù–ò–ï ===
[solution_text]

=== –ë–Æ–î–ñ–ï–¢ ===
[budget_text]

...

–í—Å–µ–≥–æ —Å–∏–º–≤–æ–ª–æ–≤: [count]
ID –∑–∞—è–≤–∫–∏: [grant_id]
```

**review.txt:**
```
–†–ï–ó–£–õ–¨–¢–ê–¢–´ –†–ï–í–¨–Æ –ì–†–ê–ù–¢–û–í–û–ô –ó–ê–Ø–í–ö–ò

ID –∑–∞—è–≤–∫–∏: [grant_id]
–î–∞—Ç–∞ —Ä–µ–≤—å—é: [timestamp]

–û–ë–©–ê–Ø –û–¶–ï–ù–ö–ê: [score]/10

–°–ò–õ–¨–ù–´–ï –°–¢–û–†–û–ù–´:
1. [strength_1]
2. [strength_2]

–°–õ–ê–ë–´–ï –°–¢–û–†–û–ù–´:
1. [weakness_1]
2. [weakness_2]

–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ:
1. [recommendation_1]
2. [recommendation_2]

–°—Ç–∞—Ç—É—Å: [approved/rejected]
```

---

## üìã Tasks Breakdown

### Phase 1: Preparation (30 min) ‚úÖ IN PROGRESS

**Tasks:**
- [x] Create iteration folder
- [x] Write 00_PLAN.md
- [ ] Define button callback data format
- [ ] Plan database schema changes

**Deliverables:**
- [x] This plan document
- [ ] Callback data spec
- [ ] DB migration plan

---

### Phase 2: File Generators (1 hour)

**Module:** `shared/telegram/file_generators.py`

**Functions:**
```python
def generate_anketa_txt(anketa: Anketa) -> str:
    """Generate readable anketa summary as text file"""
    pass

def generate_audit_txt(audit_result: AuditResult) -> str:
    """Generate audit results as text file"""
    pass

def generate_grant_txt(grant: Grant) -> str:
    """Generate full grant application as text file"""
    pass

def generate_review_txt(review: ReviewResult) -> str:
    """Generate review results as text file"""
    pass
```

**Tests:** `tests/unit/test_file_generators.py`
```python
def test_generate_anketa_txt():
    """Unit: anketa ‚Üí text format"""
    pass

def test_generate_audit_txt():
    """Unit: audit ‚Üí text format"""
    pass

# ... etc
```

**Acceptance Criteria:**
- ‚úÖ All 4 generators implemented
- ‚úÖ Unit tests pass
- ‚úÖ Text files are human-readable (not JSON dumps!)
- ‚úÖ Include metadata (ID, timestamp)

**Commit:** `feat(iteration-52): Add file generators for pipeline checkpoints`

---

### Phase 3: Telegram Bot - Anketa Handler (45 min)

**File:** `telegram-bot/handlers/anketa_handler.py`

**Changes:**
```python
async def on_anketa_complete(user_id: int, anketa_id: int):
    """Called when user finishes anketa"""

    # Generate file
    anketa = db.get_anketa(anketa_id)
    txt_content = generate_anketa_txt(anketa)

    # Save to temp file
    with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as f:
        f.write(txt_content)
        file_path = f.name

    # Send file
    await bot.send_document(
        chat_id=user_id,
        document=open(file_path, 'rb'),
        filename=f"anketa_{anketa_id}.txt",
        caption="‚úÖ –ê–Ω–∫–µ—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞!\n\n–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å –∞—É–¥–∏—Ç?"
    )

    # Send button
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("–ù–∞—á–∞—Ç—å –∞—É–¥–∏—Ç", callback_data=f"start_audit:{anketa_id}")]
    ])
    await bot.send_message(user_id, "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã:", reply_markup=keyboard)

    # Update state
    db.update_user_state(user_id, "ANKETA_COMPLETED")

    # Cleanup temp file
    os.unlink(file_path)
```

**Tests:** `tests/integration/test_anketa_handler.py`

**Acceptance Criteria:**
- ‚úÖ File sent as Telegram document
- ‚úÖ Button displayed
- ‚úÖ State updated in DB

**Commit:** `feat(iteration-52): Add anketa ‚Üí audit button with file checkpoint`

---

### Phase 4: Telegram Bot - Audit Handler (45 min)

**File:** `telegram-bot/handlers/audit_handler.py`

**Handler:**
```python
@dp.callback_query_handler(lambda c: c.data.startswith('start_audit:'))
async def handle_start_audit_button(callback_query: CallbackQuery):
    """Handle '–ù–∞—á–∞—Ç—å –∞—É–¥–∏—Ç' button click"""

    # Parse callback data
    anketa_id = int(callback_query.data.split(':')[1])
    user_id = callback_query.from_user.id

    # Check state
    state = db.get_user_state(user_id)
    if state != "ANKETA_COMPLETED":
        await callback_query.answer("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∏—Ç–µ –∞–Ω–∫–µ—Ç—É!")
        return

    # Acknowledge button click
    await callback_query.answer("–ó–∞–ø—É—Å–∫–∞–µ–º –∞—É–¥–∏—Ç...")

    # Run audit
    await bot.send_message(user_id, "‚è≥ –ó–∞–ø—É—Å–∫–∞—é –∞—É–¥–∏—Ç –∞–Ω–∫–µ—Ç—ã...")

    auditor = AuditorAgent(db=db)
    audit_result = await auditor.audit_anketa_async(anketa_id)

    # Generate file
    txt_content = generate_audit_txt(audit_result)

    # Send file
    with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as f:
        f.write(txt_content)
        file_path = f.name

    await bot.send_document(
        chat_id=user_id,
        document=open(file_path, 'rb'),
        filename=f"audit_{anketa_id}.txt",
        caption=f"‚úÖ –ê—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!\n\n–û—Ü–µ–Ω–∫–∞: {audit_result.score}/10"
    )

    # Send button
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("–ù–∞—á–∞—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –≥—Ä–∞–Ω—Ç–∞", callback_data=f"start_grant:{anketa_id}")]
    ])
    await bot.send_message(user_id, "–ì–æ—Ç–æ–≤—ã —Å–æ–∑–¥–∞—Ç—å –≥—Ä–∞–Ω—Ç?", reply_markup=keyboard)

    # Update state
    db.update_user_state(user_id, "AUDIT_COMPLETED")

    os.unlink(file_path)
```

**Tests:** `tests/integration/test_audit_handler.py`

**Acceptance Criteria:**
- ‚úÖ Button callback handled
- ‚úÖ Audit runs
- ‚úÖ File sent
- ‚úÖ Next button displayed

**Commit:** `feat(iteration-52): Add audit ‚Üí grant button handler`

---

### Phase 5: Telegram Bot - Grant Handler (45 min)

**File:** `telegram-bot/handlers/grant_handler.py`

**Handler:**
```python
@dp.callback_query_handler(lambda c: c.data.startswith('start_grant:'))
async def handle_start_grant_button(callback_query: CallbackQuery):
    """Handle '–ù–∞—á–∞—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –≥—Ä–∞–Ω—Ç–∞' button click"""

    anketa_id = int(callback_query.data.split(':')[1])
    user_id = callback_query.from_user.id

    # Check state
    state = db.get_user_state(user_id)
    if state != "AUDIT_COMPLETED":
        await callback_query.answer("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∏—Ç–µ –∞—É–¥–∏—Ç!")
        return

    await callback_query.answer("–ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≥—Ä–∞–Ω—Ç–∞...")

    # Run writer
    await bot.send_message(user_id, "‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –≥—Ä–∞–Ω—Ç–æ–≤—É—é –∑–∞—è–≤–∫—É... (—ç—Ç–æ –∑–∞–π–º–µ—Ç 2-3 –º–∏–Ω—É—Ç—ã)")

    writer = ProductionWriter(db=db)
    grant = await writer.generate_grant_async(anketa_id)

    # Generate file
    txt_content = generate_grant_txt(grant)

    # Send file
    with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as f:
        f.write(txt_content)
        file_path = f.name

    await bot.send_document(
        chat_id=user_id,
        document=open(file_path, 'rb'),
        filename=f"grant_{grant.id}.txt",
        caption=f"‚úÖ –ì—Ä–∞–Ω—Ç —Å–æ–∑–¥–∞–Ω!\n\n–†–∞–∑–º–µ—Ä: {len(grant.content)} —Å–∏–º–≤–æ–ª–æ–≤"
    )

    # Send button
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("–°–¥–µ–ª–∞—Ç—å —Ä–µ–≤—å—é", callback_data=f"start_review:{grant.id}")]
    ])
    await bot.send_message(user_id, "–•–æ—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ?", reply_markup=keyboard)

    # Update state
    db.update_user_state(user_id, "GRANT_COMPLETED")

    os.unlink(file_path)
```

**Tests:** `tests/integration/test_grant_handler.py`

**Acceptance Criteria:**
- ‚úÖ Grant generation works
- ‚úÖ File sent
- ‚úÖ Review button displayed

**Commit:** `feat(iteration-52): Add grant ‚Üí review button handler`

---

### Phase 6: Telegram Bot - Review Handler (45 min)

**File:** `telegram-bot/handlers/review_handler.py`

**Handler:**
```python
@dp.callback_query_handler(lambda c: c.data.startswith('start_review:'))
async def handle_start_review_button(callback_query: CallbackQuery):
    """Handle '–°–¥–µ–ª–∞—Ç—å —Ä–µ–≤—å—é' button click"""

    grant_id = int(callback_query.data.split(':')[1])
    user_id = callback_query.from_user.id

    # Check state
    state = db.get_user_state(user_id)
    if state != "GRANT_COMPLETED":
        await callback_query.answer("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –≥—Ä–∞–Ω—Ç!")
        return

    await callback_query.answer("–ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–≤—å—é...")

    # Run reviewer
    await bot.send_message(user_id, "‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∫–∞—á–µ—Å—Ç–≤–æ –≥—Ä–∞–Ω—Ç–∞...")

    reviewer = ReviewerAgent(db=db)
    review = await reviewer.review_grant_async(grant_id)

    # Generate file
    txt_content = generate_review_txt(review)

    # Send file
    with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as f:
        f.write(txt_content)
        file_path = f.name

    await bot.send_document(
        chat_id=user_id,
        document=open(file_path, 'rb'),
        filename=f"review_{grant_id}.txt",
        caption=f"‚úÖ –†–µ–≤—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ!\n\n–û—Ü–µ–Ω–∫–∞: {review.score}/10"
    )

    # Final message (no more buttons)
    await bot.send_message(
        user_id,
        "üéâ –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω!\n\n–í—Å–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –í—ã –º–æ–∂–µ—Ç–µ —Å–∫–∞—á–∞—Ç—å –∏—Ö –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞."
    )

    # Update state
    db.update_user_state(user_id, "PIPELINE_COMPLETE")

    os.unlink(file_path)
```

**Tests:** `tests/integration/test_review_handler.py`

**Acceptance Criteria:**
- ‚úÖ Review runs
- ‚úÖ File sent
- ‚úÖ Final message displayed
- ‚úÖ State = COMPLETE

**Commit:** `feat(iteration-52): Add grant ‚Üí review handler (final step)`

---

### Phase 7: State Machine (1 hour)

**Files:**
- `telegram-bot/state_machine.py` (update)
- Database migration

**States:**
```python
class PipelineState(Enum):
    IDLE = "idle"
    ANKETA_IN_PROGRESS = "anketa_in_progress"
    ANKETA_COMPLETED = "anketa_completed"
    AUDIT_COMPLETED = "audit_completed"
    GRANT_COMPLETED = "grant_completed"
    PIPELINE_COMPLETE = "pipeline_complete"
```

**Database:**
```sql
-- Migration: add user_pipeline_state column
ALTER TABLE users
ADD COLUMN pipeline_state VARCHAR(50) DEFAULT 'idle';

CREATE INDEX idx_users_pipeline_state ON users(pipeline_state);
```

**Functions:**
```python
def get_user_state(user_id: int) -> PipelineState:
    """Get current pipeline state for user"""
    pass

def update_user_state(user_id: int, new_state: PipelineState):
    """Update user's pipeline state"""
    pass

def can_transition(current: PipelineState, target: PipelineState) -> bool:
    """Validate state transition"""
    pass
```

**Tests:** `tests/unit/test_state_machine.py`

**Acceptance Criteria:**
- ‚úÖ States defined
- ‚úÖ DB migration applied
- ‚úÖ Transition validation works
- ‚úÖ Unit tests pass

**Commit:** `feat(iteration-52): Add state machine for interactive pipeline`

---

### Phase 8: Integration Tests (1 hour)

**File:** `tests/integration/test_interactive_pipeline.py`

**Tests:**
```python
@pytest.mark.integration
async def test_anketa_to_audit_flow(test_bot, test_db):
    """Integration: Anketa ‚Üí Audit button works"""

    # Complete anketa
    anketa = await complete_test_anketa(test_bot, user_id=123)

    # Check file sent
    messages = await test_bot.get_messages(123)
    last_doc = messages[-1].document
    assert "anketa" in last_doc.file_name

    # Check button
    last_msg = messages[-1]
    assert "–ù–∞—á–∞—Ç—å –∞—É–¥–∏—Ç" in str(last_msg.reply_markup)

    # Click button
    await test_bot.click_button(123, "start_audit")

    # Check audit ran
    messages = await test_bot.get_messages(123)
    last_doc = messages[-1].document
    assert "audit" in last_doc.file_name

@pytest.mark.integration
async def test_full_pipeline_integration(test_bot, test_db):
    """Integration: Full pipeline anketa ‚Üí audit ‚Üí grant ‚Üí review"""

    # Step 1: Anketa
    anketa = await complete_test_anketa(test_bot, user_id=123)
    await test_bot.click_button(123, "start_audit")

    # Step 2: Audit
    await asyncio.sleep(5)  # Wait for audit
    await test_bot.click_button(123, "start_grant")

    # Step 3: Grant
    await asyncio.sleep(60)  # Wait for grant (longer)
    await test_bot.click_button(123, "start_review")

    # Step 4: Review
    await asyncio.sleep(10)  # Wait for review

    # Check state
    state = test_db.get_user_state(123)
    assert state == "PIPELINE_COMPLETE"

    # Check all 4 files sent
    messages = await test_bot.get_messages(123)
    docs = [m.document for m in messages if m.document]
    assert len(docs) == 4
    assert any("anketa" in d.file_name for d in docs)
    assert any("audit" in d.file_name for d in docs)
    assert any("grant" in d.file_name for d in docs)
    assert any("review" in d.file_name for d in docs)
```

**Acceptance Criteria:**
- ‚úÖ All integration tests pass
- ‚úÖ Files sent correctly
- ‚úÖ Buttons work
- ‚úÖ State transitions validated

**Commit:** `test(iteration-52): Add integration tests for interactive pipeline`

---

### Phase 9: E2E Test (1 hour)

**File:** `tests/e2e/test_full_interactive_flow.py`

**Test:**
```python
@pytest.mark.e2e
@pytest.mark.slow
async def test_user_completes_full_pipeline_with_real_agents(
    real_bot,
    production_db,
    gigachat_client
):
    """E2E: Real user completing full pipeline with pauses"""

    user_id = 999999  # Test user

    # Phase 1: Complete anketa (real InterviewerAgent)
    from telegram_bot.handlers.anketa_handler import start_anketa_flow
    await start_anketa_flow(user_id)

    # Simulate user answering all questions
    test_answers = load_test_anketa_responses("high_quality")
    for question, answer in test_answers.items():
        await real_bot.send_message(user_id, answer)
        await asyncio.sleep(2)

    # Check: File + button received
    messages = await real_bot.get_chat_history(user_id, limit=5)
    assert any("anketa" in msg.document.file_name for msg in messages if msg.document)
    assert any("–ù–∞—á–∞—Ç—å –∞—É–¥–∏—Ç" in msg.text for msg in messages)

    # Phase 2: User clicks audit (REAL AuditorAgent)
    await real_bot.click_inline_button(user_id, "start_audit")
    await asyncio.sleep(30)  # Real audit takes time

    messages = await real_bot.get_chat_history(user_id, limit=5)
    assert any("audit" in msg.document.file_name for msg in messages if msg.document)

    # Phase 3: User clicks grant (REAL WriterAgent)
    await real_bot.click_inline_button(user_id, "start_grant")
    await asyncio.sleep(180)  # Real grant takes 2-3 minutes

    messages = await real_bot.get_chat_history(user_id, limit=5)
    assert any("grant" in msg.document.file_name for msg in messages if msg.document)

    # Phase 4: User clicks review (REAL ReviewerAgent)
    await real_bot.click_inline_button(user_id, "start_review")
    await asyncio.sleep(30)  # Real review takes time

    messages = await real_bot.get_chat_history(user_id, limit=5)
    assert any("review" in msg.document.file_name for msg in messages if msg.document)
    assert any("–∑–∞–≤–µ—Ä—à–µ–Ω" in msg.text.lower() for msg in messages)

    # Verify final state
    state = production_db.get_user_state(user_id)
    assert state == "PIPELINE_COMPLETE"

    print("‚úÖ E2E Test PASSED: Full interactive pipeline with real agents")
```

**Acceptance Criteria:**
- ‚úÖ E2E test passes with REAL agents (not mocks!)
- ‚úÖ All 4 files generated
- ‚úÖ All 3 buttons work
- ‚úÖ User can pause between steps

**Commit:** `test(iteration-52): Add E2E test for full interactive pipeline`

---

### Phase 10: Documentation (30 min)

**Files:**
- `iterations/Iteration_52_Interactive_Pipeline/SUCCESS.md`
- `iterations/Iteration_52_Interactive_Pipeline/FLOW_DIAGRAM.md`
- Update `CLAUDE.md` (current iteration = 52)

**Content:**
- Summary of changes
- User flow diagram
- Screenshots (if possible)
- Metrics collected
- Known issues
- Future improvements

**Commit:** `docs(iteration-52): Complete iteration documentation`

---

## üìä Success Metrics

| Metric | Target | How to Measure |
|--------|--------|----------------|
| **File delivery** | 100% | All 4 files sent in tests |
| **Button functionality** | 100% | All 3 buttons trigger next step |
| **State transitions** | 100% valid | No invalid state changes |
| **Test coverage** | 80%+ | pytest --cov |
| **E2E test pass** | ‚úÖ | Real agents complete full flow |
| **User feedback** | Positive | Manual testing with real users |

---

## üöÄ Deployment Plan

### Prerequisites
- ‚úÖ Iteration 51 complete
- ‚úÖ All tests pass
- ‚úÖ DB migration ready

### Steps
1. Apply DB migration (add `pipeline_state` column)
2. Deploy updated bot code
3. Test with internal user (manual)
4. Enable for 5% users (canary)
5. Monitor for 24 hours
6. Expand to 100% users

### Rollback Plan
- Keep old bot code as backup
- Can disable buttons with feature flag: `INTERACTIVE_PIPELINE_ENABLED=false`
- Revert to Iteration 51 if issues

---

## üêõ Risks & Mitigation

| Risk | Impact | Mitigation |
|------|--------|------------|
| Buttons don't work | HIGH | Thorough integration tests |
| Files too large | MEDIUM | Compress or limit content |
| User confusion | MEDIUM | Clear button labels + messages |
| State machine bugs | HIGH | Unit tests for all transitions |
| Telegram API rate limits | LOW | Add delays between messages |

---

## üìù Notes

- Use `.txt` files (not PDF) for simplicity
- Russian language only for now
- No "cancel" or "restart" flow (future iteration)
- No multi-user support yet (one pipeline per user)

---

## ‚úÖ Definition of Done

- [ ] All 11 todos completed (see todo list)
- [ ] All unit tests pass (file generators, state machine)
- [ ] All integration tests pass (bot handlers)
- [ ] E2E test passes (full pipeline with real agents)
- [ ] Code reviewed
- [ ] Documentation complete
- [ ] DB migration applied
- [ ] Deployed to staging
- [ ] Tested manually
- [ ] Git committed

---

**Owner:** Claude Code
**Reviewer:** TBD
**Status:** üöß IN PROGRESS

**When to mark complete:** After all tasks done + tests pass + deployed
