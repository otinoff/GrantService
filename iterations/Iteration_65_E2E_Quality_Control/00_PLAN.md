# Iteration 65: E2E Pipeline —Å –ö–æ–Ω—Ç—Ä–æ–ª–µ–º –ö–∞—á–µ—Å—Ç–≤–∞

**Date:** 2025-10-29 23:00 MSK
**Status:** üîß IN PROGRESS
**Priority:** üî• CRITICAL (–±—É—Ç–∫–µ–º–ø –°–±–µ—Ä–∞ - deadline 30 –æ–∫—Ç—è–±—Ä—è)
**Parent:** Iteration 64 - Full E2E Pipeline

---

## üéØ Goal

–ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å E2E pipeline —Å **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–∞—á–µ—Å—Ç–≤–∞** –∏ **–ø–æ–≤—Ç–æ—Ä–∞–º–∏ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ**.

**–ü—Ä–æ–±–ª–µ–º–∞ Iteration 64:**
- ‚úÖ 25 —Ñ–∞–π–ª–æ–≤ —Å–æ–∑–¥–∞–Ω—ã
- ‚ùå Grant —Ñ–∞–π–ª—ã –ø—É—Å—Ç—ã–µ (0 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
- ‚ùå –ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
- –ï—Å–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ –ø–ª–æ—Ö–æ–µ ‚Üí –ø–æ–≤—Ç–æ—Ä—è—Ç—å (max 3 –ø–æ–ø—ã—Ç–∫–∏)
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ

---

## üìä –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ö–∞—á–µ—Å—Ç–≤–∞

### Anketa (247+ —Å—Ç—Ä–æ–∫)
```python
- –ú–∏–Ω–∏–º—É–º 5000 —Å–∏–º–≤–æ–ª–æ–≤
- –í—Å–µ 6 –ø–æ–ª–µ–π –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
- –ù–µ—Ç "N/A" –∑–Ω–∞—á–µ–Ω–∏–π
- –ù–µ—Ç –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫
```

### Research (50+ —Å—Ç—Ä–æ–∫)
```python
- –ú–∏–Ω–∏–º—É–º 3 –∑–∞–ø—Ä–æ—Å–∞
- –í—Å–µ –æ—Ç–≤–µ—Ç—ã –∑–∞–ø–æ–ª–Ω–µ–Ω—ã (–Ω–µ—Ç N/A)
- –ú–∏–Ω–∏–º—É–º 3000 —Å–∏–º–≤–æ–ª–æ–≤
```

### Grant (200+ —Å—Ç—Ä–æ–∫) ‚Üê **–ì–õ–ê–í–ù–û–ï!**
```python
- –ú–∏–Ω–∏–º—É–º 15000 —Å–∏–º–≤–æ–ª–æ–≤
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
- –ù–µ—Ç TODO/INSERT –∑–∞–≥–ª—É—à–µ–∫
- –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≥—Ä–∞–Ω—Ç–∞
```

### Audit (25+ —Å—Ç—Ä–æ–∫)
```python
- –ú–∏–Ω–∏–º—É–º 500 —Å–∏–º–≤–æ–ª–æ–≤
- –û—Ü–µ–Ω–∫–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –µ—Å—Ç—å
```

### Review (18+ —Å—Ç—Ä–æ–∫)
```python
- –ú–∏–Ω–∏–º—É–º 400 —Å–∏–º–≤–æ–ª–æ–≤
- –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞
- –ó–∞–º–µ—á–∞–Ω–∏—è/—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
```

---

## üîß –ù–æ–≤–∞—è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –î–æ (Iteration 64):
```
step1() ‚Üí save ‚Üí export
step2() ‚Üí save ‚Üí export
step3() ‚Üí save ‚Üí export
step4() ‚Üí save ‚Üí export  ‚Üê –ü–£–°–¢–û–ô –ì–†–ê–ù–¢!
step5() ‚Üí save ‚Üí export
```

### –ü–æ—Å–ª–µ (Iteration 65):
```
step1() ‚Üí save ‚Üí export ‚Üí ‚úÖ CHECK ‚Üí –µ—Å–ª–∏ –ø–ª–æ—Ö–æ: RETRY (max 3)
step2() ‚Üí save ‚Üí export ‚Üí ‚úÖ CHECK ‚Üí –µ—Å–ª–∏ –ø–ª–æ—Ö–æ: RETRY
step3() ‚Üí save ‚Üí export ‚Üí ‚úÖ CHECK ‚Üí –µ—Å–ª–∏ –ø–ª–æ—Ö–æ: RETRY
step4() ‚Üí save ‚Üí export ‚Üí ‚úÖ CHECK ‚Üí –µ—Å–ª–∏ –ø–ª–æ—Ö–æ: RETRY ‚Üê FIX GRANT!
step5() ‚Üí save ‚Üí export ‚Üí ‚úÖ CHECK ‚Üí –µ—Å–ª–∏ –ø–ª–æ—Ö–æ: RETRY
```

---

## üìù Implementation Plan

### Phase 1: –î–æ–±–∞–≤–∏—Ç—å Quality Checkers (30 min)

**File:** `scripts/e2e_synthetic_workflow_v2.py`

```python
def check_anketa_quality(filepath: Path) -> tuple[bool, str]:
    content = filepath.read_text(encoding='utf-8')
    if len(content) < 5000:
        return False, "–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è –∞–Ω–∫–µ—Ç–∞"
    if content.count('N/A') > 2:
        return False, "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø—É—Å—Ç—ã—Ö –ø–æ–ª–µ–π"
    return True, "OK"

def check_grant_quality(filepath: Path) -> tuple[bool, str]:
    content = filepath.read_text(encoding='utf-8')
    if len(content) < 15000:
        return False, f"–ì—Ä–∞–Ω—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π: {len(content)} —Å–∏–º–≤–æ–ª–æ–≤"
    if 'TODO' in content:
        return False, "–ï—Å—Ç—å –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —á–∞—Å—Ç–∏"
    return True, "OK"
```

### Phase 2: –î–æ–±–∞–≤–∏—Ç—å Retry Logic (20 min)

```python
async def step4_writer_with_retry(self, anketa_data, research_data, max_retries=3):
    for attempt in range(max_retries):
        logger.info(f"üîÑ –ü–æ–ø—ã—Ç–∫–∞ {attempt+1}/{max_retries}")

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≥—Ä–∞–Ω—Ç
        grant_result = await self.step4_writer(anketa_data, research_data)
        filepath = Path(grant_result['filename'])

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ
        is_good, reason = check_grant_quality(filepath)

        if is_good:
            logger.info(f"‚úÖ –ì—Ä–∞–Ω—Ç –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π!")
            return grant_result
        else:
            logger.warning(f"‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ {attempt+1}: {reason}")
            if attempt < max_retries - 1:
                await asyncio.sleep(5)

    raise Exception(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≥—Ä–∞–Ω—Ç –∑–∞ {max_retries} –ø–æ–ø—ã—Ç–æ–∫")
```

### Phase 3: –û–±–Ω–æ–≤–∏—Ç—å run_full_cycle (10 min)

```python
async def run_full_cycle(self, index: int):
    # Step 1: Generate (—Å retry)
    anketa = await self.step1_generate_with_retry(index)

    # Step 2: Audit (—Å retry)
    audit = await self.step2_audit_with_retry(anketa['anketa_id'])

    # Step 3: Research (—Å retry)
    research = await self.step3_research_with_retry(anketa['anketa_id'])

    # Step 4: Writer (—Å retry) ‚Üê –í–ê–ñ–ù–û!
    grant = await self.step4_writer_with_retry(anketa, research)

    # Step 5: Review (—Å retry)
    review = await self.step5_review_with_retry(grant['grant_text'])

    return {'cycle': index+1, 'files': {...}}
```

### Phase 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (10 min)

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å 1 —Ü–∏–∫–ª–æ–º
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å 5 —Ü–∏–∫–ª–∞–º–∏
4. –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å 25 —Ñ–∞–π–ª–æ–≤

**Total Time:** 70 –º–∏–Ω—É—Ç

---

## ‚úÖ Success Criteria

- [ ] –í—Å–µ 5 checkers —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- [ ] Retry logic —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] 1 —Ç–µ—Å—Ç–æ–≤—ã–π —Ü–∏–∫–ª —É—Å–ø–µ—à–µ–Ω
- [ ] 5 —Ü–∏–∫–ª–æ–≤ = 25 –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- [ ] –í—Å–µ –≥—Ä–∞–Ω—Ç—ã > 15000 —Å–∏–º–≤–æ–ª–æ–≤
- [ ] –í—Å–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

---

## üîó Files

**New:**
- `scripts/e2e_synthetic_workflow_v2.py` (—Å quality control)

**Modified:**
- None (—Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª)

---

**Created:** 2025-10-29 23:00 MSK
**Target Completion:** 2025-10-29 24:10 MSK
**Deadline:** 2025-10-30 (–±—É—Ç–∫–µ–º–ø –°–±–µ—Ä–∞)
