# Iteration 70: Repair Agent - CONCEPT

**Date:** 2025-10-31
**Source:** User Feedback (Iteration 69 completion)
**Status:** Planning

---

## üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –¢–†–ï–ë–û–í–ê–ù–ò–ï –æ—Ç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –°–æ–æ–±—â–µ–Ω–∏–µ #1 (–ü–µ—Ä–≤–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è –ø–æ–Ω–∏–º–∞–Ω–∏—è)

> "Repair Agent –ù–ï –î–û–õ–ñ–ï–ù –õ–û–ú–ê–¢–¨ –∫–æ–¥ –∏ –ù–ï –î–û–õ–ñ–ï–ù –¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä—É—é—â–µ–≥–æ –∞–≥–µ–Ω—Ç–∞!
>
> –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö - —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ –ê–ì–ï–ù–¢–ê-–¢–ï–°–¢–ò–†–û–í–©–ò–ö–ê.
>
> –û–Ω –¥–æ–ª–∂–µ–Ω –í–û–ó–í–†–ê–©–ê–¢–¨–°–Ø –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç—Ç–∞–ø –∏ –°–ü–†–ê–®–ò–í–ê–¢–¨ –ø–æ—á–µ–º—É –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ,
> –∏ —Ç–∞–∫ –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ –¥–æ —Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ –∫–æ–≥–¥–∞ Interviewer —Å–∞–º —Å–µ–±–µ –º–æ–∂–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ."

### –°–æ–æ–±—â–µ–Ω–∏–µ #2 (–£—Ç–æ—á–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ - –ê–ö–¢–£–ê–õ–¨–ù–û–ï!)

> "–ù–µ —Å–æ–≤—Å–µ–º —Ç–∞–∫ –∏–ª–∏ –º—ã –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω–∏–º–∞—é –¥—Ä—É–≥ –¥—Ä—É–≥–∞. –°–º–æ—Ç—Ä–∏, –µ—Å—Ç—å –Ω–æ—á–Ω–æ–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä - —ç—Ç–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫,
> –æ–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–±–æ—Ç—É –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤ –∏ –ø–∏—à–µ—Ç –≥—Ä–∞–Ω—Ç—ã, –Ω–æ –≤–æ—Ç —É –Ω–µ–≥–æ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö,
> –∏ –æ–Ω —Ç–æ–≥–¥–∞ –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—Ç –∫–æ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫ –∏–ª–∏ –¥–µ–ª–∞–µ—Ç –º–æ–∫ –≤ –∫–æ–¥–µ –∏–ª–∏ –¥–µ–ª–∞–µ—Ç –±–µ–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö,
> –∏ —ç—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –∫–∞—Å–∫–∞–¥–Ω—É—é –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—é, –ø–æ—Ç–æ–º—É —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–∞–∂–Ω–∞ –¥–ª—è –≤—Å–µ–≥–æ –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ.
>
> –¢–æ –µ—Å—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤–æ–∑–Ω–∏–∫–∞—é—Ç, –∏ –Ω–µ–∫–æ–º—É —Ä–µ—à–∞—Ç—å.
>
> –ú—ã –≤–≤–æ–¥–∏–º Repair Agent –∫–æ—Ç–æ—Ä—ã–π –≤—ã—Å—Ç—É–ø–∞–µ—Ç –≤ —Ä–æ–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞-—Ä–µ–º–æ–Ω—Ç–Ω–∏–∫–∞.
> –ï–≥–æ —Ü–µ–ª—å –∏ –∑–∞–¥–∞—á–∞ - **–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤ —Ä–∞–±–æ—á–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∞–≥–µ–Ω—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫–∞**.
>
> –î–µ–ª–∞—Ç—å –≤–µ–± —Å–µ—Ä—á–∏ —á—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, –¥–µ–ª–∞—Ç—å –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º—É –Ω–∞—à–µ–º—É –∫–æ—Ä–ø—É—Å—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
> –ø–æ –≤–µ–∫—Ç–æ—Ä–Ω—ã–º –±–∞–∑–∞–º –¥–∞–Ω–Ω—ã–º, –Ω–æ **—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∏–∑–Ω–µ—Å –ª–æ–≥–∏–∫—É –∞–≥–µ–Ω—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫–∞**."

---

## üîß –ò—Å—Ç–∏–Ω–Ω–∞—è –†–æ–ª—å Repair Agent

**Repair Agent = Developer-Repairman (–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫-–†–µ–º–æ–Ω—Ç–Ω–∏–∫)**

### –ü—Ä–æ–±–ª–µ–º–∞

Night Orchestrator (—Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫) –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–æ—á—å—é –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤:
1. Interviewer ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∞–Ω–∫–µ—Ç—É
2. Auditor ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–Ω–∫–µ—Ç—É
3. Researcher ‚Üí –¥–µ–ª–∞–µ—Ç WebSearch
4. Writer ‚Üí –ø–∏—à–µ—Ç –≥—Ä–∞–Ω—Ç
5. Reviewer ‚Üí –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –≥—Ä–∞–Ω—Ç
6. Expert ‚Üí —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞

**–ù–û –≤–æ–∑–Ω–∏–∫–∞—é—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
- ‚ùå API GigaChat timeout
- ‚ùå WebSearch API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
- ‚ùå Qdrant –≤–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
- ‚ùå –°–µ—Ç–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
- ‚ùå –ù–µ—Ö–≤–∞—Ç–∫–∞ –ø–∞–º—è—Ç–∏
- ‚ùå –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞

**–ë–µ–∑ Repair Agent ‚Üí –∫–∞—Å–∫–∞–¥–Ω–∞—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è:**
```python
# ‚ùå Night Orchestrator –Ω–∞—á–∏–Ω–∞–µ—Ç –¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º —Å–µ–±—è:

if not db.connect():
    # –û—Ç–∫–ª—é—á–∞–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    use_database = False
    # ‚ö†Ô∏è –î–ï–ì–†–ê–î–ê–¶–ò–Ø #1!

if websearch_timeout:
    # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –º–æ–∫–∏
    use_mock_websearch = True
    # ‚ö†Ô∏è –î–ï–ì–†–ê–î–ê–¶–ò–Ø #2!

if gigachat_error:
    # –°–Ω–∏–∂–∞–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
    min_grant_length = 500  # –±—ã–ª–æ 15000
    # ‚ö†Ô∏è –î–ï–ì–†–ê–î–ê–¶–ò–Ø #3!

if qdrant_unavailable:
    # –û—Ç–∫–ª—é—á–∞–µ—Ç RAG
    skip_expert_evaluation = True
    # ‚ö†Ô∏è –î–ï–ì–†–ê–î–ê–¶–ò–Ø #4!
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞—Å–∫–∞–¥–Ω–æ–π –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏:**
- ‚úó –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç, –Ω–æ –ù–ï –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–µ–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- ‚úó –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —Ç–µ –∂–µ –ø—Ä–æ–±–ª–µ–º—ã ‚Üí –≤—Å–µ —Å–ª–æ–º–∞–µ—Ç—Å—è
- ‚úó –î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î
- ‚úó –ö–∞—á–µ—Å—Ç–≤–æ –≥—Ä–∞–Ω—Ç–æ–≤ –ø–∞–¥–∞–µ—Ç –¥–æ –Ω—É–ª—è
- ‚úó –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å–ª–æ–º–∞–Ω–∞

---

## ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–æ–¥—Ö–æ–¥: Repair Agent –∫–∞–∫ DevOps/SRE

### –ü—Ä–∏–Ω—Ü–∏–ø: –ß–∏–Ω–∏—Ç—å –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ü—Ä–æ–±–ª–µ–º—ã, –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ë–∏–∑–Ω–µ—Å-–õ–æ–≥–∏–∫—É

```python
class RepairAgent:
    """
    Repair Agent = Developer-Repairman

    –†–æ–ª—å: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å Night Orchestrator –≤ —Ä–∞–±–æ—á–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏

    –ù–ï –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
    –ù–ï –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –Ω–∞ –º–æ–∫–∏
    –ù–ï –æ—Ç–∫–ª—é—á–∞–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏

    –ß–ò–ù–ò–¢ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
    - –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    - –†–µ—Ç—Ä–∞–∏—Ç API –∑–∞–ø—Ä–æ—Å—ã
    - –ò—â–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    - –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã
    - –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
    """

    async def monitor_and_repair(self, orchestrator):
        """
        –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —Ä–µ–º–æ–Ω—Ç–∞

        1. –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–±–æ—Ç—É
        2. Repair Agent –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
        3. –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–µ ‚Üí –ß–ò–ù–ò–¢, –∞ –Ω–µ –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—Ç
        4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
        """
        while orchestrator.is_running:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
            health_status = await self._check_system_health()

            if not health_status['database']:
                # ‚úÖ –ß–ò–ù–ò–ú: –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º –ë–î
                await self._repair_database_connection()
                # ‚ùå –ù–ï –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ–º: use_database = False

            if not health_status['gigachat']:
                # ‚úÖ –ß–ò–ù–ò–ú: —Ä–µ—Ç—Ä–∞–π —Å exponential backoff
                await self._repair_gigachat_connection()
                # ‚ùå –ù–ï –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ–º: switch to mock

            if not health_status['websearch']:
                # ‚úÖ –ß–ò–ù–ò–ú: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
                await self._find_alternative_data_source()
                # ‚ùå –ù–ï –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ–º: skip research

            if not health_status['qdrant']:
                # ‚úÖ –ß–ò–ù–ò–ú: –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º Qdrant
                await self._repair_qdrant_connection()
                # ‚ùå –ù–ï –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ–º: skip RAG

            await asyncio.sleep(10)  # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥

    async def _repair_database_connection(self):
        """
        –ß–∏–Ω–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL

        –°—Ç—Ä–∞—Ç–µ–≥–∏—è:
        1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å .env —Ñ–∞–π–ª (–≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞ –º–µ—Å—Ç–µ?)
        2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ç—å (ping —Ö–æ—Å—Ç)
        3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PostgreSQL —Å–µ—Ä–≤–∏—Å (–∑–∞–ø—É—â–µ–Ω –ª–∏?)
        4. –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (3 –ø–æ–ø—ã—Ç–∫–∏ —Å backoff)
        5. –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏ —É–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∞

        –ù–ï –î–ï–õ–ê–¢–¨: use_database = False
        """
        logger.warning("‚ö†Ô∏è Database connection lost. Attempting repair...")

        # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º .env
        if not self._validate_env_vars():
            logger.error("‚ùå .env file invalid! Loading from backup...")
            self._restore_env_from_backup()

        # –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ç—å
        if not self._check_network_connectivity():
            logger.error("‚ùå Network unreachable! Waiting for reconnection...")
            await self._wait_for_network(timeout=60)

        # –®–∞–≥ 3: –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è (3 –ø–æ–ø—ã—Ç–∫–∏)
        for attempt in range(1, 4):
            try:
                logger.info(f"Reconnection attempt {attempt}/3...")
                db = GrantServiceDatabase()
                conn = db.connect()

                if conn:
                    logger.info("‚úÖ Database reconnected successfully!")
                    return True

            except Exception as e:
                logger.warning(f"Attempt {attempt} failed: {e}")
                await asyncio.sleep(5 * attempt)  # Exponential backoff

        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Üí –ù–ï –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ–º, –∞ —É–≤–µ–¥–æ–º–ª—è–µ–º
        logger.error("‚ùå Database repair failed after 3 attempts")
        await self._notify_admin("Database connection failed", urgency="HIGH")

        # ‚úÖ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç –≤–º–µ—Å—Ç–æ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏
        raise DatabaseUnavailableError(
            "Database unavailable and repair failed. "
            "Night test STOPPED to preserve business logic."
        )

    async def _repair_gigachat_connection(self):
        """
        –ß–∏–Ω–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ GigaChat API

        –°—Ç—Ä–∞—Ç–µ–≥–∏—è REPAIR-FIRST (–ù–ï —Ñ–æ–ª–±–µ–∫ —Å—Ä–∞–∑—É!):

        1. DIAGNOSE (–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã)
           - –ö–∞–∫–∞—è –∏–º–µ–Ω–Ω–æ –æ—à–∏–±–∫–∞? (timeout, quota, auth, network)
           - –ö–∞–∫–∞—è –º–æ–¥–µ–ª—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å? (Plus, Pro, Max)
           - –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π?

        2. REPAIR (–ø–æ–ø—ã—Ç–∫–∞ –ø–æ—á–∏–Ω–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å)
           - –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –µ—Å–ª–∏ –∏—Å—Ç—ë–∫
           - –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –º–æ–¥–µ–ª–∏ GigaChat (Plus ‚Üí Pro ‚Üí Max)
           - –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –∫–ª—é—á–∏ (–º–æ–∂–µ—Ç –æ–¥–∏–Ω –ª–∏–º–∏—Ç –∫–æ–Ω—á–∏–ª—Å—è, –¥—Ä—É–≥–æ–π –Ω–µ—Ç?)
           - Retry —Å exponential backoff

        3. FALLBACK (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–º–æ–Ω—Ç –Ω–µ —É–¥–∞–ª—Å—è!)
           - –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –í–°–ï –º–æ–¥–µ–ª–∏ GigaChat –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
           - –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –í–°–ï –∫–ª—é—á–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
           ‚Üí –¢–æ–≥–¥–∞ Claude Code (–ø–æ—Å–ª–µ–¥–Ω—è—è –º–µ—Ä–∞!)

        –ù–ï –î–ï–õ–ê–¢–¨: –°—Ä–∞–∑—É switch to Claude –±–µ–∑ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ—á–∏–Ω–∏—Ç—å GigaChat!
        """
        logger.warning("‚ö†Ô∏è GigaChat API error. Starting repair procedure...")

        # === PHASE 1: DIAGNOSE ===
        error_info = await self._diagnose_gigachat_error()
        logger.info(f"Diagnosis: {error_info['type']} - {error_info['message']}")

        # === PHASE 2: REPAIR (–ø–æ–ø—ã—Ç–∫–∞ –ø–æ—á–∏–Ω–∏—Ç—å GigaChat) ===

        # Repair Strategy #1: –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
        if error_info['type'] == 'auth_error' or self._is_token_expired():
            logger.info("üîß Repair #1: Refreshing GigaChat token...")
            try:
                await self._refresh_gigachat_token()
                if await self._test_gigachat_connection():
                    logger.info("‚úÖ GigaChat repaired: Token refreshed!")
                    return True
            except Exception as e:
                logger.warning(f"Token refresh failed: {e}")

        # Repair Strategy #2: –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –º–æ–¥–µ–ª–∏ GigaChat
        current_model = error_info.get('model', 'GigaChat-Max')
        alternative_models = ['GigaChat-Plus', 'GigaChat-Pro', 'GigaChat-Max']
        alternative_models.remove(current_model)  # –£–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â—É—é

        for model in alternative_models:
            logger.info(f"üîß Repair #2: Trying alternative GigaChat model: {model}")
            try:
                if await self._test_gigachat_with_model(model):
                    logger.info(f"‚úÖ GigaChat repaired: Switched to {model}!")
                    self._set_gigachat_model(model)
                    return True
            except Exception as e:
                logger.warning(f"Model {model} failed: {e}")

        # Repair Strategy #3: –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –∫–ª—é—á–∏
        if error_info['type'] == 'quota_exceeded':
            logger.info("üîß Repair #3: Trying alternative GigaChat keys...")
            alternative_keys = await self._get_alternative_gigachat_keys()

            for key in alternative_keys:
                logger.info(f"Trying key: {key[:20]}...")
                try:
                    if await self._test_gigachat_with_key(key):
                        logger.info("‚úÖ GigaChat repaired: Switched to alternative key!")
                        self._set_gigachat_key(key)
                        return True
                except Exception as e:
                    logger.warning(f"Key failed: {e}")

        # Repair Strategy #4: Retry —Å exponential backoff
        logger.info("üîß Repair #4: Retry with exponential backoff...")
        for attempt in range(1, 4):
            try:
                await asyncio.sleep(10 * attempt)  # Backoff
                if await self._test_gigachat_connection():
                    logger.info(f"‚úÖ GigaChat repaired: Reconnected on attempt {attempt}!")
                    return True
            except Exception as e:
                logger.warning(f"Retry {attempt}/3 failed: {e}")

        # === PHASE 3: FALLBACK (–ø–æ—Å–ª–µ–¥–Ω—è—è –º–µ—Ä–∞!) ===
        logger.error("‚ùå All GigaChat repair strategies failed!")
        logger.warning("‚ö†Ô∏è FALLBACK: Switching to Claude Code API (last resort)")

        # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞ –æ —Ñ–æ–ª–±–µ–∫–µ
        await self._notify_admin(
            "GigaChat completely unavailable. Switched to Claude Code.",
            urgency="HIGH"
        )

        # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ Claude
        self._switch_to_claude_provider()

        return True  # –§–æ–ª–±–µ–∫ —É—Å–ø–µ—à–µ–Ω

    async def _repair_websearch_connection(self):
        """
        –ß–∏–Ω–∏—Ç WebSearch API (Claude Code WebSearch)

        –°—Ç—Ä–∞—Ç–µ–≥–∏—è REPAIR-FIRST (–ù–ï —Ñ–æ–ª–±–µ–∫ —Å—Ä–∞–∑—É!):

        1. DIAGNOSE (–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã)
           - –ö–∞–∫–∞—è –æ—à–∏–±–∫–∞? (timeout, rate limit, auth, network)
           - –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ timeout?
           - –ö–∞–∫–æ–π –∑–∞–ø—Ä–æ—Å –≤—ã–∑–≤–∞–ª –ø—Ä–æ–±–ª–µ–º—É?

        2. REPAIR (–ø–æ–ø—ã—Ç–∫–∞ –ø–æ—á–∏–Ω–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å)
           - –ï—Å–ª–∏ timeout ‚Üí retry —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º timeout
           - –ï—Å–ª–∏ rate limit ‚Üí –ø–æ–¥–æ–∂–¥–∞—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
           - –ï—Å–ª–∏ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ç—å, –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
           - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å WebSearch —Å –ø—Ä–æ—Å—Ç—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
           - –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞

        3. FALLBACK (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–º–æ–Ω—Ç –Ω–µ —É–¥–∞–ª—Å—è!)
           - –¢–û–õ–¨–ö–û –µ—Å–ª–∏ WebSearch –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
           ‚Üí Perplexity API (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ #1)
           ‚Üí Qdrant RAG (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ #2)
           ‚Üí Cache (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ #3)

        –ù–ï –î–ï–õ–ê–¢–¨: –°—Ä–∞–∑—É switch to Perplexity –±–µ–∑ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ—á–∏–Ω–∏—Ç—å WebSearch!
        """
        logger.warning("‚ö†Ô∏è WebSearch API error. Starting repair procedure...")

        # === PHASE 1: DIAGNOSE ===
        error_info = await self._diagnose_websearch_error()
        logger.info(f"Diagnosis: {error_info['type']} - {error_info['message']}")

        # === PHASE 2: REPAIR (–ø–æ–ø—ã—Ç–∫–∞ –ø–æ—á–∏–Ω–∏—Ç—å WebSearch) ===

        # Repair Strategy #1: Retry —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º timeout
        if error_info['type'] == 'timeout':
            logger.info("üîß Repair #1: Retry with increased timeout...")
            original_timeout = error_info.get('timeout', 30)

            for timeout in [60, 90, 120]:
                logger.info(f"Trying timeout: {timeout}s...")
                try:
                    result = await self._test_websearch_with_timeout(timeout)
                    if result:
                        logger.info(f"‚úÖ WebSearch repaired: Timeout increased to {timeout}s!")
                        self._set_websearch_timeout(timeout)
                        return True
                except Exception as e:
                    logger.warning(f"Timeout {timeout}s failed: {e}")

        # Repair Strategy #2: Rate limit - –ø–æ–¥–æ–∂–¥–∞—Ç—å
        if error_info['type'] == 'rate_limit':
            logger.info("üîß Repair #2: Waiting for rate limit reset...")
            wait_time = error_info.get('retry_after', 60)
            logger.info(f"Waiting {wait_time}s...")
            await asyncio.sleep(wait_time)

            try:
                if await self._test_websearch_connection():
                    logger.info("‚úÖ WebSearch repaired: Rate limit reset!")
                    return True
            except Exception as e:
                logger.warning(f"Rate limit retry failed: {e}")

        # Repair Strategy #3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
        if error_info['type'] == 'network_error':
            logger.info("üîß Repair #3: Network check and retry...")
            if not await self._check_network_connectivity():
                logger.warning("Network unreachable. Waiting for reconnection...")
                await self._wait_for_network(timeout=60)

            # Retry –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ç–∏
            for attempt in range(1, 4):
                try:
                    await asyncio.sleep(5 * attempt)
                    if await self._test_websearch_connection():
                        logger.info(f"‚úÖ WebSearch repaired: Network restored, reconnected!")
                        return True
                except Exception as e:
                    logger.warning(f"Network retry {attempt}/3 failed: {e}")

        # Repair Strategy #4: –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏)
        logger.info("üîß Repair #4: Testing with simple query...")
        try:
            test_result = await self._test_websearch_simple()
            if test_result:
                logger.info("‚úÖ WebSearch repaired: Simple query successful!")
                return True
        except Exception as e:
            logger.warning(f"Simple query test failed: {e}")

        # === PHASE 3: FALLBACK (–ø–æ—Å–ª–µ–¥–Ω—è—è –º–µ—Ä–∞!) ===
        logger.error("‚ùå All WebSearch repair strategies failed!")
        logger.warning("‚ö†Ô∏è FALLBACK: Trying alternative data sources...")

        # Fallback #1: Perplexity API
        try:
            logger.info("FALLBACK #1: Trying Perplexity API...")
            perplexity_result = await perplexity_client.search(query)
            if perplexity_result:
                logger.info("‚úÖ Using Perplexity as fallback")
                await self._notify_admin(
                    "WebSearch unavailable. Using Perplexity.",
                    urgency="MEDIUM"
                )
                return perplexity_result
        except Exception as e:
            logger.warning(f"Perplexity failed: {e}")

        # Fallback #2: –õ–æ–∫–∞–ª—å–Ω—ã–π RAG (Qdrant)
        try:
            logger.info("FALLBACK #2: Trying local Qdrant RAG...")
            rag_result = await qdrant_client.search_similar(query)
            if rag_result:
                logger.info("‚úÖ Using Qdrant RAG as fallback")
                await self._notify_admin(
                    "WebSearch and Perplexity unavailable. Using Qdrant RAG.",
                    urgency="MEDIUM"
                )
                return rag_result
        except Exception as e:
            logger.warning(f"Qdrant failed: {e}")

        # Fallback #3: –ö—ç—à –ø—Ä–æ—à–ª—ã—Ö –ø–æ–∏—Å–∫–æ–≤
        cache_result = self._search_cache(query)
        if cache_result:
            logger.info("‚úÖ Using cached results as fallback")
            await self._notify_admin(
                "All data sources unavailable. Using cache.",
                urgency="HIGH"
            )
            return cache_result

        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–ª–æ ‚Üí —É–≤–µ–¥–æ–º–ª—è–µ–º –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
        logger.error("‚ùå All data sources failed (WebSearch, Perplexity, Qdrant, Cache)")
        await self._notify_admin(
            "All research data sources failed. Night test stopped.",
            urgency="CRITICAL"
        )

        raise WebSearchUnavailableError(
            "All data sources (WebSearch, Perplexity, Qdrant, Cache) failed"
        )

    def _check_system_health(self):
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

        Returns:
            {
                'database': bool,
                'gigachat': bool,
                'websearch': bool,
                'qdrant': bool,
                'disk_space': bool,
                'memory': bool
            }
        """
        return {
            'database': self._check_database(),
            'gigachat': self._check_gigachat(),
            'websearch': self._check_websearch(),
            'qdrant': self._check_qdrant(),
            'disk_space': self._check_disk_space(),
            'memory': self._check_memory()
        }

    async def _notify_admin(self, message: str, urgency: str = "MEDIUM"):
        """
        –£–≤–µ–¥–æ–º–ª—è–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ –ø—Ä–æ–±–ª–µ–º–µ

        –ö–∞–Ω–∞–ª—ã:
        - Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        - Email
        - –õ–æ–≥ —Ñ–∞–π–ª
        """
        logger.critical(f"[{urgency}] {message}")

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
        await telegram_bot.send_message(
            chat_id=ADMIN_CHAT_ID,
            text=f"üö® [{urgency}] {message}"
        )
```

---

## üîÑ –ü—Ä–∏–º–µ—Ä –†–∞–±–æ—Ç—ã: –ù–æ—á–Ω–æ–π –¢–µ—Å—Ç —Å Repair Agent

### –°—Ü–µ–Ω–∞—Ä–∏–π: Database Connection Lost

```
[23:00] Night Orchestrator –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
‚Üí Cycle 1/100

[23:01] Interviewer –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∞–Ω–∫–µ—Ç—É
‚Üí ‚úÖ –£—Å–ø–µ—à–Ω–æ

[23:02] Auditor –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–Ω–∫–µ—Ç—É
‚Üí ‚úÖ –£—Å–ø–µ—à–Ω–æ

[23:03] Researcher –Ω–∞—á–∏–Ω–∞–µ—Ç WebSearch
‚Üí ‚úÖ –£—Å–ø–µ—à–Ω–æ

[23:05] Writer –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥—Ä–∞–Ω—Ç –≤ –ë–î
‚Üí ‚ùå –û–®–ò–ë–ö–ê: Database connection lost!

[23:05] ‚ùå –ë–ï–ó Repair Agent:
    Night Orchestrator: "–õ–∞–¥–Ω–æ, –æ—Ç–∫–ª—é—á—É –ë–î –∏ –ø—Ä–æ–¥–æ–ª–∂—É"
    use_database = False  # ‚ö†Ô∏è –î–ï–ì–†–ê–î–ê–¶–ò–Ø!
    –¶–∏–∫–ª –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –±–µ–∑ –ë–î...
    ‚Üí –ì—Ä–∞–Ω—Ç—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
    ‚Üí –¢–µ—Å—Ç—ã "–ø—Ä–æ—Ö–æ–¥—è—Ç" –Ω–æ –¥–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä—è–Ω—ã

[23:05] ‚úÖ –° Repair Agent:
    Repair Agent –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É
    ‚Üí "Database connection lost. Attempting repair..."

    [23:05:10] –ü—Ä–æ–≤–µ—Ä—è–µ—Ç .env —Ñ–∞–π–ª ‚Üí ‚úÖ OK
    [23:05:15] –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–µ—Ç—å ‚Üí ‚úÖ OK
    [23:05:20] Reconnection attempt 1/3...
    [23:05:25] ‚úÖ Database reconnected!

    Writer –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –ø–æ–ø—ã—Ç–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    ‚Üí ‚úÖ –ì—Ä–∞–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –ë–î

    –¶–∏–∫–ª –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –ë–ï–ó –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏
    ‚Üí –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
    ‚Üí –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
```

### –°—Ü–µ–Ω–∞—Ä–∏–π: GigaChat Quota Exceeded (–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π Repair-First –ü–æ–¥—Ö–æ–¥)

```
[02:00] Night Orchestrator: Cycle 45/100

[02:15] Writer –≤—ã–∑—ã–≤–∞–µ—Ç GigaChat-Max –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥—Ä–∞–Ω—Ç–∞
‚Üí ‚ùå –û–®–ò–ë–ö–ê: Quota exceeded (429)

[02:15] ‚ùå –ë–ï–ó Repair Agent:
    Night Orchestrator: "–õ–∞–¥–Ω–æ, —Å–Ω–∏–∂—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è"
    min_grant_length = 500  # –±—ã–ª–æ 15000
    review_score_threshold = 0  # –±—ã–ª–æ 7.0
    ‚Üí ‚ö†Ô∏è –î–ï–ì–†–ê–î–ê–¶–ò–Ø –∫–∞—á–µ—Å—Ç–≤–∞!

[02:15] ‚úÖ –° Repair Agent (DIAGNOSE ‚Üí REPAIR ‚Üí FALLBACK):

    === PHASE 1: DIAGNOSE ===
    [02:15:05] Repair Agent –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É
    ‚Üí Diagnosis: quota_exceeded on GigaChat-Max
    ‚Üí Current model: GigaChat-Max

    === PHASE 2: REPAIR (–ø–æ–ø—ã—Ç–∫–∞ –ø–æ—á–∏–Ω–∏—Ç—å GigaChat) ===
    [02:15:10] üîß Repair #1: Refreshing token...
    ‚Üí Token still valid, not the issue

    [02:15:15] üîß Repair #2: Trying alternative GigaChat models...
    ‚Üí Trying GigaChat-Plus... ‚úÖ Success!
    ‚Üí GigaChat-Plus has quota available!

    [02:15:20] Writer –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≥—Ä–∞–Ω—Ç —á–µ—Ä–µ–∑ GigaChat-Plus
    ‚Üí ‚úÖ –ì—Ä–∞–Ω—Ç 18,500 —Å–∏–º–≤–æ–ª–æ–≤ (–∫–∞—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!)
    ‚Üí ‚úÖ GigaChat –ü–û–ß–ò–ù–ï–ù –±–µ–∑ —Ñ–æ–ª–±–µ–∫–∞ –Ω–∞ Claude!

    –¶–∏–∫–ª –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è —Å –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ú —Å–µ—Ä–≤–∏—Å–æ–º
    ‚Üí GigaChat —Ä–∞–±–æ—Ç–∞–µ—Ç (–¥—Ä—É–≥–∞—è –º–æ–¥–µ–ª—å)
    ‚Üí –ö–∞—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
    ‚Üí –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
    ‚Üí Claude –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è (—Ñ–æ–ª–±–µ–∫ –Ω–µ –ø–æ–Ω–∞–¥–æ–±–∏–ª—Å—è!)

[02:15:30] Repair Agent –ª–æ–≥–∏—Ä—É–µ—Ç:
    "Repair successful: GigaChat-Max quota exceeded,
     switched to GigaChat-Plus (alternative model)."
```

### –°—Ü–µ–Ω–∞—Ä–∏–π: WebSearch Timeout (–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π Repair-First –ü–æ–¥—Ö–æ–¥)

```
[03:30] Night Orchestrator: Cycle 67/100

[03:35] Researcher –≤—ã–∑—ã–≤–∞–µ—Ç WebSearch API
‚Üí ‚ùå –û–®–ò–ë–ö–ê: Request timeout after 30s

[03:35] ‚ùå –ë–ï–ó Repair Agent:
    Night Orchestrator: "–õ–∞–¥–Ω–æ, –ø–µ—Ä–µ–∫–ª—é—á—É—Å—å –Ω–∞ Perplexity"
    use_perplexity = True
    ‚Üí ‚ö†Ô∏è –°—Ä–∞–∑—É —Ñ–æ–ª–±–µ–∫ –±–µ–∑ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ—á–∏–Ω–∏—Ç—å!

[03:35] ‚úÖ –° Repair Agent (DIAGNOSE ‚Üí REPAIR ‚Üí FALLBACK):

    === PHASE 1: DIAGNOSE ===
    [03:35:05] Repair Agent –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É
    ‚Üí Diagnosis: timeout (30s) on complex query
    ‚Üí Query length: 250 chars (long query)

    === PHASE 2: REPAIR (–ø–æ–ø—ã—Ç–∫–∞ –ø–æ—á–∏–Ω–∏—Ç—å WebSearch) ===
    [03:35:10] üîß Repair #1: Retry with increased timeout...
    ‚Üí Trying 60s timeout... ‚ùå Still timeout
    ‚Üí Trying 90s timeout... ‚úÖ Success!
    ‚Üí WebSearch responded in 75 seconds

    [03:35:95] ‚úÖ WebSearch –ü–û–ß–ò–ù–ï–ù!
    ‚Üí Timeout —É–≤–µ–ª–∏—á–µ–Ω —Å 30s –¥–æ 90s
    ‚Üí WebSearch —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –¥–ª–∏–Ω–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏

    [03:36:00] Researcher –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã WebSearch
    ‚Üí ‚úÖ 5 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –Ω–∞–π–¥–µ–Ω–æ
    ‚Üí ‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
    ‚Üí Perplexity –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è (—Ñ–æ–ª–±–µ–∫ –Ω–µ –ø–æ–Ω–∞–¥–æ–±–∏–ª—Å—è!)

    –¶–∏–∫–ª –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è —Å –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ú —Å–µ—Ä–≤–∏—Å–æ–º
    ‚Üí WebSearch —Ä–∞–±–æ—Ç–∞–µ—Ç (—Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º timeout)
    ‚Üí –ö–∞—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
    ‚Üí –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

[03:36:10] Repair Agent –ª–æ–≥–∏—Ä—É–µ—Ç:
    "Repair successful: WebSearch timeout fixed,
     increased timeout from 30s to 90s."
```

### –°—Ü–µ–Ω–∞—Ä–∏–π: –§–æ–ª–±–µ–∫ –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ —Ä–µ–º–æ–Ω—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω

```
[04:45] Night Orchestrator: Cycle 89/100

[04:50] Writer –≤—ã–∑—ã–≤–∞–µ—Ç GigaChat –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥—Ä–∞–Ω—Ç–∞
‚Üí ‚ùå –û–®–ò–ë–ö–ê: All GigaChat models unavailable

[04:50] ‚úÖ –° Repair Agent (–≤—Å–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–µ–º–æ–Ω—Ç–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å):

    === PHASE 1: DIAGNOSE ===
    [04:50:05] Diagnosis: All models return 503 Service Unavailable
    ‚Üí GigaChat —Å–µ—Ä–≤–∏—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

    === PHASE 2: REPAIR (–≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏) ===
    [04:50:10] üîß Repair #1: Refresh token... ‚ùå Failed
    [04:50:20] üîß Repair #2: Try GigaChat-Plus... ‚ùå Unavailable
    [04:50:30] üîß Repair #2: Try GigaChat-Pro... ‚ùå Unavailable
    [04:50:40] üîß Repair #2: Try GigaChat-Max... ‚ùå Unavailable
    [04:50:50] üîß Repair #3: Try alternative keys... ‚ùå All keys fail
    [04:51:00] üîß Repair #4: Retry with backoff... ‚ùå Still unavailable

    [04:51:10] ‚ùå All GigaChat repair strategies failed!

    === PHASE 3: FALLBACK (–ø–æ—Å–ª–µ–¥–Ω—è—è –º–µ—Ä–∞!) ===
    [04:51:15] ‚ö†Ô∏è FALLBACK: Switching to Claude Code API
    ‚Üí Claude Code –ø—Ä–æ–≤–µ—Ä–µ–Ω ‚Üí ‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω
    ‚Üí –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ Claude (–ü–û–°–õ–ï–î–ù–Ø–Ø –ú–ï–†–ê!)

    [04:51:20] üö® –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É (Telegram):
    "GigaChat completely unavailable (all models, all keys).
     Switched to Claude Code. Please check GigaChat status."

    [04:51:30] Writer –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≥—Ä–∞–Ω—Ç —á–µ—Ä–µ–∑ Claude Code
    ‚Üí ‚úÖ –ì—Ä–∞–Ω—Ç 19,200 —Å–∏–º–≤–æ–ª–æ–≤
    ‚Üí –ö–∞—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ (—Ä–µ–∞–ª—å–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞!)

    –¶–∏–∫–ª –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è —Å –§–û–õ–ë–ï–ö–û–ú
    ‚Üí –§–æ–ª–±–µ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ —Ä–µ–º–æ–Ω—Ç–∞
    ‚Üí –ö–∞—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
    ‚Üí –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

[04:51:40] Repair Agent –ª–æ–≥–∏—Ä—É–µ—Ç:
    "Fallback activated: GigaChat unrepairable (all strategies failed),
     using Claude Code as last resort."
```

---

## üìä Monitoring & Reporting

### Health Check Dashboard

Repair Agent –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç health check –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥:

```json
{
  "timestamp": "2025-10-31T03:45:00Z",
  "cycle": "67/100",
  "health": {
    "database": {
      "status": "healthy",
      "latency_ms": 12,
      "last_check": "2025-10-31T03:44:50Z"
    },
    "gigachat": {
      "status": "quota_warning",
      "tokens_remaining": 1500,
      "last_check": "2025-10-31T03:44:55Z"
    },
    "websearch": {
      "status": "healthy",
      "rate_limit_remaining": 85,
      "last_check": "2025-10-31T03:44:52Z"
    },
    "qdrant": {
      "status": "healthy",
      "collections": 3,
      "last_check": "2025-10-31T03:44:48Z"
    }
  },
  "repairs_performed": [
    {
      "timestamp": "2025-10-31T02:15:10Z",
      "issue": "gigachat_quota_exceeded",
      "action": "switched_to_claude",
      "success": true
    },
    {
      "timestamp": "2025-10-31T01:23:05Z",
      "issue": "database_connection_lost",
      "action": "reconnected",
      "success": true,
      "attempts": 2
    }
  ]
}
```

### Morning Report Section

```markdown
# REPAIR AGENT REPORT

## Night Run: 2025-10-31 (100 cycles)

### System Health
- Database: ‚úÖ Healthy (1 repair performed)
- GigaChat: ‚ö†Ô∏è Quota Warning (switched to Claude at cycle 45)
- WebSearch: ‚úÖ Healthy
- Qdrant: ‚úÖ Healthy

### Repairs Performed: 3 total

1. **Database Connection Lost** (Cycle 23)
   - Time: 23:05:20
   - Action: Reconnected after 2 attempts
   - Duration: 15 seconds
   - Result: ‚úÖ Success

2. **GigaChat Quota Exceeded** (Cycle 45)
   - Time: 02:15:10
   - Action: Switched to Claude Code API
   - Duration: 10 seconds
   - Result: ‚úÖ Success

3. **WebSearch Timeout** (Cycle 78)
   - Time: 05:23:45
   - Action: Used Qdrant RAG as alternative
   - Duration: 8 seconds
   - Result: ‚úÖ Success

### Degradation Prevented: 3 instances
- ‚úÖ Database NOT disabled (would break data persistence)
- ‚úÖ Quality thresholds NOT lowered (would break validation)
- ‚úÖ Business logic NOT modified (would break production parity)

### Recommendations:
- ‚ö†Ô∏è GigaChat quota reached at 45% completion. Consider increasing quota.
- ‚ÑπÔ∏è Database had brief connection issue. Check network stability.
- ‚úÖ All repairs successful. No manual intervention needed.
```

---

## üéØ –ü–ª–∞–Ω –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (Iteration 70)

### Phase 1: Core Repair Agent
- [ ] Create `tester/repair_agent.py`
- [ ] Implement `RepairAgent` class
- [ ] Implement `monitor_and_repair()` loop
- [ ] Implement `_check_system_health()`

### Phase 2: Repair Strategies
- [ ] Implement `_repair_database_connection()`
- [ ] Implement `_repair_gigachat_connection()`
- [ ] Implement `_find_alternative_data_source()`
- [ ] Implement `_repair_qdrant_connection()`

### Phase 3: Monitoring & Alerts
- [ ] Implement health check system
- [ ] Implement admin notifications (Telegram)
- [ ] Implement repair logging
- [ ] Add health metrics to morning report

### Phase 4: Integration
- [ ] Integrate RepairAgent into `night_orchestrator.py`
- [ ] Run RepairAgent as parallel monitoring task
- [ ] Test with simulated failures
- [ ] Verify no degradation occurs

### Phase 5: Testing
- [ ] Test database connection failure
- [ ] Test API quota exceeded
- [ ] Test network timeout
- [ ] Test disk space full
- [ ] Run 100 cycles with random failures

---

## üìù Key Requirements

**MUST:**
- –ß–∏–Ω–∏—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∞–≥–µ–Ω—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –†–ï–ê–õ–¨–ù–´–ï –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã (–Ω–µ –º–æ–∫–∏)
- –£–≤–µ–¥–æ–º–ª—è—Ç—å –∞–¥–º–∏–Ω–∞ –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ä–µ–º–æ–Ω—Ç—ã

**MUST NOT:**
- –î–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫–∞
- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –Ω–∞ –º–æ–∫–∏
- –û—Ç–∫–ª—é—á–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –°–Ω–∏–∂–∞—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫–∞—á–µ—Å—Ç–≤—É
- –õ–æ–º–∞—Ç—å –ø—Ä–æ–¥–∞–∫—à–µ–Ω-–∫–æ–¥

**–ö–†–ò–¢–ò–ß–ù–û:**
–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–∞–∂–Ω–∞ –¥–ª—è –≤—Å–µ–≥–æ! –ï—Å–ª–∏ –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Üí —á–∏–Ω–∏—Ç—å, –∞ –Ω–µ –æ—Ç–∫–ª—é—á–∞—Ç—å.

---

**Created:** 2025-10-31
**Updated:** 2025-10-31 (–ø–æ—Å–ª–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏)
**Based on:** User feedback during Iteration 69 completion
**Status:** Ready for implementation
