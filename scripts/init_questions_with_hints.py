#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Скрипт для инициализации вопросов интервью с подсказками
"""

import sqlite3
import json

def init_questions_with_hints(use_system_db=False):
    """Инициализация вопросов с подсказками"""
    import pathlib
    
    if use_system_db:
        # Используем системную БД (для продакшена)
        db_path = "/var/GrantService/data/grantservice.db"
    else:
        # Используем локальную БД в папке проекта (для разработки)
        current_dir = pathlib.Path(__file__).parent.parent
        db_path = str(current_dir / "data" / "grantservice.db")
        
        # Если локальной БД нет, используем системную
        if not pathlib.Path(db_path).exists():
            db_path = "/var/GrantService/data/grantservice.db"
    
    print(f"Используется база данных: {db_path}")
    
    # Полный список вопросов с подсказками
    questions = [
        (1, 'Как называется ваш проект в 3-7 словах?', 'project_name', 'text', 
         'Пример: Мобильная библиотека для людей с ОВЗ', 1),
        (2, 'Кратко опишите суть проекта (что хотите сделать)', 'project_description', 'textarea',
         'Пример: создадим выездную библиотеку и аудиокниги, чтобы жители сел Новокузнецкого района с ограничениями в здоровье могли бесплатно получить литературу на дом, образовываться и устраиваться на работу', 1),
        (3, 'В каком городе, регионе вы хотите реализовать проект?', 'project_location', 'text',
         'Пример: Кемеровская область, новокузнецкий район, пгт…', 1),
        (4, 'Опишите, какую проблему решает ваш проект и почему он важен?', 'problem_solution', 'textarea',
         'Пример: Сельские жители с ОВЗ Новокузнецкого района не имеют доступа к библиотекам, из-за этого страдает культура и развитие, что приводит к пьянству и невозможности устроиться на работу (по отчету минкультуры 2024)', 1),
        (5, 'Кто будет основной целевой группой вашего проекта? (участники вашего проекта)', 'target_audience', 'textarea',
         'Пример: Охватим 300 взрослых людей с ОВЗ, проживающих по 3 поселкам Новокузнецкого района', 1),
        (6, 'Какова главная цель проекта?', 'main_goal', 'textarea',
         'Пример: Повысить доступность чтения для людей с ОВЗ в сельской местности', 1),
        (7, 'Перечислите конкретные задачи, которые нужно будет решить, чтобы запустить проект?', 'project_tasks', 'textarea',
         'Пример: 1. Оснастить автобус книжным фондом на 1000 экземпляров 2. Провести информационную компанию, чтобы оповестить людей 3.Провести 20 выездных библиотечных сессий с целевой аудиторией', 1),
        (8, 'Сколько времени потребуется на реализацию (когда собираетесь начать и закончить проект?)', 'project_timeline', 'text',
         'Пример: 01.06.2028-31.12.28 (6 месяцев)', 1),
        (9, 'Что может помешать реализации вашего проекта?', 'potential_obstacles', 'textarea',
         'Пример: Часть людей может заболеть и не прийти, но мы сделаем запасные даты встреч, чтобы охватить всю целевую аудиторию', 1),
        (10, 'Опишите, кто будет в команде проекта, какой у них опыт и компетенции, что они будут делать в этом проекте?', 'team_competencies', 'textarea',
         'Пример: Руководитель проекта -Марья Ивановна, директор, НКО, 7 лет работает в доме культуры. Библиотекарь, специалист по рекламе, водитель.', 1),
        (11, 'Есть ли добровольцы или волонтеры? Есть ли организации, готовые поддержать ваш проект?', 'volunteers_partners', 'textarea',
         'Пример: Администрация Новокузнецкого района, Дом культуры Села …., Добровольческий фонд "Надежда"', 0),
        (12, 'Есть ли у вас АНО? Если да, когда зарегистрировали? Соответствует ли проект уставным видам деятельности?', 'organization_info', 'textarea',
         'Пример, да, АНО "Читай-село", ОГРН ….,дата регистрации 15.06.2021, да, п.2.3 устава "Культурно-просветительская деятельность"', 1),
        (13, 'Есть ли у вас сайт, соц сети? Напишите ссылки', 'online_presence', 'textarea',
         'Укажите ссылки на сайт, социальные сети, если есть', 0),
        (14, 'Получали ли вы раньше гранты? Если да, укажите год, фонд, результат.', 'previous_grants', 'textarea',
         'Пример: да, ФПГ, 2023, 450 000, отчет 100% сдан', 0),
        (15, 'Какая материально-техническая база есть для осуществления проектом?', 'existing_resources', 'textarea',
         'Пример: Есть автобус, есть часть книг для использования в проекте', 1),
        (16, 'Какие ключевые мероприятия запланированы?', 'key_events', 'textarea',
         'Пример: Июнь-подготовка автобуса, июль -закуп книг, август -проведение информационной компании для оповещения жителей, сентябрь -декабрь 20 выездов', 1),
        (17, 'Какие измеримые результаты будут у каждого мероприятия?', 'measurable_results', 'textarea',
         'Пример: Подготовка автобуса - свидетельство ТО, Информационная компания - роздано 300 листовок, оповещено 300 человек, каждый выезд: охват не менее 15 человек.', 1),
        (18, 'Кто отвечает за каждое мероприятие?', 'event_responsibility', 'textarea',
         'Пример: Петров - везет автобус на ТО, МарьИвана - и рекламный специалист делают делают листовки и с помощью волонтеров раздают жителям, библиотекарь -подбирает книги…', 1),
        (19, 'Сколько денег нужно на осуществление проекта? Напишите приблизительную цифру', 'budget_amount', 'number',
         'Пример: 1200000', 1),
        (20, 'Сколько собственных средств и ресурсов вы вкладываете сами в проект?', 'own_contribution', 'number',
         'Пример: 150000', 1),
        (21, 'На какие основные статьи пойдут грантовые деньги, обоснование статьи?', 'budget_breakdown', 'textarea',
         'Пример: Тех.обслуживание автобуса -50000, книги 400000 (средняя цена за книгу 500 р), топливо 100000 (60 р/литр), зарплата команды 200000, реклама (печать листовок) -50000 …..', 1),
        (22, 'Готовы ли вы при необходимости снизить бюджет? Если дадут сумму частично?', 'budget_flexibility', 'textarea',
         'Пример, да, сократим рекламные расходы, купим книги подешевле', 1),
        (23, 'Как будете измерять эффективность проекта?', 'effectiveness_measurement', 'textarea',
         'Пример: Сделаем анкеты удовлетворенности после каждого выезда, реестр с подсчетом выданных книг и подписью, кому выдали, общее фото с мероприятий, сделаем опрос на сайте', 1),
        (24, 'Что станет с инициативой после окончания гранта?', 'post_grant_plans', 'textarea',
         'Пример: После окончания автобус интегрируем в районную библиотечную сеть, финансирование через муниципальный бюджет, если проект понравится, будем проводить его в других селах нашего района', 1)
    ]
    
    try:
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        print("Инициализация вопросов с подсказками...")
        
        # Очищаем существующие вопросы
        cursor.execute("DELETE FROM interview_questions")
        print("  Существующие вопросы удалены")
        
        # Добавляем новые вопросы с подсказками
        for q in questions:
            question_number, question_text, field_name, question_type, hint_text, is_required = q
            
            cursor.execute("""
                INSERT INTO interview_questions 
                (question_number, question_text, field_name, question_type, hint_text, is_required, is_active)
                VALUES (?, ?, ?, ?, ?, ?, 1)
            """, (question_number, question_text, field_name, question_type, hint_text, is_required))
            
            print(f"  Вопрос {question_number}: добавлен")
        
        conn.commit()
        print("\nВсе вопросы успешно добавлены!")
        
        # Проверяем результат
        cursor.execute("""
            SELECT question_number, 
                   CASE WHEN hint_text IS NOT NULL AND hint_text != '' THEN 'Есть подсказка' ELSE 'Нет подсказки' END as hint_status
            FROM interview_questions 
            ORDER BY question_number
        """)
        
        print("\nПроверка вопросов:")
        for row in cursor.fetchall():
            print(f"  Вопрос {row[0]}: {row[1]}")
        
        # Общая статистика
        cursor.execute("SELECT COUNT(*) FROM interview_questions WHERE hint_text IS NOT NULL AND hint_text != ''")
        hints_count = cursor.fetchone()[0]
        
        cursor.execute("SELECT COUNT(*) FROM interview_questions")
        total_count = cursor.fetchone()[0]
        
        print(f"\nИтого: {total_count} вопросов, из них {hints_count} с подсказками")
        
        conn.close()
        
    except Exception as e:
        print(f"Ошибка: {e}")

if __name__ == "__main__":
    import sys
    # Если передан аргумент --system, используем системную БД
    use_system = '--system' in sys.argv
    init_questions_with_hints(use_system_db=use_system)